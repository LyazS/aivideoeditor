# æ—§æ¶æ„é¡¹ç›®ä¿å­˜æµç¨‹æ•´ç†

## 1. æ•´ä½“æ¶æ„åˆ†æ

æ—§æ¶æ„çš„é¡¹ç›®ä¿å­˜æµç¨‹é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š

- **ç”¨æˆ·ç•Œé¢å±‚**ï¼šé€šè¿‡ [`VideoEditor.vue`](frontend/src/views/VideoEditor.vue:43) å’Œ [`EditProjectDialog.vue`](frontend/src/components/EditProjectDialog.vue:40) æä¾›ä¿å­˜æ“ä½œçš„è§¦å‘ç‚¹
- **çŠ¶æ€ç®¡ç†å±‚**ï¼šé€šè¿‡ [`videoStore.ts`](frontend/src/stores/videoStore.ts:1570) ç»Ÿä¸€ç®¡ç†åº”ç”¨çŠ¶æ€ï¼ŒåŒ…æ‹¬é¡¹ç›®ä¿å­˜çŠ¶æ€
- **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šé€šè¿‡ [`projectModule.ts`](frontend/src/stores/modules/projectModule.ts:155) å¤„ç†é¡¹ç›®ä¿å­˜çš„ä¸šåŠ¡é€»è¾‘
- **æ•°æ®æŒä¹…åŒ–å±‚**ï¼šé€šè¿‡ [`ProjectManager.ts`](frontend/src/utils/ProjectManager.ts:475) å’Œ [`MediaManager.ts`](frontend/src/utils/MediaManager.ts) è´Ÿè´£å®é™…çš„æ•°æ®ä¿å­˜æ“ä½œ

## 2. æ ¸å¿ƒç»„ä»¶å’Œä½œç”¨

### 2.1 çŠ¶æ€ç®¡ç†å±‚ - videoStore

[`videoStore.ts`](frontend/src/stores/videoStore.ts:1570) æ˜¯æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€ç®¡ç†ä¸­å¿ƒï¼Œè´Ÿè´£ï¼š

- **çŠ¶æ€èšåˆ**ï¼šæ•´åˆäº†å¤šä¸ªæ¨¡å—çš„çŠ¶æ€ï¼ˆåª’ä½“ã€è½¨é“ã€æ—¶é—´è½´ã€æ’­æ”¾ã€é…ç½®ç­‰ï¼‰
- **æ¥å£ç»Ÿä¸€**ï¼šæä¾›ç»Ÿä¸€çš„é¡¹ç›®ä¿å­˜æ¥å£ [`saveCurrentProject`](frontend/src/stores/videoStore.ts:1570)
- **çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†é¡¹ç›®ä¿å­˜çŠ¶æ€ [`isSaving`](frontend/src/stores/videoStore.ts:1554)ã€é¡¹ç›®ä¿¡æ¯ [`currentProject`](frontend/src/stores/videoStore.ts:1549) ç­‰

### 2.2 ä¸šåŠ¡é€»è¾‘å±‚ - projectModule

[`projectModule.ts`](frontend/src/stores/modules/projectModule.ts:155) æ˜¯é¡¹ç›®ç®¡ç†çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£ï¼š

- **é¡¹ç›®çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†å½“å‰é¡¹ç›®é…ç½® [`currentProject`](frontend/src/stores/modules/projectModule.ts:13)ã€ä¿å­˜çŠ¶æ€ [`isSaving`](frontend/src/stores/modules/projectModule.ts:16) ç­‰
- **åª’ä½“å¼•ç”¨ç®¡ç†**ï¼šç»´æŠ¤åª’ä½“æ–‡ä»¶å¼•ç”¨æ˜ å°„ [`mediaReferences`](frontend/src/stores/modules/projectModule.ts:34)
- **ä¿å­˜é€»è¾‘**ï¼šå®ç° [`saveCurrentProject`](frontend/src/stores/modules/projectModule.ts:155) æ–¹æ³•ï¼Œå¤„ç†é¡¹ç›®æ•°æ®çš„åˆå¹¶å’ŒæŒä¹…åŒ–
- **åŠ è½½è¿›åº¦ç®¡ç†**ï¼šæä¾›é¡¹ç›®åŠ è½½è¿›åº¦æ˜¾ç¤ºåŠŸèƒ½ [`updateLoadingProgress`](frontend/src/stores/modules/projectModule.ts:92)

### 2.3 æ•°æ®æŒä¹…åŒ–å±‚ - ProjectManager

[`ProjectManager.ts`](frontend/src/utils/ProjectManager.ts:475) è´Ÿè´£é¡¹ç›®çš„å®é™…å­˜å‚¨æ“ä½œï¼š

- **é¡¹ç›®æ–‡ä»¶ç®¡ç†**ï¼šåˆ›å»ºã€ä¿å­˜ã€åŠ è½½é¡¹ç›®é…ç½®æ–‡ä»¶ [`project.json`](frontend/src/utils/ProjectManager.ts:554)
- **ç›®å½•ç»“æ„ç®¡ç†**ï¼šç»´æŠ¤é¡¹ç›®ç›®å½•ç»“æ„ï¼ˆmediaã€exportsç­‰å­ç›®å½•ï¼‰
- **é¡¹ç›®åˆ—è¡¨ç®¡ç†**ï¼šæä¾›é¡¹ç›®æ‰«æå’Œåˆ—è¡¨åŠŸèƒ½ [`listProjects`](frontend/src/utils/ProjectManager.ts:59)
- **åˆ†é˜¶æ®µåŠ è½½**ï¼šæ”¯æŒé¡¹ç›®è®¾ç½®çš„é¢„åŠ è½½å’Œå†…å®¹çš„åˆ†é˜¶æ®µåŠ è½½

### 2.4 åª’ä½“ç®¡ç†å±‚ - MediaManager

[`MediaManager.ts`](frontend/src/utils/MediaManager.ts) è´Ÿè´£åª’ä½“æ–‡ä»¶çš„ç®¡ç†ï¼š

- **åª’ä½“æ–‡ä»¶å­˜å‚¨**ï¼šå°†åª’ä½“æ–‡ä»¶ä¿å­˜åˆ°é¡¹ç›®ç›®å½•çš„ç›¸åº”å­ç›®å½•ä¸­ [`saveMediaToProject`](frontend/src/utils/MediaManager.ts:39)
- **å…ƒæ•°æ®ç®¡ç†**ï¼šç”Ÿæˆå’Œä¿å­˜åª’ä½“æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ [`generateMediaMetadata`](frontend/src/utils/MediaManager.ts:102)
- **æ–‡ä»¶å®Œæ•´æ€§éªŒè¯**ï¼šé€šè¿‡æ ¡éªŒå’ŒéªŒè¯åª’ä½“æ–‡ä»¶å®Œæ•´æ€§ [`verifyMediaIntegrity`](frontend/src/utils/MediaManager.ts:228)
- **åª’ä½“é‡å»º**ï¼šä»æœ¬åœ°æ–‡ä»¶é‡å»ºWebAV Clipå¯¹è±¡ [`rebuildWebAVClip`](frontend/src/utils/MediaManager.ts:413)

## 3. é¡¹ç›®ä¿å­˜çš„æ­¥éª¤å’Œæ•°æ®æµ

### 3.1 ä¿å­˜è§¦å‘æµç¨‹

1. **ç”¨æˆ·æ“ä½œè§¦å‘**
   - ç”¨æˆ·ç‚¹å‡»ä¸»ç•Œé¢çš„ä¿å­˜æŒ‰é’® [`VideoEditor.vue`](frontend/src/views/VideoEditor.vue:43)
   - æˆ–åœ¨é¡¹ç›®è®¾ç½®å¯¹è¯æ¡†ä¸­ç‚¹å‡»ä¿å­˜ [`EditProjectDialog.vue`](frontend/src/components/EditProjectDialog.vue:40)

2. **çŠ¶æ€ç®¡ç†å“åº”**
   - [`videoStore.saveCurrentProject`](frontend/src/stores/videoStore.ts:1570) è¢«è°ƒç”¨
   - è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯ [`projectModule.saveCurrentProject`](frontend/src/stores/modules/projectModule.ts:155) çš„ä»£ç†

### 3.2 é¡¹ç›®ä¿å­˜æ ¸å¿ƒæµç¨‹

```typescript
// projectModule.ts ä¸­çš„ saveCurrentProject æ–¹æ³•
async function saveCurrentProject(projectData?: Partial<ProjectConfig>): Promise<void> {
  if (!currentProject.value) {
    throw new Error('æ²¡æœ‰å½“å‰é¡¹ç›®å¯ä¿å­˜')
  }

  try {
    isSaving.value = true
    console.log(`ğŸ’¾ ä¿å­˜é¡¹ç›®: ${currentProject.value.name}`)

    // 1. åˆå¹¶é¡¹ç›®æ•°æ®
    const updatedProject: ProjectConfig = {
      ...currentProject.value,           // åŸæœ‰é¡¹ç›®é…ç½®
      ...projectData,                    // æ–°çš„é¡¹ç›®æ•°æ®ï¼ˆå¯é€‰ï¼‰
      localMediaReferences: mediaReferences.value,  // åª’ä½“å¼•ç”¨æ˜ å°„
      asyncProcessingMediaReferences: {},          // å¼‚æ­¥å¤„ç†åª’ä½“å¼•ç”¨
      updatedAt: new Date().toISOString(),        // æ›´æ–°æ—¶é—´æˆ³
    }

    // 2. è°ƒç”¨ ProjectManager ä¿å­˜é¡¹ç›®
    await projectManager.saveProject(updatedProject)
    
    // 3. æ›´æ–°çŠ¶æ€
    currentProject.value = updatedProject
    lastSaved.value = new Date()

    console.log(`âœ… é¡¹ç›®ä¿å­˜æˆåŠŸ: ${updatedProject.name}`)
  } catch (error) {
    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error)
    throw error
  } finally {
    isSaving.value = false
  }
}
```

### 3.3 é¡¹ç›®æ–‡ä»¶ä¿å­˜æµç¨‹

```typescript
// ProjectManager.ts ä¸­çš„ saveProject æ–¹æ³•
async saveProject(projectConfig: ProjectConfig): Promise<void> {
  const workspaceHandle = await directoryManager.getWorkspaceHandle()
  if (!workspaceHandle) {
    throw new Error('æœªè®¾ç½®å·¥ä½œç›®å½•')
  }

  try {
    // 1. è·å–é¡¹ç›®ç›®å½•
    const projectsHandle = await workspaceHandle.getDirectoryHandle(this.PROJECTS_FOLDER)
    const projectHandle = await projectsHandle.getDirectoryHandle(projectConfig.id)

    // 2. æ›´æ–°æ—¶é—´æˆ³
    projectConfig.updatedAt = new Date().toISOString()

    // 3. ä¿å­˜é¡¹ç›®é…ç½®æ–‡ä»¶
    await this.saveProjectConfig(projectHandle, projectConfig)
    console.log('é¡¹ç›®ä¿å­˜æˆåŠŸ:', projectConfig.name)
  } catch (error) {
    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error)
    throw error
  }
}
```

### 3.4 åª’ä½“æ–‡ä»¶ä¿å­˜æµç¨‹

å½“ç”¨æˆ·å¯¼å…¥åª’ä½“æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘ä»¥ä¸‹æµç¨‹ï¼š

1. **åª’ä½“æ–‡ä»¶ä¿å­˜**ï¼šç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œä¿å­˜åˆ°å¯¹åº”ç±»å‹çš„å­ç›®å½•
2. **å…ƒæ•°æ®ç”Ÿæˆå’Œä¿å­˜**ï¼šè®¡ç®—æ–‡ä»¶æ ¡éªŒå’Œï¼Œç”Ÿæˆå…ƒæ•°æ®å¹¶ä¿å­˜åˆ° `.meta` æ–‡ä»¶
3. **åª’ä½“å¼•ç”¨åˆ›å»º**ï¼šåˆ›å»ºåª’ä½“å¼•ç”¨å¯¹è±¡å¹¶æ·»åŠ åˆ°é¡¹ç›®çš„åª’ä½“å¼•ç”¨æ˜ å°„ä¸­

### 3.5 æ•°æ®æµå›¾

```
ç”¨æˆ·æ“ä½œ
    â†“
videoStore.saveCurrentProject()
    â†“
projectModule.saveCurrentProject()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ•°æ®åˆå¹¶å’Œå‡†å¤‡               â”‚
â”‚  - åˆå¹¶é¡¹ç›®æ•°æ®                    â”‚
â”‚  - æ·»åŠ åª’ä½“å¼•ç”¨æ˜ å°„                â”‚
â”‚  - æ›´æ–°æ—¶é—´æˆ³                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ProjectManager.saveProject()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        é¡¹ç›®æ–‡ä»¶ä¿å­˜                 â”‚
â”‚  - è·å–é¡¹ç›®ç›®å½•                    â”‚
â”‚  - æ›´æ–°é…ç½®å¯¹è±¡                    â”‚
â”‚  - å†™å…¥ project.json                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ›´æ–°çŠ¶æ€ï¼ˆcurrentProject, lastSavedï¼‰
    â†“
ä¿å­˜å®Œæˆ
```

## 4. æ—§æ¶æ„é¡¹ç›®ä¿å­˜æµç¨‹çš„ç‰¹ç‚¹å’Œè®¾è®¡æ€è·¯

### 4.1 æ¶æ„ç‰¹ç‚¹

#### 4.1.1 æ¨¡å—åŒ–è®¾è®¡
- **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œï¼Œä¾¿äºç»´æŠ¤å’Œæµ‹è¯•
- **æ¾è€¦åˆ**ï¼šæ¨¡å—ä¹‹é—´é€šè¿‡ä¾èµ–æ³¨å…¥å’Œæ¥å£è°ƒç”¨è¿›è¡Œäº¤äº’ï¼Œé™ä½äº†è€¦åˆåº¦

#### 4.1.2 åˆ†å±‚æ¶æ„
- **æ¸…æ™°çš„å±‚æ¬¡ç»“æ„**ï¼šä»ç”¨æˆ·ç•Œé¢åˆ°æ•°æ®æŒä¹…åŒ–ï¼Œå½¢æˆäº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- **å•å‘æ•°æ®æµ**ï¼šæ•°æ®ä»ä¸Šåˆ°ä¸‹æµåŠ¨ï¼ŒçŠ¶æ€å˜æ›´å¯é¢„æµ‹

### 4.2 è®¾è®¡æ€è·¯

#### 4.2.1 å•ä¾‹æ¨¡å¼çš„åº”ç”¨
- **èµ„æºç®¡ç†**ï¼šProjectManager å’Œ MediaManager éƒ½é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹
- **çŠ¶æ€å…±äº«**ï¼šå•ä¾‹æ¨¡å¼ä¾¿äºåœ¨ä¸åŒæ¨¡å—é—´å…±äº«çŠ¶æ€å’Œæ–¹æ³•

#### 4.2.2 å¼•ç”¨è€Œéå¤åˆ¶çš„åª’ä½“ç®¡ç†ç­–ç•¥
- **åª’ä½“å¼•ç”¨æœºåˆ¶**ï¼šé¡¹ç›®é…ç½®ä¸­ä¿å­˜çš„æ˜¯åª’ä½“æ–‡ä»¶çš„å¼•ç”¨ä¿¡æ¯ï¼Œè€Œä¸æ˜¯åª’ä½“æ–‡ä»¶æœ¬èº«
- **æ–‡ä»¶å®Œæ•´æ€§éªŒè¯**ï¼šé€šè¿‡SHA-256æ ¡éªŒå’ŒéªŒè¯åª’ä½“æ–‡ä»¶å®Œæ•´æ€§

#### 4.2.3 å¼‚æ­¥æ“ä½œå’Œé”™è¯¯å¤„ç†
- **å¼‚æ­¥ä¿å­˜**ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½é‡‡ç”¨å¼‚æ­¥æ–¹å¼ï¼Œé¿å…é˜»å¡UIçº¿ç¨‹
- **å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼šæ¯ä¸ªå¼‚æ­¥æ“ä½œéƒ½æœ‰try-catchå—ï¼Œç¡®ä¿é”™è¯¯èƒ½å¤Ÿè¢«æ•è·å’Œä¼ æ’­

#### 4.2.4 çŠ¶æ€ç®¡ç†å’ŒUIåé¦ˆ
- **å®æ—¶çŠ¶æ€æ›´æ–°**ï¼šé€šè¿‡å“åº”å¼çŠ¶æ€ç®¡ç†ï¼ŒUIèƒ½å¤Ÿå®æ—¶åæ˜ ä¿å­˜çŠ¶æ€
- **ç”¨æˆ·å‹å¥½çš„åé¦ˆ**ï¼šæä¾›ä¿å­˜çŠ¶æ€æ–‡æœ¬å’Œè¿›åº¦æ˜¾ç¤º

### 4.3 é¡¹ç›®ç›®å½•ç»“æ„è®¾è®¡

```
projects/
â”œâ”€â”€ {projectId}/
â”‚   â”œâ”€â”€ project.json          # é¡¹ç›®é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ media/                # åª’ä½“æ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ videos/          # è§†é¢‘æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ images/          # å›¾ç‰‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ audio/           # éŸ³é¢‘æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ thumbnails/      # ç¼©ç•¥å›¾æ–‡ä»¶
â”‚   â””â”€â”€ exports/             # å¯¼å‡ºæ–‡ä»¶ç›®å½•
```

### 4.4 æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

#### 4.4.1 åˆ†é˜¶æ®µåŠ è½½
- **è®¾ç½®é¢„åŠ è½½**ï¼šæ”¯æŒåªåŠ è½½é¡¹ç›®è®¾ç½®è€Œä¸åŠ è½½åª’ä½“æ–‡ä»¶ï¼Œæé«˜é¡¹ç›®æ‰“å¼€é€Ÿåº¦
- **å†…å®¹åŠ è½½**ï¼šæ”¯æŒåˆ†é˜¶æ®µåŠ è½½åª’ä½“æ–‡ä»¶å’Œæ—¶é—´è½´æ•°æ®

#### 4.4.2 æ‰¹é‡å¤„ç†
- **åª’ä½“æ–‡ä»¶æ‰¹é‡åŠ è½½**ï¼šæ”¯æŒæ‰¹é‡åŠ è½½åª’ä½“æ–‡ä»¶ï¼Œå¯é…ç½®æ‰¹æ¬¡å¤§å°
- **è¿›åº¦åé¦ˆ**ï¼šæä¾›åŠ è½½è¿›åº¦åé¦ˆï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ

### 4.5 æ€»ç»“

æ—§æ¶æ„çš„é¡¹ç›®ä¿å­˜æµç¨‹è®¾è®¡ä½“ç°äº†è‰¯å¥½çš„è½¯ä»¶å·¥ç¨‹å®è·µï¼ŒåŒ…æ‹¬æ¨¡å—åŒ–ã€åˆ†å±‚æ¶æ„ã€èŒè´£åˆ†ç¦»ç­‰åŸåˆ™ã€‚é€šè¿‡å¼•ç”¨è€Œéå¤åˆ¶çš„åª’ä½“ç®¡ç†ç­–ç•¥ï¼Œæœ‰æ•ˆæ§åˆ¶äº†é¡¹ç›®æ–‡ä»¶å¤§å°ï¼›é€šè¿‡å¼‚æ­¥æ“ä½œå’Œå®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œä¿è¯äº†ç”¨æˆ·ä½“éªŒï¼›é€šè¿‡åˆ†é˜¶æ®µåŠ è½½å’Œæ‰¹é‡å¤„ç†ï¼Œä¼˜åŒ–äº†æ€§èƒ½ã€‚è¿™äº›è®¾è®¡æ€è·¯ä¸ºæ–°æ¶æ„çš„ç»Ÿä¸€ç±»å‹è®¾è®¡æä¾›äº†å®è´µçš„ç»éªŒå’Œå‚è€ƒã€‚