# 旧架构项目保存流程整理

## 1. 整体架构分析

旧架构的项目保存流程采用了模块化设计，主要包含以下几个核心层次：

- **用户界面层**：通过 [`VideoEditor.vue`](frontend/src/views/VideoEditor.vue:43) 和 [`EditProjectDialog.vue`](frontend/src/components/EditProjectDialog.vue:40) 提供保存操作的触发点
- **状态管理层**：通过 [`videoStore.ts`](frontend/src/stores/videoStore.ts:1570) 统一管理应用状态，包括项目保存状态
- **业务逻辑层**：通过 [`projectModule.ts`](frontend/src/stores/modules/projectModule.ts:155) 处理项目保存的业务逻辑
- **数据持久化层**：通过 [`ProjectManager.ts`](frontend/src/utils/ProjectManager.ts:475) 和 [`MediaManager.ts`](frontend/src/utils/MediaManager.ts) 负责实际的数据保存操作

## 2. 核心组件和作用

### 2.1 状态管理层 - videoStore

[`videoStore.ts`](frontend/src/stores/videoStore.ts:1570) 是整个应用的状态管理中心，负责：

- **状态聚合**：整合了多个模块的状态（媒体、轨道、时间轴、播放、配置等）
- **接口统一**：提供统一的项目保存接口 [`saveCurrentProject`](frontend/src/stores/videoStore.ts:1570)
- **状态管理**：管理项目保存状态 [`isSaving`](frontend/src/stores/videoStore.ts:1554)、项目信息 [`currentProject`](frontend/src/stores/videoStore.ts:1549) 等

### 2.2 业务逻辑层 - projectModule

[`projectModule.ts`](frontend/src/stores/modules/projectModule.ts:155) 是项目管理的核心模块，负责：

- **项目状态管理**：管理当前项目配置 [`currentProject`](frontend/src/stores/modules/projectModule.ts:13)、保存状态 [`isSaving`](frontend/src/stores/modules/projectModule.ts:16) 等
- **媒体引用管理**：维护媒体文件引用映射 [`mediaReferences`](frontend/src/stores/modules/projectModule.ts:34)
- **保存逻辑**：实现 [`saveCurrentProject`](frontend/src/stores/modules/projectModule.ts:155) 方法，处理项目数据的合并和持久化
- **加载进度管理**：提供项目加载进度显示功能 [`updateLoadingProgress`](frontend/src/stores/modules/projectModule.ts:92)

### 2.3 数据持久化层 - ProjectManager

[`ProjectManager.ts`](frontend/src/utils/ProjectManager.ts:475) 负责项目的实际存储操作：

- **项目文件管理**：创建、保存、加载项目配置文件 [`project.json`](frontend/src/utils/ProjectManager.ts:554)
- **目录结构管理**：维护项目目录结构（media、exports等子目录）
- **项目列表管理**：提供项目扫描和列表功能 [`listProjects`](frontend/src/utils/ProjectManager.ts:59)
- **分阶段加载**：支持项目设置的预加载和内容的分阶段加载

### 2.4 媒体管理层 - MediaManager

[`MediaManager.ts`](frontend/src/utils/MediaManager.ts) 负责媒体文件的管理：

- **媒体文件存储**：将媒体文件保存到项目目录的相应子目录中 [`saveMediaToProject`](frontend/src/utils/MediaManager.ts:39)
- **元数据管理**：生成和保存媒体文件的元数据信息 [`generateMediaMetadata`](frontend/src/utils/MediaManager.ts:102)
- **文件完整性验证**：通过校验和验证媒体文件完整性 [`verifyMediaIntegrity`](frontend/src/utils/MediaManager.ts:228)
- **媒体重建**：从本地文件重建WebAV Clip对象 [`rebuildWebAVClip`](frontend/src/utils/MediaManager.ts:413)

## 3. 项目保存的步骤和数据流

### 3.1 保存触发流程

1. **用户操作触发**
   - 用户点击主界面的保存按钮 [`VideoEditor.vue`](frontend/src/views/VideoEditor.vue:43)
   - 或在项目设置对话框中点击保存 [`EditProjectDialog.vue`](frontend/src/components/EditProjectDialog.vue:40)

2. **状态管理响应**
   - [`videoStore.saveCurrentProject`](frontend/src/stores/videoStore.ts:1570) 被调用
   - 该方法实际上是 [`projectModule.saveCurrentProject`](frontend/src/stores/modules/projectModule.ts:155) 的代理

### 3.2 项目保存核心流程

```typescript
// projectModule.ts 中的 saveCurrentProject 方法
async function saveCurrentProject(projectData?: Partial<ProjectConfig>): Promise<void> {
  if (!currentProject.value) {
    throw new Error('没有当前项目可保存')
  }

  try {
    isSaving.value = true
    console.log(`💾 保存项目: ${currentProject.value.name}`)

    // 1. 合并项目数据
    const updatedProject: ProjectConfig = {
      ...currentProject.value,           // 原有项目配置
      ...projectData,                    // 新的项目数据（可选）
      localMediaReferences: mediaReferences.value,  // 媒体引用映射
      asyncProcessingMediaReferences: {},          // 异步处理媒体引用
      updatedAt: new Date().toISOString(),        // 更新时间戳
    }

    // 2. 调用 ProjectManager 保存项目
    await projectManager.saveProject(updatedProject)
    
    // 3. 更新状态
    currentProject.value = updatedProject
    lastSaved.value = new Date()

    console.log(`✅ 项目保存成功: ${updatedProject.name}`)
  } catch (error) {
    console.error('保存项目失败:', error)
    throw error
  } finally {
    isSaving.value = false
  }
}
```

### 3.3 项目文件保存流程

```typescript
// ProjectManager.ts 中的 saveProject 方法
async saveProject(projectConfig: ProjectConfig): Promise<void> {
  const workspaceHandle = await directoryManager.getWorkspaceHandle()
  if (!workspaceHandle) {
    throw new Error('未设置工作目录')
  }

  try {
    // 1. 获取项目目录
    const projectsHandle = await workspaceHandle.getDirectoryHandle(this.PROJECTS_FOLDER)
    const projectHandle = await projectsHandle.getDirectoryHandle(projectConfig.id)

    // 2. 更新时间戳
    projectConfig.updatedAt = new Date().toISOString()

    // 3. 保存项目配置文件
    await this.saveProjectConfig(projectHandle, projectConfig)
    console.log('项目保存成功:', projectConfig.name)
  } catch (error) {
    console.error('保存项目失败:', error)
    throw error
  }
}
```

### 3.4 媒体文件保存流程

当用户导入媒体文件时，会触发以下流程：

1. **媒体文件保存**：生成唯一文件名，保存到对应类型的子目录
2. **元数据生成和保存**：计算文件校验和，生成元数据并保存到 `.meta` 文件
3. **媒体引用创建**：创建媒体引用对象并添加到项目的媒体引用映射中

### 3.5 数据流图

```
用户操作
    ↓
videoStore.saveCurrentProject()
    ↓
projectModule.saveCurrentProject()
    ↓
┌─────────────────────────────────────┐
│        数据合并和准备               │
│  - 合并项目数据                    │
│  - 添加媒体引用映射                │
│  - 更新时间戳                      │
└─────────────────────────────────────┘
    ↓
ProjectManager.saveProject()
    ↓
┌─────────────────────────────────────┐
│        项目文件保存                 │
│  - 获取项目目录                    │
│  - 更新配置对象                    │
│  - 写入 project.json                │
└─────────────────────────────────────┘
    ↓
更新状态（currentProject, lastSaved）
    ↓
保存完成
```

## 4. 旧架构项目保存流程的特点和设计思路

### 4.1 架构特点

#### 4.1.1 模块化设计
- **职责分离**：每个模块都有明确的职责边界，便于维护和测试
- **松耦合**：模块之间通过依赖注入和接口调用进行交互，降低了耦合度

#### 4.1.2 分层架构
- **清晰的层次结构**：从用户界面到数据持久化，形成了清晰的分层架构
- **单向数据流**：数据从上到下流动，状态变更可预测

### 4.2 设计思路

#### 4.2.1 单例模式的应用
- **资源管理**：ProjectManager 和 MediaManager 都采用单例模式，确保全局只有一个实例
- **状态共享**：单例模式便于在不同模块间共享状态和方法

#### 4.2.2 引用而非复制的媒体管理策略
- **媒体引用机制**：项目配置中保存的是媒体文件的引用信息，而不是媒体文件本身
- **文件完整性验证**：通过SHA-256校验和验证媒体文件完整性

#### 4.2.3 异步操作和错误处理
- **异步保存**：所有文件操作都采用异步方式，避免阻塞UI线程
- **完善的错误处理**：每个异步操作都有try-catch块，确保错误能够被捕获和传播

#### 4.2.4 状态管理和UI反馈
- **实时状态更新**：通过响应式状态管理，UI能够实时反映保存状态
- **用户友好的反馈**：提供保存状态文本和进度显示

### 4.3 项目目录结构设计

```
projects/
├── {projectId}/
│   ├── project.json          # 项目配置文件
│   ├── media/                # 媒体文件目录
│   │   ├── videos/          # 视频文件
│   │   ├── images/          # 图片文件
│   │   ├── audio/           # 音频文件
│   │   └── thumbnails/      # 缩略图文件
│   └── exports/             # 导出文件目录
```

### 4.4 性能优化考虑

#### 4.4.1 分阶段加载
- **设置预加载**：支持只加载项目设置而不加载媒体文件，提高项目打开速度
- **内容加载**：支持分阶段加载媒体文件和时间轴数据

#### 4.4.2 批量处理
- **媒体文件批量加载**：支持批量加载媒体文件，可配置批次大小
- **进度反馈**：提供加载进度反馈，改善用户体验

### 4.5 总结

旧架构的项目保存流程设计体现了良好的软件工程实践，包括模块化、分层架构、职责分离等原则。通过引用而非复制的媒体管理策略，有效控制了项目文件大小；通过异步操作和完善的错误处理，保证了用户体验；通过分阶段加载和批量处理，优化了性能。这些设计思路为新架构的统一类型设计提供了宝贵的经验和参考。