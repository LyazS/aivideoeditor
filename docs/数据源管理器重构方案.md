# ç»Ÿä¸€åª’ä½“é¡¹ç›®æ•°æ®æºç®¡ç†å™¨é‡æ„æ–¹æ¡ˆ

## å½“å‰æ¶æ„åˆ†æ

### ç°æœ‰æ¶æ„é—®é¢˜
å½“å‰æ¶æ„å­˜åœ¨**åŒé‡çŠ¶æ€ç®¡ç†**çš„é—®é¢˜ï¼š

1. **UnifiedMediaItemDataå±‚é¢çš„çŠ¶æ€ç®¡ç†**ï¼š
   - `mediaStatus`: 'pending' | 'asyncprocessing' | 'webavdecoding' | 'ready' | 'error' | 'cancelled' | 'missing'
   - ç”±UnifiedMediaModuleç®¡ç†

2. **æ•°æ®æºå±‚é¢çš„çŠ¶æ€ç®¡ç†**ï¼š
   - `source.status`: 'pending' | 'acquiring' | 'acquired' | 'error' | 'cancelled' | 'missing'
   - ç”±å„ç§DataSourceManagerç®¡ç†

3. **çŠ¶æ€åŒæ­¥å¤æ‚æ€§**ï¼š
   - UnifiedMediaModuleéœ€è¦ç›‘å¬æ•°æ®æºçŠ¶æ€å˜åŒ–
   - é€šè¿‡`handleSourceStatusChange`æ–¹æ³•è¿›è¡ŒçŠ¶æ€æ˜ å°„å’ŒåŒæ­¥
   - å­˜åœ¨çŠ¶æ€ä¸ä¸€è‡´çš„é£é™©

### å½“å‰æ¶æ„æµç¨‹å›¾

```mermaid
graph TD
    A[UnifiedMediaItemData] --> B[mediaStatus]
    A --> C[source: UnifiedDataSourceData]
    C --> D[source.status]
    
    E[DataSourceManager] --> F[ç®¡ç†source.status]
    G[UnifiedMediaModule] --> H[ç®¡ç†mediaStatus]
    G --> I[ç›‘å¬source.statuså˜åŒ–]
    I --> J[handleSourceStatusChange]
    J --> K[åŒæ­¥åˆ°mediaStatus]
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style G fill:#f3e5f5
```

## æ–°æ¶æ„è®¾è®¡æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**è®©æ•°æ®æºç®¡ç†å™¨ç›´æ¥ç®¡ç†UnifiedMediaItemDataï¼Œä»UnifiedMediaItemDataå±‚é¢ç»Ÿä¸€å¤„ç†çŠ¶æ€æœºï¼Œæ¶ˆé™¤åŒé‡çŠ¶æ€ç®¡ç†ã€‚**

### è®¾è®¡åŸåˆ™

1. **ä¿æŒç±»å‹ç»“æ„ä¸å˜**ï¼šUnifiedMediaItemDataå’ŒUnifiedDataSourceDataçš„ç»“æ„å±‚çº§ä¿æŒä¸å˜
2. **æå‡ç®¡ç†å±‚çº§**ï¼šæ•°æ®æºç®¡ç†å™¨ä»ç®¡ç†æ•°æ®æºçŠ¶æ€æå‡åˆ°ç®¡ç†æ•´ä¸ªåª’ä½“é¡¹ç›®
3. **ç»Ÿä¸€çŠ¶æ€æœº**ï¼šåªåœ¨UnifiedMediaItemDataå±‚é¢ç»´æŠ¤ä¸€å¥—çŠ¶æ€æœº
4. **ç®€åŒ–çŠ¶æ€åŒæ­¥**ï¼šæ¶ˆé™¤çŠ¶æ€æ˜ å°„å’ŒåŒæ­¥é€»è¾‘

### æ–°æ¶æ„æµç¨‹å›¾

```mermaid
graph TD
    A[UnifiedMediaItemData] --> B[mediaStatus - å”¯ä¸€çŠ¶æ€æº]
    A --> C[source: UnifiedDataSourceData]
    C --> D[sourceæ•°æ® - æ— çŠ¶æ€å­—æ®µ]
    
    E[DataSourceManager] --> F[ç›´æ¥ç®¡ç†UnifiedMediaItemData]
    F --> G[ç»Ÿä¸€çŠ¶æ€æœºå¤„ç†]
    G --> H[æ•°æ®è·å– + WebAVå¤„ç† + çŠ¶æ€æ›´æ–°]
    
    I[UnifiedMediaModule] --> J[ç®€åŒ–ä¸ºåª’ä½“é¡¹ç›®CRUD]
    J --> K[å§”æ‰˜ç»™DataSourceManager]
    
    style A fill:#e8f5e8
    style E fill:#fff8e1
    style I fill:#f0f4ff
```

## è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### 1. ä¿®æ”¹ç°æœ‰æ•°æ®æºç®¡ç†å™¨

```typescript
// ä¿®æ”¹ç°æœ‰çš„BaseDataSourceManager
abstract class DataSourceManager<T extends UnifiedDataSourceData> {
  // æ–°å¢ï¼šç›´æ¥ç®¡ç†UnifiedMediaItemData
  protected mediaItems: Map<string, UnifiedMediaItemData> = new Map()
  
  // æ–°å¢ï¼šæ ¸å¿ƒæ–¹æ³•ï¼Œå¤„ç†å®Œæ•´çš„åª’ä½“é¡¹ç›®ç”Ÿå‘½å‘¨æœŸ
  abstract processMediaItem(mediaItem: UnifiedMediaItemData): Promise<void>
  
  // æ–°å¢ï¼šç»Ÿä¸€çŠ¶æ€æœºæ–¹æ³•
  protected transitionMediaStatus(
    mediaItem: UnifiedMediaItemData,
    status: MediaStatus
  ): void {
    mediaItem.mediaStatus = status
    console.log(`ğŸ”„ [${this.getManagerType()}] åª’ä½“çŠ¶æ€è½¬æ¢: ${mediaItem.name} -> ${status}`)
  }
  
  // ä¿ç•™åŸæœ‰çš„ä»»åŠ¡ç®¡ç†é€»è¾‘...
}
```

### 2. çŠ¶æ€æœºç®€åŒ–

**ç§»é™¤æ•°æ®æºçŠ¶æ€å­—æ®µ**ï¼š
```typescript
// åŸæ¥çš„æ•°æ®æºè¿è¡Œæ—¶çŠ¶æ€
interface DataSourceRuntimeState {
  status: DataSourceStatus  // âŒ åˆ é™¤
  progress: number         // âœ… ä¿ç•™
  errorMessage?: string    // âœ… ä¿ç•™
  taskId?: string         // âœ… ä¿ç•™
  file: File | null       // âœ… ä¿ç•™
  url: string | null      // âœ… ä¿ç•™
}
```

**ç»Ÿä¸€ä½¿ç”¨åª’ä½“é¡¹ç›®çŠ¶æ€**ï¼š
```typescript
// åªåœ¨UnifiedMediaItemDataå±‚é¢ç»´æŠ¤çŠ¶æ€
interface UnifiedMediaItemData {
  mediaStatus: MediaStatus  // å”¯ä¸€çš„çŠ¶æ€æº
  // ... å…¶ä»–å­—æ®µä¿æŒä¸å˜
}
```

### 3. ç®¡ç†å™¨èŒè´£é‡æ–°åˆ†é…

#### 3.1 DataSourceManagerèŒè´£æ‰©å±•
- **å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä»æ•°æ®è·å–åˆ°WebAVå¤„ç†çš„å®Œæ•´æµç¨‹
- **ç»Ÿä¸€çŠ¶æ€æœº**ï¼šç›´æ¥æ›´æ–°UnifiedMediaItemDataçš„mediaStatus
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **è¿›åº¦æŠ¥å‘Š**ï¼šé€šè¿‡UnifiedMediaItemData.source.progressæŠ¥å‘Šè¿›åº¦

#### 3.2 UnifiedMediaModuleèŒè´£ç®€åŒ–
- **åª’ä½“é¡¹ç›®CRUD**ï¼šåˆ›å»ºã€åˆ é™¤ã€æŸ¥è¯¢åª’ä½“é¡¹ç›®
- **å§”æ‰˜å¤„ç†**ï¼šå°†å¤„ç†ä»»åŠ¡å§”æ‰˜ç»™å¯¹åº”çš„DataSourceManager
- **é›†åˆç®¡ç†**ï¼šç»´æŠ¤åª’ä½“é¡¹ç›®é›†åˆå’Œç´¢å¼•

### 4. å…·ä½“å®ç°æ–¹æ¡ˆ

#### 4.1 ä¿®æ”¹RemoteFileManager

```typescript
class RemoteFileManager extends DataSourceManager<RemoteFileSourceData> {
  // æ–°å¢ï¼šå¤„ç†å®Œæ•´çš„åª’ä½“é¡¹ç›®ç”Ÿå‘½å‘¨æœŸ
  async processMediaItem(mediaItem: UnifiedMediaItemData): Promise<void> {
    try {
      // 1. è®¾ç½®ä¸ºå¤„ç†ä¸­çŠ¶æ€
      this.transitionMediaStatus(mediaItem, 'asyncprocessing')
      
      // 2. æ‰§è¡Œä¸‹è½½
      await this.downloadFile(mediaItem.source as RemoteFileSourceData)
      
      // 3. è®¾ç½®ä¸ºWebAVè§£æçŠ¶æ€
      this.transitionMediaStatus(mediaItem, 'webavdecoding')
      
      // 4. æ‰§è¡ŒWebAVå¤„ç†
      await this.processWithWebAV(mediaItem)
      
      // 5. è®¾ç½®ä¸ºå°±ç»ªçŠ¶æ€
      this.transitionMediaStatus(mediaItem, 'ready')
    } catch (error) {
      this.transitionMediaStatus(mediaItem, 'error')
      mediaItem.source.errorMessage = error instanceof Error ? error.message : 'å¤„ç†å¤±è´¥'
    }
  }
  
  // æ–°å¢ï¼šWebAVå¤„ç†é€»è¾‘
  private async processWithWebAV(mediaItem: UnifiedMediaItemData): Promise<void> {
    // ä»UnifiedMediaModuleä¸­ç§»åŠ¨WebAVå¤„ç†é€»è¾‘åˆ°è¿™é‡Œ
    // è®¾ç½®mediaItem.webavå’Œduration
  }
  
  // ä¿ç•™åŸæœ‰çš„ä¸‹è½½é€»è¾‘ï¼Œä½†å»æ‰çŠ¶æ€ç®¡ç†éƒ¨åˆ†
  private async downloadFile(source: RemoteFileSourceData): Promise<void> {
    // ä¸‹è½½é€»è¾‘ï¼Œåªæ›´æ–°source.progressï¼Œä¸ç®¡ç†çŠ¶æ€
  }
}
```

#### 4.2 ä¿®æ”¹UserSelectedFileManager

```typescript
class UserSelectedFileManager extends DataSourceManager<UserSelectedFileSourceData> {
  // æ–°å¢ï¼šå¤„ç†å®Œæ•´çš„åª’ä½“é¡¹ç›®ç”Ÿå‘½å‘¨æœŸ
  async processMediaItem(mediaItem: UnifiedMediaItemData): Promise<void> {
    try {
      // 1. è®¾ç½®ä¸ºå¤„ç†ä¸­çŠ¶æ€ï¼ˆæ–‡ä»¶éªŒè¯ï¼‰
      this.transitionMediaStatus(mediaItem, 'asyncprocessing')
      
      // 2. éªŒè¯æ–‡ä»¶
      await this.validateFile(mediaItem.source as UserSelectedFileSourceData)
      
      // 3. è®¾ç½®ä¸ºWebAVè§£æçŠ¶æ€
      this.transitionMediaStatus(mediaItem, 'webavdecoding')
      
      // 4. æ‰§è¡ŒWebAVå¤„ç†
      await this.processWithWebAV(mediaItem)
      
      // 5. è®¾ç½®ä¸ºå°±ç»ªçŠ¶æ€
      this.transitionMediaStatus(mediaItem, 'ready')
    } catch (error) {
      this.transitionMediaStatus(mediaItem, 'error')
      mediaItem.source.errorMessage = error instanceof Error ? error.message : 'å¤„ç†å¤±è´¥'
    }
  }
  
  // æ–°å¢ï¼šWebAVå¤„ç†é€»è¾‘
  private async processWithWebAV(mediaItem: UnifiedMediaItemData): Promise<void> {
    // ä»UnifiedMediaModuleä¸­ç§»åŠ¨WebAVå¤„ç†é€»è¾‘åˆ°è¿™é‡Œ
    // è®¾ç½®mediaItem.webavå’Œduration
  }
  
  // ä¿ç•™åŸæœ‰çš„éªŒè¯é€»è¾‘ï¼Œä½†å»æ‰çŠ¶æ€ç®¡ç†éƒ¨åˆ†
  private async validateFile(source: UserSelectedFileSourceData): Promise<void> {
    // éªŒè¯é€»è¾‘ï¼Œåªæ›´æ–°source.progressï¼Œä¸ç®¡ç†çŠ¶æ€
  }
}
```

### 5. æ•°æ®æµé‡æ„

#### 5.1 æ–°çš„æ•°æ®æµ

```mermaid
sequenceDiagram
    participant UI as ç”¨æˆ·ç•Œé¢
    participant UM as UnifiedMediaModule
    participant EM as DataSourceManager
    participant WA as WebAV
    
    UI->>UM: æ·»åŠ åª’ä½“é¡¹ç›®
    UM->>UM: åˆ›å»ºUnifiedMediaItemData
    UM->>EM: processMediaItem(mediaItem)
    
    EM->>EM: transitionMediaStatus('asyncprocessing')
    EM->>EM: æ•°æ®è·å–ï¼ˆä¸‹è½½/éªŒè¯ï¼‰
    EM->>EM: transitionMediaStatus('webavdecoding')
    EM->>WA: WebAVå¤„ç†
    WA-->>EM: å¤„ç†ç»“æœ
    EM->>EM: æ›´æ–°mediaItem.webavå’Œduration
    EM->>EM: transitionMediaStatus('ready')
    
    EM-->>UM: å¤„ç†å®Œæˆ
    UM-->>UI: çŠ¶æ€æ›´æ–°é€šçŸ¥
```

#### 5.2 é”™è¯¯å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant EM as DataSourceManager
    participant MI as UnifiedMediaItemData
    
    EM->>MI: transitionMediaStatus('asyncprocessing')
    EM->>EM: æ‰§è¡Œå¤„ç†é€»è¾‘
    
    alt å¤„ç†æˆåŠŸ
        EM->>MI: transitionMediaStatus('ready')
    else å¤„ç†å¤±è´¥
        EM->>MI: transitionMediaStatus('error')
        EM->>MI: è®¾ç½®é”™è¯¯ä¿¡æ¯åˆ°source.errorMessage
    end
    
    alt ç”¨æˆ·é‡è¯•
        EM->>MI: transitionMediaStatus('pending')
        EM->>EM: é‡æ–°æ‰§è¡ŒprocessMediaItem
    end
```

### 6. è¿ç§»ç­–ç•¥

#### 6.1 é˜¶æ®µä¸€ï¼šä¿®æ”¹ç°æœ‰ç®¡ç†å™¨
1. åœ¨`BaseDataSourceManager`ä¸­æ·»åŠ `processMediaItem`æ–¹æ³•
2. ä¿®æ”¹`RemoteFileManager`å’Œ`UserSelectedFileManager`ï¼Œå®ç°æ–°çš„å¤„ç†æµç¨‹
3. å°†WebAVå¤„ç†é€»è¾‘ä»`UnifiedMediaModule`ç§»åŠ¨åˆ°å„ä¸ªç®¡ç†å™¨ä¸­

#### 6.2 é˜¶æ®µäºŒï¼šé‡æ„UnifiedMediaModule
1. ä¿®æ”¹`startMediaProcessing`æ–¹æ³•ï¼Œè°ƒç”¨ç®¡ç†å™¨çš„`processMediaItem`
2. ç§»é™¤`handleSourceStatusChange`å’Œ`startWebAVProcessing`æ–¹æ³•
3. ç®€åŒ–çŠ¶æ€åŒæ­¥é€»è¾‘

#### 6.3 é˜¶æ®µä¸‰ï¼šæ¸…ç†æ•°æ®æºçŠ¶æ€
1. ä»`DataSourceRuntimeState`ä¸­ç§»é™¤`status`å­—æ®µ
2. æ›´æ–°ç›¸å…³çš„ç±»å‹å®šä¹‰å’ŒæŸ¥è¯¢å‡½æ•°
3. æ¸…ç†ä¸å†éœ€è¦çš„çŠ¶æ€æ˜ å°„ä»£ç 

#### 6.4 é˜¶æ®µå››ï¼šæµ‹è¯•å’Œä¼˜åŒ–
1. å…¨é¢æµ‹è¯•æ–°çš„çŠ¶æ€ç®¡ç†æœºåˆ¶
2. æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†å®Œå–„
3. æ¸…ç†æ—§çš„çŠ¶æ€åŒæ­¥ä»£ç 

### 7. ä¼˜åŠ¿åˆ†æ

#### 7.1 æ¶æ„ä¼˜åŠ¿
- **æ¶ˆé™¤åŒé‡çŠ¶æ€ç®¡ç†**ï¼šåªåœ¨UnifiedMediaItemDataå±‚é¢ç»´æŠ¤çŠ¶æ€
- **ç®€åŒ–çŠ¶æ€åŒæ­¥**ï¼šæ— éœ€çŠ¶æ€æ˜ å°„å’ŒåŒæ­¥é€»è¾‘
- **æé«˜ä¸€è‡´æ€§**ï¼šå‡å°‘çŠ¶æ€ä¸ä¸€è‡´çš„é£é™©
- **å¢å¼ºå†…èšæ€§**ï¼šç›¸å…³é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªç®¡ç†å™¨ä¸­

#### 7.2 å¼€å‘ä¼˜åŠ¿
- **é™ä½å¤æ‚æ€§**ï¼šå¼€å‘è€…åªéœ€å…³æ³¨ä¸€å¥—çŠ¶æ€æœº
- **æ˜“äºè°ƒè¯•**ï¼šçŠ¶æ€å˜åŒ–è·¯å¾„æ›´æ¸…æ™°
- **ä¾¿äºæ‰©å±•**ï¼šæ–°å¢æ•°æ®æºç±»å‹æ›´ç®€å•
- **å‡å°‘bug**ï¼šæ¶ˆé™¤çŠ¶æ€åŒæ­¥ç›¸å…³çš„bug

#### 7.3 ç»´æŠ¤ä¼˜åŠ¿
- **ä»£ç æ›´ç®€æ´**ï¼šç§»é™¤å¤§é‡çŠ¶æ€åŒæ­¥ä»£ç 
- **é€»è¾‘æ›´æ¸…æ™°**ï¼šæ¯ä¸ªç®¡ç†å™¨è´Ÿè´£å®Œæ•´çš„å¤„ç†æµç¨‹
- **æµ‹è¯•æ›´å®¹æ˜“**ï¼šçŠ¶æ€å˜åŒ–æ›´å¯é¢„æµ‹

### 8. é£é™©è¯„ä¼°

#### 8.1 æŠ€æœ¯é£é™©
- **é‡æ„èŒƒå›´è¾ƒå¤§**ï¼šéœ€è¦ä¿®æ”¹å¤šä¸ªæ ¸å¿ƒæ¨¡å—
- **çŠ¶æ€æœºå¤æ‚æ€§**ï¼šéœ€è¦ä»”ç»†è®¾è®¡çŠ¶æ€è½¬æ¢é€»è¾‘
- **å‘åå…¼å®¹æ€§**ï¼šéœ€è¦ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

#### 8.2 ç¼“è§£æªæ–½
- **åˆ†é˜¶æ®µå®æ–½**ï¼šé€æ­¥è¿ç§»ï¼Œé™ä½é£é™©
- **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œå…¨é¢æµ‹è¯•
- **ä¿æŒæ¥å£ç¨³å®š**ï¼šå°½é‡ä¿æŒå¯¹å¤–æ¥å£ä¸å˜
- **å›æ»šæ–¹æ¡ˆ**ï¼šå‡†å¤‡å›æ»šåˆ°åŸæœ‰æ¶æ„çš„æ–¹æ¡ˆ

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šä¿®æ”¹ç°æœ‰ç®¡ç†å™¨ï¼ˆé¢„è®¡1-2å‘¨ï¼‰
- [ ] åœ¨`BaseDataSourceManager`ä¸­æ·»åŠ `processMediaItem`æŠ½è±¡æ–¹æ³•
- [ ] åœ¨`BaseDataSourceManager`ä¸­æ·»åŠ `transitionMediaStatus`æ–¹æ³•
- [ ] ä¿®æ”¹`RemoteFileManager`ï¼Œå®ç°`processMediaItem`æ–¹æ³•
- [ ] ä¿®æ”¹`UserSelectedFileManager`ï¼Œå®ç°`processMediaItem`æ–¹æ³•

### ç¬¬äºŒé˜¶æ®µï¼šç§»åŠ¨WebAVå¤„ç†é€»è¾‘ï¼ˆé¢„è®¡1-2å‘¨ï¼‰
- [ ] å°†`startWebAVProcessing`é€»è¾‘ä»`UnifiedMediaModule`ç§»åŠ¨åˆ°å„ä¸ªç®¡ç†å™¨
- [ ] å°†`generateVideoThumbnail`ç­‰å·¥å…·å‡½æ•°ç§»åŠ¨åˆ°ç®¡ç†å™¨ä¸­
- [ ] æ›´æ–°WebAVå¤„ç†çš„é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] æµ‹è¯•WebAVå¤„ç†é€»è¾‘çš„æ­£ç¡®æ€§

### ç¬¬ä¸‰é˜¶æ®µï¼šé‡æ„UnifiedMediaModuleï¼ˆé¢„è®¡1å‘¨ï¼‰
- [ ] ä¿®æ”¹`startMediaProcessing`æ–¹æ³•ï¼Œè°ƒç”¨ç®¡ç†å™¨çš„`processMediaItem`
- [ ] ç§»é™¤`handleSourceStatusChange`æ–¹æ³•
- [ ] ç§»é™¤`startWebAVProcessing`æ–¹æ³•
- [ ] ç®€åŒ–åª’ä½“é¡¹ç›®çš„çŠ¶æ€ç®¡ç†é€»è¾‘

### ç¬¬å››é˜¶æ®µï¼šæ¸…ç†æ•°æ®æºçŠ¶æ€ï¼ˆé¢„è®¡1å‘¨ï¼‰
- [ ] ä»`DataSourceRuntimeState`ä¸­ç§»é™¤`status`å­—æ®µ
- [ ] æ›´æ–°ç›¸å…³çš„ç±»å‹å®šä¹‰å’ŒæŸ¥è¯¢å‡½æ•°
- [ ] æ¸…ç†çŠ¶æ€æ˜ å°„ç›¸å…³çš„ä»£ç 
- [ ] æ›´æ–°ç®¡ç†å™¨æ³¨å†Œä¸­å¿ƒçš„ç›¸å…³é€»è¾‘

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆé¢„è®¡1å‘¨ï¼‰
- [ ] é›†æˆæµ‹è¯•å’Œå›å½’æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] ç”¨æˆ·ç•Œé¢é€‚é…æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°å’Œä»£ç å®¡æŸ¥

## ğŸ“‹ ä½¿ç”¨ç‚¹åˆ†æå’Œå…·ä½“ä¿®æ”¹æŒ‡å¯¼

### 1. **ä¸»è¦ä½¿ç”¨ç‚¹æ€»ç»“**

ä»ä»£ç åˆ†æä¸­ï¼Œå‘ç°äº†ä»¥ä¸‹å…³é”®ä½¿ç”¨ç‚¹ï¼š

#### **A. ç»„ä»¶å±‚é¢çš„ä½¿ç”¨**
- **UnifiedMediaLibrary.vue** (ç¬¬550è¡Œ)ï¼šè°ƒç”¨ `unifiedStore.startMediaProcessing(mediaItem)`

#### **B. æ¨¡å—å±‚é¢çš„ä½¿ç”¨**
- **UnifiedMediaModule.ts** (ç¬¬491è¡Œ)ï¼š`startMediaProcessing` å‡½æ•°å®ç°
- **UnifiedProjectModule.ts** (ç¬¬379è¡Œ)ï¼šé¡¹ç›®åŠ è½½æ—¶è°ƒç”¨ `startMediaProcessing`

#### **C. å­˜å‚¨å±‚é¢çš„ä½¿ç”¨**
- **unifiedStore.ts**ï¼šæš´éœ² `startMediaProcessing` æ¥å£

### 2. **å…·ä½“ä¿®æ”¹æŒ‡å¯¼**

#### **ä¿®æ”¹ç‚¹1ï¼šUnifiedMediaModule.ts çš„ startMediaProcessing å‡½æ•°**

**å½“å‰å®ç°**ï¼ˆç¬¬491-528è¡Œï¼‰ï¼š
```typescript
function startMediaProcessing(mediaItem: UnifiedMediaItemData) {
  // ç›‘å¬æ•°æ®æºçŠ¶æ€å˜åŒ–
  const unwatch = watch(
    () => mediaItem.source.status,
    (newStatus, oldStatus) => {
      handleSourceStatusChange(mediaItem, newStatus, oldStatus)
      // ...
    },
    { immediate: true }
  )

  // å¼€å§‹æ•°æ®æºè·å–
  import('@/unified/managers/DataSourceManagerRegistry')
    .then(({ startDataSourceAcquisition }) => {
      const success = startDataSourceAcquisition(mediaItem.source)
      // ...
    })
}
```

**éœ€è¦ä¿®æ”¹ä¸º**ï¼š
```typescript
function startMediaProcessing(mediaItem: UnifiedMediaItemData) {
  console.log(`ğŸš€ [UnifiedMediaModule] å¼€å§‹å¤„ç†åª’ä½“é¡¹ç›®: ${mediaItem.name}`)

  // ğŸ†• æ–°æ¶æ„ï¼šç›´æ¥åœ¨UnifiedMediaItemDataå±‚é¢ç®¡ç†çŠ¶æ€æœº
  // ä¸å†ç›‘å¬æ•°æ®æºçŠ¶æ€ï¼Œè€Œæ˜¯è®©æ•°æ®æºç®¡ç†å™¨ç›´æ¥æ›´æ–°åª’ä½“çŠ¶æ€

  // å¯¼å…¥å¹¶ä½¿ç”¨æ•°æ®æºç®¡ç†å™¨æ³¨å†Œä¸­å¿ƒ
  import('@/unified/managers/DataSourceManagerRegistry')
    .then(({ startDataSourceAcquisition }) => {
      // ğŸ†• ä¼ å…¥åª’ä½“é¡¹ç›®è€Œä¸æ˜¯æ•°æ®æºï¼Œè®©ç®¡ç†å™¨ç›´æ¥æ“ä½œåª’ä½“çŠ¶æ€
      const success = startDataSourceAcquisition(mediaItem) // æ³¨æ„ï¼šä¼ å…¥æ•´ä¸ªmediaItem
      if (success) {
        console.log(`âœ… [UnifiedMediaModule] åª’ä½“å¤„ç†ä»»åŠ¡å·²å¯åŠ¨: ${mediaItem.name}`)
      } else {
        console.error(`âŒ [UnifiedMediaModule] åª’ä½“å¤„ç†ä»»åŠ¡å¯åŠ¨å¤±è´¥: ${mediaItem.name}`)
        // ç›´æ¥è®¾ç½®åª’ä½“é¡¹ç›®ä¸ºé”™è¯¯çŠ¶æ€
        UnifiedMediaItemActions.transitionTo(mediaItem, 'error')
      }
    })
    .catch((error) => {
      console.error(`âŒ [UnifiedMediaModule] å¯¼å…¥æ•°æ®æºç®¡ç†å™¨å¤±è´¥: ${mediaItem.name}`, error)
      UnifiedMediaItemActions.transitionTo(mediaItem, 'error')
    })
}
```

#### **ä¿®æ”¹ç‚¹2ï¼šéœ€è¦åˆ é™¤çš„å‡½æ•°**

**åˆ é™¤ handleSourceStatusChange å‡½æ•°**ï¼ˆç¬¬435-485è¡Œï¼‰ï¼š
```typescript
// âŒ è¿™ä¸ªå‡½æ•°éœ€è¦å®Œå…¨åˆ é™¤ï¼Œå› ä¸ºæ–°æ¶æ„ä¸­æ•°æ®æºç®¡ç†å™¨ç›´æ¥æ“ä½œåª’ä½“çŠ¶æ€
function handleSourceStatusChange(
  mediaItem: UnifiedMediaItemData,
  newSourceStatus: string,
  oldSourceStatus?: string,
) {
  // æ•´ä¸ªå‡½æ•°åˆ é™¤
}
```

#### **ä¿®æ”¹ç‚¹3ï¼šæ•°æ®æºç®¡ç†å™¨æ³¨å†Œä¸­å¿ƒæ¥å£ä¿®æ”¹**

**DataSourceManagerRegistry.ts çš„ startDataSourceAcquisition å‡½æ•°**éœ€è¦ä¿®æ”¹ï¼š

**å½“å‰æ¥å£**ï¼š
```typescript
export function startDataSourceAcquisition(source: UnifiedDataSourceData): boolean
```

**éœ€è¦ä¿®æ”¹ä¸º**ï¼š
```typescript
export function startDataSourceAcquisition(mediaItem: UnifiedMediaItemData): boolean {
  const source = mediaItem.source
  
  // æ ¹æ®æ•°æ®æºç±»å‹é€‰æ‹©ç®¡ç†å™¨
  if (DataSourceQueries.isUserSelectedSource(source)) {
    const manager = new UserSelectedFileManager()
    // ğŸ†• ä¼ å…¥æ•´ä¸ªåª’ä½“é¡¹ç›®ï¼Œè®©ç®¡ç†å™¨ç›´æ¥æ“ä½œåª’ä½“çŠ¶æ€
    return manager.startProcessing(mediaItem)
  } else if (DataSourceQueries.isRemoteSource(source)) {
    const manager = new RemoteFileManager()
    // ğŸ†• ä¼ å…¥æ•´ä¸ªåª’ä½“é¡¹ç›®ï¼Œè®©ç®¡ç†å™¨ç›´æ¥æ“ä½œåª’ä½“çŠ¶æ€
    return manager.startProcessing(mediaItem)
  }
  
  return false
}
```

#### **ä¿®æ”¹ç‚¹4ï¼šæ•°æ®æºç®¡ç†å™¨åŸºç±»ä¿®æ”¹**

**BaseDataSourceManager.ts** éœ€è¦ä¿®æ”¹æ¥å£ï¼š

**å½“å‰æ¥å£**ï¼š
```typescript
abstract class BaseDataSourceManager<T extends UnifiedDataSourceData> {
  abstract startProcessing(source: T): boolean
}
```

**éœ€è¦ä¿®æ”¹ä¸º**ï¼š
```typescript
abstract class BaseDataSourceManager<T extends UnifiedDataSourceData> {
  // ğŸ†• æ–°æ¥å£ï¼šç›´æ¥æ“ä½œåª’ä½“é¡¹ç›®
  abstract startProcessing(mediaItem: UnifiedMediaItemData): boolean
  
  // ğŸ†• æ–°å¢ï¼šç›´æ¥æ›´æ–°åª’ä½“çŠ¶æ€çš„è¾…åŠ©æ–¹æ³•
  protected updateMediaStatus(mediaItem: UnifiedMediaItemData, status: MediaStatus): void {
    UnifiedMediaItemActions.transitionTo(mediaItem, status)
  }
  
  // ğŸ†• æ–°å¢ï¼šå¯åŠ¨WebAVå¤„ç†çš„è¾…åŠ©æ–¹æ³•
  protected startWebAVProcessing(mediaItem: UnifiedMediaItemData): void {
    // è°ƒç”¨UnifiedMediaModuleçš„WebAVå¤„ç†æ–¹æ³•
    // è¿™é‡Œéœ€è¦é€šè¿‡æŸç§æ–¹å¼è®¿é—®åˆ°WebAVå¤„ç†å‡½æ•°
  }
}
```

#### **ä¿®æ”¹ç‚¹5ï¼šå…·ä½“ç®¡ç†å™¨å®ç°ä¿®æ”¹**

**UserSelectedFileManager.ts** å’Œ **RemoteFileManager.ts** éœ€è¦ä¿®æ”¹ï¼š

**å½“å‰å®ç°æ¨¡å¼**ï¼š
```typescript
class UserSelectedFileManager extends BaseDataSourceManager<UserSelectedFileSource> {
  startProcessing(source: UserSelectedFileSource): boolean {
    // æ›´æ–°æ•°æ®æºçŠ¶æ€
    source.status = 'acquiring'
    // ...
  }
}
```

**éœ€è¦ä¿®æ”¹ä¸º**ï¼š
```typescript
class UserSelectedFileManager extends BaseDataSourceManager<UserSelectedFileSource> {
  startProcessing(mediaItem: UnifiedMediaItemData): boolean {
    const source = mediaItem.source as UserSelectedFileSource
    
    // ğŸ†• ç›´æ¥æ›´æ–°åª’ä½“çŠ¶æ€è€Œä¸æ˜¯æ•°æ®æºçŠ¶æ€
    this.updateMediaStatus(mediaItem, 'asyncprocessing')
    
    // å¤„ç†æ–‡ä»¶è·å–
    this.processFile(mediaItem)
      .then(() => {
        // ğŸ†• ç›´æ¥è½¬æ¢åˆ°WebAVè§£æçŠ¶æ€
        this.updateMediaStatus(mediaItem, 'webavdecoding')
        // ğŸ†• å¯åŠ¨WebAVå¤„ç†
        this.startWebAVProcessing(mediaItem)
      })
      .catch((error) => {
        // ğŸ†• ç›´æ¥è®¾ç½®é”™è¯¯çŠ¶æ€
        this.updateMediaStatus(mediaItem, 'error')
      })
    
    return true
  }
  
  private async processFile(mediaItem: UnifiedMediaItemData): Promise<void> {
    const source = mediaItem.source as UserSelectedFileSource
    // æ–‡ä»¶å¤„ç†é€»è¾‘...
    // æ›´æ–°æ•°æ®æºçš„fileå’Œurlå±æ€§
    source.file = processedFile
    source.url = processedUrl
  }
}
```

### 3. **è°ƒç”¨ç‚¹æ— éœ€ä¿®æ”¹**

ä»¥ä¸‹è°ƒç”¨ç‚¹**æ— éœ€ä¿®æ”¹**ï¼Œå› ä¸ºæ¥å£ä¿æŒä¸€è‡´ï¼š

- **UnifiedMediaLibrary.vue** ç¬¬550è¡Œï¼š`unifiedStore.startMediaProcessing(mediaItem)`
- **UnifiedProjectModule.ts** ç¬¬379è¡Œï¼š`mediaModule.startMediaProcessing(mediaItem)`
- **unifiedStore.ts**ï¼šæš´éœ²çš„æ¥å£ä¿æŒä¸å˜

### 4. **è¿ç§»æ­¥éª¤å»ºè®®**

1. **ç¬¬ä¸€æ­¥**ï¼šä¿®æ”¹ `BaseDataSourceManager` åŸºç±»æ¥å£
2. **ç¬¬äºŒæ­¥**ï¼šä¿®æ”¹å…·ä½“çš„ç®¡ç†å™¨å®ç°ï¼ˆ`UserSelectedFileManager`ã€`RemoteFileManager`ï¼‰
3. **ç¬¬ä¸‰æ­¥**ï¼šä¿®æ”¹ `DataSourceManagerRegistry` çš„æ¥å£
4. **ç¬¬å››æ­¥**ï¼šä¿®æ”¹ `UnifiedMediaModule` çš„ `startMediaProcessing` å‡½æ•°
5. **ç¬¬äº”æ­¥**ï¼šåˆ é™¤ä¸å†éœ€è¦çš„ `handleSourceStatusChange` å‡½æ•°
6. **ç¬¬å…­æ­¥**ï¼šæµ‹è¯•éªŒè¯æ–°çš„çŠ¶æ€ç®¡ç†æµç¨‹

### 5. **å…³é”®ä¼˜åŠ¿**

é€šè¿‡è¿™äº›ä¿®æ”¹ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- âœ… **æ¶ˆé™¤åŒé‡çŠ¶æ€ç®¡ç†**ï¼šåªåœ¨ `UnifiedMediaItemData.mediaStatus` å±‚é¢ç®¡ç†çŠ¶æ€
- âœ… **ç®€åŒ–çŠ¶æ€åŒæ­¥**ï¼šæ•°æ®æºç®¡ç†å™¨ç›´æ¥æ“ä½œåª’ä½“çŠ¶æ€ï¼Œæ— éœ€åŒæ­¥
- âœ… **ä¿æŒæ¥å£å…¼å®¹**ï¼šå¤–éƒ¨è°ƒç”¨ç‚¹æ— éœ€ä¿®æ”¹
- âœ… **æé«˜å¯ç»´æŠ¤æ€§**ï¼šçŠ¶æ€ç®¡ç†é€»è¾‘æ›´åŠ æ¸…æ™°å’Œé›†ä¸­

## æ€»ç»“

è¿™ä¸ªé‡æ„æ–¹æ¡ˆé€šè¿‡**æå‡æ•°æ®æºç®¡ç†å™¨çš„ç®¡ç†å±‚çº§**ï¼Œè®©å…¶ç›´æ¥ç®¡ç†UnifiedMediaItemDataï¼Œä»è€Œæ¶ˆé™¤äº†åŒé‡çŠ¶æ€ç®¡ç†çš„å¤æ‚æ€§ã€‚æ–°æ¶æ„å…·æœ‰æ›´å¥½çš„å†…èšæ€§ã€ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¿æŒäº†ç°æœ‰çš„ç±»å‹ç»“æ„ä¸å˜ï¼Œé™ä½äº†è¿ç§»æˆæœ¬ã€‚

é€šè¿‡åˆ†é˜¶æ®µçš„è¿ç§»ç­–ç•¥å’Œè¯¦ç»†çš„ä¿®æ”¹æŒ‡å¯¼ï¼Œå¯ä»¥å®‰å…¨åœ°å®Œæˆè¿™æ¬¡é‡æ„ï¼Œæœ€ç»ˆå®ç°æ›´ç®€æ´ã€æ›´å¯é çš„åª’ä½“é¡¹ç›®ç®¡ç†æ¶æ„ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**åˆ›å»ºæ—¥æœŸ**: 2025-01-20
**æœ€åæ›´æ–°**: 2025-01-20
**ä½œè€…**: Kilo Code
**æ›´æ–°è¯´æ˜**: ç®€åŒ–æ–¹æ¡ˆï¼Œç›´æ¥ä¿®æ”¹ç°æœ‰ç®¡ç†å™¨è€Œéåˆ›å»ºå¢å¼ºç‰ˆ