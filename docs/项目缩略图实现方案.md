
# 项目缩略图实现方案

## 1. 需求概述

实现项目的缩略图功能，满足以下要求：
- 使用约定的文件命名规则，`UnifiedProjectConfig` 中的 `thumbnail` 字段作为可选字段承载缩略图的blob url，但在保存项目配置时需要排除该字段
- 异步执行但不等待筛选时间轴前排第一个视频或图像项目
- 取其第一帧作为整个项目的缩略图保存在用户本地文件夹
- 项目管理器通过约定的路径规则读取缩略图显示

## 2. 架构设计

### 2.1 整体架构

```
UnifiedProjectModule (保存触发)
    │
    └──▶ useProjectThumbnailService() (异步生成)
            │
            ├──▶ 源项目筛选功能
            ├──▶ 帧提取功能
            ├──▶ 图像处理功能
            ├──▶ 文件存储功能
            └──▶ 配置更新功能
```

### 2.2 文件存储结构

```
projects/
  └── {projectId}/
      ├── project.json          # 项目配置（不包含thumbnail字段）
      ├── content.json          # 项目内容
      └── thumbnails/           # 缩略图专用目录
          └── projectThumbnail.webp    # 高分辨率WebP格式缩略图（640x360）
```

## 3. 核心组件设计

### 3.1 useProjectThumbnailService (项目缩略图服务)

```typescript
// useProjectThumbnailService.ts
import type { UnifiedTimelineItemData, UnifiedMediaItemData } from '@/unified/types'

export function useProjectThumbnailService() {
  // 筛选时间轴项目
  const findThumbnailSource = (timelineItems: UnifiedTimelineItemData[]): UnifiedTimelineItemData | null => {
    // 按时间位置排序，取第一个视频或图像项目
    const visualItems = timelineItems
      .filter(item =>
        item.mediaType === 'video' ||
        item.mediaType === 'image'
      )
      .sort((a, b) =>
        a.timeRange.timelineStartTime - b.timeRange.timelineStartTime
      )
    
    return visualItems.length > 0 ? visualItems[0] : null
  }
  
  // 提取第一帧
  const extractFirstFrame = async (mediaItem: UnifiedMediaItemData): Promise<Blob> => {
    // 实现逻辑
  }
  
  // 处理图像
  const processThumbnail = async (imageBlob: Blob, options: ThumbnailOptions): Promise<Blob> => {
    // 实现逻辑
  }
  
  // 保存缩略图文件
  const saveThumbnail = async (projectId: string, imageBlob: Blob): Promise<string> => {
    // 实现逻辑
  }
  
  // 生成项目缩略图（异步）
  const generateProjectThumbnail = async (projectId: string, timelineItems: UnifiedTimelineItemData[]): Promise<string> => {
    try {
      // 1. 筛选源项目
      const sourceItem = findThumbnailSource(timelineItems)
      if (!sourceItem) {
        throw new ThumbnailError('没有找到可用的缩略图源', 'NO_SOURCE')
      }

      // 2. 获取媒体项目
      const mediaItem = mediaModule.getMediaItem(sourceItem.mediaItemId)
      if (!mediaItem) {
        throw new ThumbnailError('媒体项目不存在', 'NO_MEDIA_ITEM')
      }

      // 3. 提取第一帧
      const frameBlob = await extractFirstFrame(mediaItem)

      // 4. 处理图像（生成高分辨率WebP格式）
      const thumbnailBlob = await processThumbnail(frameBlob, {
        width: 640,
        height: 360,
        quality: 0.9,
        format: 'webp'
      })

      // 5. 保存文件
      const thumbnailPath = await saveThumbnail(projectId, thumbnailBlob)

      // 6. 使用约定的文件命名规则，无需更新项目配置
      // 缩略图文件已保存在约定的位置：projects/{projectId}/thumbnails/projectThumbnail.webp

      return 'thumbnails/projectThumbnail.webp'

    } catch (error) {
      // 错误处理：直接抛出异常，不生成降级缩略图
      throw error
    }
  }
  
  // 获取缩略图URL
  const getThumbnailUrl = async (projectId: string, thumbnailPath: string): Promise<string> => {
    // 实现逻辑
  }
  
  // 清理缩略图资源
  const cleanupThumbnails = async (projectId: string): Promise<void> => {
    // 实现逻辑
  }
  
  return {
    generateProjectThumbnail,
    getThumbnailUrl,
    cleanupThumbnails,
    findThumbnailSource,
    extractFirstFrame,
    processThumbnail,
    saveThumbnail
  }
}

interface ThumbnailOptions {
  width: number
  height: number
  quality: number
  format: 'webp'  // 只使用WebP格式
}

// 使用示例
// const thumbnailService = useProjectThumbnailService()
// await thumbnailService.generateProjectThumbnail(projectId, timelineItems)
```

## 4. 实现流程

### 4.1 配置保存阶段 (UnifiedProjectModule.ts)

```typescript
// 在 saveCurrentProject 方法中添加：
async function saveCurrentProject(options?: {
  configChanged?: boolean
  contentChanged?: boolean
}): Promise<void> {
  try {
    isSaving.value = true
    configModule.projectUpdatedAt.value = new Date().toISOString()

    // 构建项目配置（排除thumbnail字段，仅用于运行时承载blob url）
    let updatedProjectConfig: UnifiedProjectConfig | undefined
    if (configChanged) {
      updatedProjectConfig = {
        // ... 其他配置
        // 注意：保存时需要排除 thumbnail 字段（仅用于运行时承载blob url）
        // ...
      }
    }

    // 保存项目
    await projectFileOperations.saveProject(
      configModule.projectId.value,
      updatedProjectConfig,
      updatedProjectContent,
      options
    )

    // 异步启动缩略图生成（不等待）
    if (configChanged) {
      setTimeout(() => {
        const thumbnailService = useProjectThumbnailService()
        thumbnailService.generateProjectThumbnail(
          configModule.projectId.value,
          timelineModule.timelineItems.value
        ).catch(error => {
          console.warn('缩略图生成失败:', error)
        })
      }, 0)
    }
  } catch (error) {
    // 错误处理
  } finally {
    isSaving.value = false
  }
}
```

### 4.2 缩略图生成阶段 (useProjectThumbnailService.ts)

// 缩略图生成逻辑已经在 useProjectThumbnailService 中实现
// 详见第3.1节 useProjectThumbnailService 函数

### 4.3 文件操作约定

// 文件保存逻辑已经在 useProjectThumbnailService 的 saveThumbnail 方法中实现
// 使用约定的文件命名规则，无需配置更新方法
// 缩略图始终保存在：projects/{projectId}/thumbnails/projectThumbnail.webp
// 所有项目都使用相同的相对路径，便于统一管理

### 4.4 缩略图显示集成

```typescript
// 在项目管理器组件中
async loadProjectThumbnail(projectId: string, projectName: string) {
  try {
    // 使用约定的路径规则获取缩略图
    // 约定：projects/{projectId}/thumbnails/projectThumbnail.webp
    const thumbnailService = useProjectThumbnailService()
    const thumbnailUrl = await thumbnailService.getThumbnailUrl(projectId)
    return thumbnailUrl
  } catch (error) {
    console.warn('加载缩略图失败:', error)
    throw error
  }
}

```

## 5. 错误处理

### 5.1 错误类型定义

```typescript
class ThumbnailError extends Error {
  constructor(
    message: string,
    public readonly code:
      | 'NO_SOURCE'          // 没有找到可用的源项目
      | 'EXTRACTION_FAILED'  // 帧提取失败
      | 'PROCESSING_FAILED'  // 图像处理失败
      | 'SAVE_FAILED'        // 文件保存失败
  ) {
    super(message)
    this.name = 'ThumbnailError'
  }
}
```

