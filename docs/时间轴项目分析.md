# æ—¶é—´è½´é¡¹ç›®å¤„ç†æµç¨‹åˆ†æ

## æ¦‚è¿°
æ—¶é—´è½´é¡¹ç›®çš„å¤„ç†åˆ†ä¸ºä¸¤ä¸ªä¸»è¦è·¯å¾„ï¼šreadyçŠ¶æ€çš„åª’ä½“å’ŒloadingçŠ¶æ€çš„åª’ä½“ã€‚æ¯ç§çŠ¶æ€éƒ½æœ‰ä¸åŒçš„å¤„ç†æµç¨‹å’ŒåŒæ­¥æœºåˆ¶ã€‚

## 1. ReadyçŠ¶æ€åª’ä½“çš„å¤„ç†æµç¨‹

### 1.1 é‡å»ºé˜¶æ®µ (rebuildKnown)
**å…¥å£**: [`TimelineItemFactory.rebuildKnown()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:646)

#### æ–‡æœ¬é¡¹ç›®å¤„ç†
- **å…‹éš†æ—¶é—´è½´é¡¹ç›®**: ä½¿ç”¨ [`cloneTimelineItem()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:431) åˆ›å»ºç‹¬ç«‹å‰¯æœ¬
- **åˆ›å»ºæ–‡æœ¬ç²¾çµ**: è°ƒç”¨ [`createSpriteForTextTimelineItem()`](frontend/src/unified/utils/textTimelineUtils.ts:250)
  - è·å–ç”»å¸ƒåˆ†è¾¨ç‡
  - åˆ›å»º [`TextVisibleSprite`](frontend/src/unified/visiblesprite/TextVisibleSprite.ts)
  - è®¾ç½®æ—¶é—´èŒƒå›´
  - åº”ç”¨åæ ‡è½¬æ¢ (é¡¹ç›®åæ ‡ç³» â†’ WebAVåæ ‡ç³»)
  - è®¾ç½®å°ºå¯¸ã€æ—‹è½¬ã€é€æ˜åº¦ã€å±‚çº§
- **å­˜å‚¨åˆ°runtime**: å°†ç²¾çµæ ‡è®°ä¸º [`markRaw()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:673) å¹¶å­˜å‚¨

#### éæ–‡æœ¬é¡¹ç›®å¤„ç†
- **è·å–åŸå§‹ç´ æ**: é€šè¿‡ [`getMediaItem()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:680) è·å–åª’ä½“æ•°æ®
- **éªŒè¯ç´ æçŠ¶æ€**: æ£€æŸ¥åª’ä½“ç±»å‹å’Œæ—¶é•¿ä¿¡æ¯
- **åˆ›å»ºç²¾çµ**: è°ƒç”¨ [`createSpriteFromUnifiedTimelineItem()`](frontend/src/unified/utils/spriteFactory.ts:295)
  - ä»åª’ä½“é¡¹ç›®åˆ›å»ºåŸºç¡€ç²¾çµ: [`createSpriteFromUnifiedMediaItem()`](frontend/src/unified/utils/spriteFactory.ts:58)
  - å…‹éš†WebAVå¯¹è±¡ (MP4Clip/ImgClip/AudioClip)
  - è®¾ç½®æ—¶é—´èŒƒå›´: [`setTimeRange()`](frontend/src/unified/utils/spriteFactory.ts:315)
  - åº”ç”¨å˜æ¢å±æ€§ (åæ ‡è½¬æ¢ã€å°ºå¯¸ã€æ—‹è½¬ã€é€æ˜åº¦)
  - è®¾ç½®zIndexå±‚çº§
- **é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾**: [`regenerateThumbnailForAddedItem()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:804)

### 1.2 æ·»åŠ é˜¶æ®µ (addTimelineItem)
**å…¥å£**: [`UnifiedTimelineModule.addTimelineItem()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:240)

#### ç²¾çµè®¾ç½® (setupTimelineItemSprite)
- **è½¨é“å±æ€§åŒæ­¥**:
  - è®¾ç½®å¯è§æ€§: `sprite.visible = track.isVisible`
  - è®¾ç½®é™éŸ³çŠ¶æ€: `sprite.setTrackMuted(track.isMuted)` (éŸ³é¢‘ç±»å‹)
- **åŠ¨ç”»é…ç½®åº”ç”¨**:
  - æ£€æŸ¥åŠ¨ç”»é…ç½®å­˜åœ¨æ€§
  - è°ƒç”¨ [`updateWebAVAnimation()`](frontend/src/unified/utils/webavAnimationManager.ts) åº”ç”¨å…³é”®å¸§
- **åŒå‘æ•°æ®åŒæ­¥**: [`setupBidirectionalSync()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:114)
  - ç›‘å¬ `propsChange` äº‹ä»¶
  - WebAV â†’ TimelineItem æ•°æ®æµ: ä½ç½®ã€å°ºå¯¸ã€æ—‹è½¬ã€é€æ˜åº¦ã€å±‚çº§
  - åæ ‡ç³»è½¬æ¢ (WebAVåæ ‡ç³» â†’ é¡¹ç›®åæ ‡ç³»)
- **åŠ å…¥WebAVç”»å¸ƒ**: [`webavModule.addSprite()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:232)

#### åŠ¨ç”»ç®¡ç†å™¨åˆå§‹åŒ–
- æ³¨å†Œåˆ°å…¨å±€åŠ¨ç”»ç®¡ç†å™¨: [`globalWebAVAnimationManager.addManager()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:258)

#### æ•°ç»„ç®¡ç†
- æ·»åŠ åˆ°æ—¶é—´è½´é¡¹ç›®æ•°ç»„: `timelineItems.value.push(timelineItem)`

## 2. LoadingçŠ¶æ€åª’ä½“çš„å¤„ç†æµç¨‹

### 2.1 é‡å»ºé˜¶æ®µ (rebuildKnown)
**å…¥å£**: [`TimelineItemFactory.rebuildKnown()`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:646)

- **åˆ›å»ºloadingçŠ¶æ€é¡¹ç›®**:
  - å…‹éš†åŸå§‹é…ç½®æ•°æ®
  - è®¾ç½® `timelineStatus: 'loading'`
  - æ¸…ç©ºruntimeå¯¹è±¡ (æš‚æ—¶æ²¡æœ‰sprite)
- **ä¿æŒåŸå§‹æ—¶é—´èŒƒå›´**: ä¸ä¿®æ”¹timeRangeé…ç½®

### 2.2 æ·»åŠ é˜¶æ®µ (addTimelineItem)
**å…¥å£**: [`UnifiedTimelineModule.addTimelineItem()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:240)

- **è·³è¿‡ç²¾çµè®¾ç½®**: loadingçŠ¶æ€ä¸æ‰§è¡ŒsetupTimelineItemSprite
- **ç›´æ¥åŠ å…¥æ•°ç»„**: `timelineItems.value.push(timelineItem)`

### 2.3 åª’ä½“åŒæ­¥è®¾ç½® (setupCommandMediaSync)
**å…¥å£**: [`setupCommandMediaSync()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:26)

#### åŒæ­¥ç›‘å¬å™¨è®¾ç½®
- **åª’ä½“çŠ¶æ€ç›‘å¬**: ç›‘å¬ `mediaItem.mediaStatus` å˜åŒ–
- **çŠ¶æ€è½¬æ¢å¤„ç†**:
  - `ready`: è°ƒç”¨ [`transitionTimelineItemToReady()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188)
  - `error/cancelled/missing`: è®¾ç½®æ—¶é—´è½´é¡¹ç›®ä¸ºerrorçŠ¶æ€
- **è‡ªåŠ¨æ¸…ç†**: è¾¾åˆ°ç»ˆæ€æ—¶è‡ªåŠ¨æ¸…ç†ç›‘å¬å™¨

#### çŠ¶æ€è½¬æ¢åˆ°Ready (transitionTimelineItemToReady)
**æ ¸å¿ƒå¤„ç†å‡½æ•°**: [`transitionTimelineItemToReady()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188)

##### å°ºå¯¸æ›´æ–° (updateTimelineItemDimensions)
- **è·å–åŸå§‹å°ºå¯¸**: [`UnifiedMediaItemQueries.getOriginalSize()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:319)
- **æ›´æ–°æ—¶é—´èŒƒå›´**:
  - ä½¿ç”¨åª’ä½“durationæ›´æ–° `timelineEndTime`
  - è®¾ç½® `clipStartTime: 0, clipEndTime: duration`
- **æ›´æ–°é…ç½®å°ºå¯¸**:
  - `config.width/height = originalSize.width/height`
  - `config.originalWidth/originalHeight = originalSize.width/height`

##### ç²¾çµåˆ›å»ºå’Œé…ç½®
- **åˆ›å»ºç²¾çµ**: [`createSpriteFromUnifiedMediaItem()`](frontend/src/unified/utils/spriteFactory.ts:58)
- **è®¾ç½®æ—¶é—´èŒƒå›´**: `sprite.setTimeRange(timelineItem.timeRange)`
- **åŠ å…¥WebAVç”»å¸ƒ**: [`addSpriteToCanvas()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:232)
- **åº”ç”¨åŠ¨ç”»é…ç½®**: å¦‚æœå­˜åœ¨åŠ¨ç”»ï¼Œè°ƒç”¨ [`updateWebAVAnimation()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:248)

##### ç¼©ç•¥å›¾ç”Ÿæˆ
- **è§†è§‰åª’ä½“æ£€æŸ¥**: [`UnifiedMediaItemQueries.isVisualMedia()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:265)
- **ç”Ÿæˆç¼©ç•¥å›¾**: [`regenerateThumbnailForUnifiedTimelineItem()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:268)
- **å­˜å‚¨åˆ°runtime**: `timelineItem.runtime.thumbnailUrl = thumbnailUrl`

##### æœ€ç»ˆè®¾ç½®
- **çŠ¶æ€æ›´æ–°**: `timelineItem.timelineStatus = 'ready'`
- **åŒå‘åŒæ­¥**: [`setupBidirectionalSync()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:294)
- **åŠ¨ç”»ç®¡ç†å™¨**: [`globalWebAVAnimationManager.addManager()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:297)

## 3. å…³é”®è®¾è®¡æ¨¡å¼

### 3.1 çŠ¶æ€ç®¡ç†
- **ä¸‰çŠ¶æ€ç³»ç»Ÿ**: `ready` | `loading` | `error`
- **çŠ¶æ€è½¬æ¢**: loading â†’ ready (é€šè¿‡åª’ä½“åŒæ­¥)
- **ç»ˆæ€å¤„ç†**: ready/errorçŠ¶æ€è‡ªåŠ¨æ¸…ç†ç›‘å¬å™¨

### 3.2 æ•°æ®æµå‘
- **UI â†’ WebAV â†’ TimelineItem**: åŠ¨ç”»å±æ€§ (ä½ç½®ã€å°ºå¯¸ã€æ—‹è½¬)
- **ç›´æ¥ä¿®æ”¹config**: éåŠ¨ç”»å±æ€§ (é€æ˜åº¦ã€éŸ³é‡ã€é™éŸ³)
- **åæ ‡ç³»è½¬æ¢**: é¡¹ç›®åæ ‡ç³» â†” WebAVåæ ‡ç³»

### 3.3 èµ„æºç®¡ç†
- **WebAVå¯¹è±¡å…‹éš†**: é¿å…å¤šä¸ªç²¾çµå…±äº«åŒä¸€ä¸ªClip
- **ç²¾çµç”Ÿå‘½å‘¨æœŸ**: åˆ›å»º â†’ é…ç½® â†’ åŠ å…¥ç”»å¸ƒ â†’ æ¸…ç†
- **ç›‘å¬å™¨æ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¾¾åˆ°ç»ˆæ€çš„ç›‘å¬å™¨

### 3.4 é”™è¯¯å¤„ç†
- **åˆ†å±‚é”™è¯¯å¤„ç†**: åª’ä½“å±‚é¢ + æ—¶é—´è½´å±‚é¢
- **çŠ¶æ€åŒæ­¥**: åª’ä½“é”™è¯¯ â†’ æ—¶é—´è½´é¡¹ç›®é”™è¯¯
- **èµ„æºæ¸…ç†**: å¼‚å¸¸æƒ…å†µä¸‹çš„èµ„æºé‡Šæ”¾

## 4. æ ¸å¿ƒæ–‡ä»¶ç»“æ„

- **å‘½ä»¤å±‚**: [`AddTimelineItemCommand.ts`](frontend/src/unified/modules/commands/AddTimelineItemCommand.ts) - æ’¤é”€/é‡åšæ”¯æŒ
- **å·¥å‚å±‚**: [`TimelineItemFactory.ts`](frontend/src/unified/timelineitem/TimelineItemFactory.ts) - é¡¹ç›®é‡å»ºé€»è¾‘
- **æ¨¡å—å±‚**: [`UnifiedTimelineModule.ts`](frontend/src/unified/modules/UnifiedTimelineModule.ts) - æ ¸å¿ƒç®¡ç†åŠŸèƒ½
- **å·¥å…·å±‚**:
  - [`spriteFactory.ts`](frontend/src/unified/utils/spriteFactory.ts) - ç²¾çµåˆ›å»º
  - [`textTimelineUtils.ts`](frontend/src/unified/utils/textTimelineUtils.ts) - æ–‡æœ¬å¤„ç†
  - [`commandMediaSyncUtils.ts`](frontend/src/unified/utils/commandMediaSyncUtils.ts) - çŠ¶æ€åŒæ­¥

## 5. ğŸš¨ å½“å‰æµç¨‹å­˜åœ¨çš„é—®é¢˜

### 5.1 **Spriteåˆ›å»ºå’Œå±æ€§è®¾ç½®çš„é‡å¤**

#### ReadyçŠ¶æ€åª’ä½“çš„é‡å¤è®¾ç½®ï¼š
- **ç¬¬ä¸€æ¬¡è®¾ç½®**ï¼šåœ¨ [`createSpriteFromUnifiedTimelineItem()`](frontend/src/unified/utils/spriteFactory.ts:295) ä¸­
  - è®¾ç½®æ—¶é—´èŒƒå›´ï¼š`newSprite.setTimeRange(timelineItemData.timeRange)`
  - è®¾ç½®å˜æ¢å±æ€§ï¼šä½ç½®ã€å°ºå¯¸ã€æ—‹è½¬ã€é€æ˜åº¦ã€zIndex
  - è¿›è¡Œåæ ‡è½¬æ¢

- **ç¬¬äºŒæ¬¡è®¾ç½®**ï¼šåœ¨ [`setupTimelineItemSprite()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:186) ä¸­
  - å†æ¬¡è®¾ç½®è½¨é“å±æ€§ï¼ˆå¯è§æ€§ã€é™éŸ³ï¼‰
  - å†æ¬¡åº”ç”¨åŠ¨ç”»é…ç½®
  - é‡å¤çš„åŒå‘åŒæ­¥è®¾ç½®

#### LoadingçŠ¶æ€åª’ä½“çš„é‡å¤è®¾ç½®ï¼š
- **ç¬¬ä¸€æ¬¡è®¾ç½®**ï¼šåœ¨ [`createSpriteFromUnifiedMediaItem()`](frontend/src/unified/utils/spriteFactory.ts:58) ä¸­åˆ›å»ºåŸºç¡€sprite
- **ç¬¬äºŒæ¬¡è®¾ç½®**ï¼šåœ¨ [`transitionTimelineItemToReady()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188) ä¸­
  - é‡æ–°è®¾ç½®æ—¶é—´èŒƒå›´ï¼š`sprite.setTimeRange(timelineItem.timeRange)`
  - é‡å¤åº”ç”¨åŠ¨ç”»é…ç½®
  - é‡å¤è®¾ç½®åŒå‘åŒæ­¥

### 5.2 **æ—¶é—´èŒƒå›´è®¾ç½®çš„æ··ä¹±é¡ºåº**

#### é—®é¢˜1ï¼šæ—¶é—´èŒƒå›´è¢«å¤šæ¬¡è¦†ç›–
```
åˆ›å»ºsprite â†’ è®¾ç½®åˆå§‹æ—¶é—´èŒƒå›´ â†’ æ›´æ–°å°ºå¯¸æ—¶ä¿®æ”¹æ—¶é—´èŒƒå›´ â†’ å†æ¬¡è®¾ç½®æ—¶é—´èŒƒå›´
```

#### é—®é¢˜2ï¼šå°ºå¯¸æ›´æ–°å’Œæ—¶é—´è®¾ç½®çš„ä¾èµ–å…³ç³»ä¸æ¸…æ™°
- [`updateTimelineItemDimensions()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:313) ä¼šä¿®æ”¹ `timeRange`
- ä½†ä¹‹ååˆä¼šè°ƒç”¨ `sprite.setTimeRange()` è¦†ç›–
- å¯¼è‡´æ—¶é—´è®¾ç½®é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹

### 5.3 **åæ ‡è½¬æ¢çš„é‡å¤è®¡ç®—**

#### ReadyçŠ¶æ€ï¼š
- [`createSpriteFromUnifiedTimelineItem()`](frontend/src/unified/utils/spriteFactory.ts:295) ä¸­è¿›è¡Œä¸€æ¬¡åæ ‡è½¬æ¢
- [`setupTimelineItemSprite()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:186) ä¸­å¯èƒ½å†æ¬¡è§¦å‘åæ ‡ç›¸å…³è®¡ç®—

#### LoadingçŠ¶æ€ï¼š
- [`createSpriteFromUnifiedMediaItem()`](frontend/src/unified/utils/spriteFactory.ts:58) åˆ›å»ºæ—¶çš„é»˜è®¤ä½ç½®
- [`transitionTimelineItemToReady()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188) ä¸­å¯èƒ½éœ€è¦é‡æ–°è®¡ç®—ä½ç½®

### 5.4 **åŠ¨ç”»é…ç½®åº”ç”¨çš„é‡å¤**

#### å¤šå¤„åº”ç”¨åŠ¨ç”»ï¼š
- [`setupTimelineItemSprite()`](frontend/src/unified/modules/UnifiedTimelineModule.ts:186) ä¸­åº”ç”¨ä¸€æ¬¡
- [`transitionTimelineItemToReady()`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188) ä¸­å†åº”ç”¨ä¸€æ¬¡
- ä¸¤æ¬¡è°ƒç”¨ [`updateWebAVAnimation()`](frontend/src/unified/utils/webavAnimationManager.ts) å¯èƒ½å¯¼è‡´å†²çª

### 5.5 **åŒå‘åŒæ­¥è®¾ç½®çš„æ—¶æœºé—®é¢˜**

#### é—®é¢˜ï¼šåŒæ­¥è®¾ç½®è¿‡æ—©
- åœ¨spriteå±æ€§è¿˜æœªå®Œå…¨é…ç½®å¥½æ—¶å°±è®¾ç½®äº†åŒå‘åŒæ­¥
- å¯èƒ½å¯¼è‡´åŒæ­¥äº‹ä»¶è§¦å‘æ—¶å±æ€§è¿˜ä¸å®Œæ•´
- åº”è¯¥åœ¨æ‰€æœ‰å±æ€§è®¾ç½®å®Œæˆåå†å¯ç”¨åŒæ­¥

### 5.6 **èµ„æºç®¡ç†çš„ä¸ä¸€è‡´**

#### WebAVå¯¹è±¡å…‹éš†æ—¶æœºï¼š
- ReadyçŠ¶æ€ï¼šåœ¨ `rebuildKnown` é˜¶æ®µå…‹éš†
- LoadingçŠ¶æ€ï¼šåœ¨ `transitionTimelineItemToReady` é˜¶æ®µå…‹éš†
- ä¸¤ä¸ªè·¯å¾„çš„èµ„æºç®¡ç†é€»è¾‘ä¸ç»Ÿä¸€

### 5.7 **ç¼©ç•¥å›¾ç”Ÿæˆçš„é‡å¤é€»è¾‘**

#### ä¸¤å¤„ç”Ÿæˆç¼©ç•¥å›¾ï¼š
- ReadyçŠ¶æ€ï¼šåœ¨ [`rebuildKnown`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:646) ä¸­ç”Ÿæˆ
- LoadingçŠ¶æ€ï¼šåœ¨ [`transitionTimelineItemToReady`](frontend/src/unified/utils/commandMediaSyncUtils.ts:188) ä¸­ç”Ÿæˆ
- ç›¸åŒçš„é€»è¾‘åœ¨ä¸¤ä¸ªåœ°æ–¹é‡å¤å®ç°

### 5.8 **é”™è¯¯å¤„ç†çš„ä¸ä¸€è‡´**

#### ä¸åŒè·¯å¾„çš„é”™è¯¯å¤„ç†ï¼š
- ReadyçŠ¶æ€çš„é”™è¯¯å¤„ç†åœ¨ [`rebuildKnown`](frontend/src/unified/timelineitem/TimelineItemFactory.ts:646) ä¸­
- LoadingçŠ¶æ€çš„é”™è¯¯å¤„ç†åˆ†æ•£åœ¨å¤šä¸ªå‡½æ•°ä¸­
- ç¼ºä¹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥

## 6. ğŸ¯ æ ¸å¿ƒé—®é¢˜æ€»ç»“

1. **èŒè´£åˆ†æ•£**ï¼šspriteçš„åˆ›å»ºã€é…ç½®ã€å±æ€§è®¾ç½®åˆ†æ•£åœ¨å¤šä¸ªå‡½æ•°ä¸­
2. **é‡å¤æ‰§è¡Œ**ï¼šç›¸åŒçš„æ“ä½œåœ¨ä¸åŒè·¯å¾„ä¸­é‡å¤æ‰§è¡Œ
3. **é¡ºåºæ··ä¹±**ï¼šå±æ€§è®¾ç½®çš„é¡ºåºä¸åˆç†ï¼Œå¯¼è‡´ç›¸äº’è¦†ç›–
4. **çŠ¶æ€ä¸ä¸€è‡´**ï¼šReadyå’ŒLoadingä¸¤ä¸ªè·¯å¾„çš„å¤„ç†é€»è¾‘å·®å¼‚è¿‡å¤§
5. **æ—¶æœºä¸å½“**ï¼šåŒå‘åŒæ­¥ç­‰åŠŸèƒ½å¯ç”¨æ—¶æœºä¸åˆé€‚

è¿™äº›é—®é¢˜å¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤ï¼Œæ€§èƒ½æµªè´¹ï¼Œå¹¶ä¸”å®¹æ˜“å‡ºç°çŠ¶æ€ä¸ä¸€è‡´çš„bugã€‚