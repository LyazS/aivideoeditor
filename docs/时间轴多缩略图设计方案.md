# æ—¶é—´è½´å¤šç¼©ç•¥å›¾è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–¹æ¡ˆæ—¨åœ¨ä¸ºè§†é¢‘ç¼–è¾‘å™¨çš„æ—¶é—´è½´clipå®ç°å¤šç¼©ç•¥å›¾æ˜¾ç¤ºåŠŸèƒ½ï¼Œç±»ä¼¼ä¼ ç»Ÿè§†é¢‘ç¼–è¾‘å™¨çš„æ•ˆæœã€‚å½“å‰ç³»ç»Ÿåªæ˜¾ç¤ºå•ä¸ªç¼©ç•¥å›¾ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€å¸§ï¼‰ï¼Œéœ€è¦æ‰©å±•ä¸ºåœ¨æ•´ä¸ªclipé•¿åº¦ä¸Šæ˜¾ç¤ºå¤šä¸ªæ—¶é—´ç‚¹çš„ç¼©ç•¥å›¾ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **è§†è§‰æ•ˆæœ**: å®ç°ä¼ ç»Ÿè§†é¢‘ç¼–è¾‘å™¨çš„å¤šç¼©ç•¥å›¾æ— ç¼é“¾æ¥é“ºæ»¡æ•ˆæœï¼ˆå›ºå®šå°ºå¯¸50x30ï¼Œæ— é—´è·ï¼‰
2. **æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½çš„æ‡’åŠ è½½å’Œç¼“å­˜æœºåˆ¶ï¼Œé¿å…æ€§èƒ½é—®é¢˜
3. **ç”¨æˆ·ä½“éªŒ**: å¹³æ»‘çš„æ»šåŠ¨å’Œç¼©æ”¾ä½“éªŒ
4. **å¯é…ç½®æ€§**: æ”¯æŒå›ºå®šå°ºå¯¸50x30çš„æ— ç¼é“¾æ¥æ˜¾ç¤ºï¼Œå¯è°ƒæ•´æ˜¾ç¤ºå¯†åº¦

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### é€‚ç”¨èŒƒå›´

**æœ¬æ–¹æ¡ˆä¸“é—¨é’ˆå¯¹è§†é¢‘å’Œå›¾ç‰‡ç±»å‹çš„timeline itemè®¾è®¡**ï¼Œä¸»è¦åº”ç”¨äº [`frontend/src/unified/components/renderers/VideoContent.vue`](frontend/src/unified/components/renderers/VideoContent.vue) ç»„ä»¶ã€‚

**æ”¯æŒçš„åª’ä½“ç±»å‹ï¼š**
- âœ… **è§†é¢‘ (video)**: æ”¯æŒå¤šæ—¶é—´ç‚¹ç¼©ç•¥å›¾ç”Ÿæˆ
- âœ… **å›¾ç‰‡ (image)**: å¯æ˜¾ç¤ºä¸åŒå¤„ç†çŠ¶æ€ï¼ˆå¦‚è£å‰ªã€æ»¤é•œæ•ˆæœç­‰ï¼‰
- âŒ **éŸ³é¢‘ (audio)**: ä¸éœ€è¦è§†è§‰ç¼©ç•¥å›¾
- âŒ **æ–‡æœ¬ (text)**: ä¸éœ€è¦è§†è§‰ç¼©ç•¥å›¾

### æ ¸å¿ƒç®—æ³•

#### 1. ç¼©ç•¥å›¾å¯†åº¦è®¡ç®—ç®—æ³•
```typescript
function calculateThumbnailDensity(
  clipDurationFrames: number,
  clipWidthPixels: number,
  scale: number,
  thumbnailWidth: number = 50,
  minSpacing: number = 0
): ThumbnailLayoutInfo {
  const availableWidth = clipWidthPixels;
  const maxThumbnails = Math.floor(availableWidth / thumbnailWidth);
  return Math.min(maxThumbnails, Math.ceil(clipDurationFrames / 300));
}
```

#### 2. å¯è§æ€§è®¡ç®—ç®—æ³•
```typescript
function calculateVisibleThumbnails(
  clipStartPixel: number,
  clipWidth: number,
  viewportStart: number,
  viewportWidth: number,
  thumbnailCount: number
): { startIndex: number; endIndex: number } {
  const clipEndPixel = clipStartPixel + clipWidth;
  const viewportEnd = viewportStart + viewportWidth;
  
  const visibleStart = Math.max(clipStartPixel, viewportStart);
  const visibleEnd = Math.min(clipEndPixel, viewportEnd);
  const visibleWidth = Math.max(0, visibleEnd - visibleStart);
  
  if (visibleWidth <= 0) {
    return { startIndex: -1, endIndex: -1 };
  }
  
  const thumbnailSpacing = clipWidth / thumbnailCount;
  const startIndex = Math.floor((visibleStart - clipStartPixel) / thumbnailSpacing);
  const endIndex = Math.ceil((visibleEnd - clipStartPixel) / thumbnailSpacing);
  
  return {
    startIndex: Math.max(0, startIndex),
    endIndex: Math.min(thumbnailCount - 1, endIndex)
  };
}
```

### ç»„ä»¶æ¶æ„

#### ä¸»è¦æ”¹é€ ï¼šVideoContentç»„ä»¶
æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯å¯¹ç°æœ‰çš„ [`frontend/src/unified/components/renderers/VideoContent.vue`](frontend/src/unified/components/renderers/VideoContent.vue) ç»„ä»¶è¿›è¡Œæ‰©å±•ï¼š

**æ”¹é€ ç­–ç•¥**:
- å½»åº•é‡æ„ä¸ºå¤šç¼©ç•¥å›¾æ˜¾ç¤ºæ¨¡å¼
- ç§»é™¤å•ç¼©ç•¥å›¾æ¨¡å¼çš„fallbacké€»è¾‘
- å¯¹å›¾ç‰‡ç±»å‹è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼ˆé™æ€å›¾ç‰‡å¯æ˜¾ç¤ºä¸åŒå¤„ç†çŠ¶æ€ï¼‰

#### ç¼©ç•¥å›¾ç¼“å­˜ç®¡ç†å™¨ (`ThumbnailCacheManager.ts`)
- **ç¼“å­˜ç»“æ„**: åŒå±‚Map: `timelineItemId -> (frame -> thumbnailUrl)`
- **ç¼“å­˜ç­–ç•¥**: LRUç®—æ³•ï¼Œé™åˆ¶æœ€å¤§ç¼“å­˜æ•°é‡
- **é˜Ÿåˆ—ç®¡ç†**: å¾…ç”Ÿæˆé˜Ÿåˆ—å’Œä¼˜å…ˆçº§è°ƒåº¦

#### åå°ç”ŸæˆæœåŠ¡
- ä½¿ç”¨Web Workerè¿›è¡Œå¼‚æ­¥å¤„ç†
- ä¼˜å…ˆçº§è°ƒåº¦: è§†å£å†… > é¢„åŠ è½½ > å…¶ä»–
- æ‰¹é‡å¤„ç†ä¼˜åŒ–

### æ–‡ä»¶ç»“æ„
```
frontend/src/unified/
â”œâ”€â”€ components/renderers/
â”‚   â””â”€â”€ VideoContent.vue                # æ‰©å±•ç°æœ‰ç»„ä»¶
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ ThumbnailCacheManager.ts        # ç¼“å­˜ç®¡ç†å™¨
â”‚   â”œâ”€â”€ thumbnailAlgorithms.ts          # æ ¸å¿ƒç®—æ³•
â”‚   â””â”€â”€ thumbnailTypes.ts               # ç±»å‹å®šä¹‰
â””â”€â”€ types/
    â””â”€â”€ thumbnail.ts                    # ç¼©ç•¥å›¾ç›¸å…³ç±»å‹å®šä¹‰
```

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. ç¼©ç•¥å›¾ç¼“å­˜ç®¡ç†å™¨
```typescript
class ThumbnailCacheManager {
  private cache = new Map<string, Map<number, string>>();
  private pendingGenerations = new Map<string, Set<number>>();
  private maxCacheSize = 1000;

  async getThumbnail(
    timelineItemId: string, 
    frame: number, 
    mediaItem: UnifiedMediaItemData
  ): Promise<string | null> {
    // æ£€æŸ¥ç¼“å­˜
    const itemCache = this.cache.get(timelineItemId);
    if (itemCache?.has(frame)) {
      return itemCache.get(frame)!;
    }
    
    // æ·»åŠ åˆ°ç”Ÿæˆé˜Ÿåˆ—
    this.addToGenerationQueue(timelineItemId, frame, mediaItem);
    return null;
  }

  private addToGenerationQueue(
    timelineItemId: string, 
    frame: number, 
    mediaItem: UnifiedMediaItemData
  ) {
    // å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ç®¡ç†
  }
}
```

### 2. å¤šç¼©ç•¥å›¾æ¸²æŸ“ç»„ä»¶æ¨¡æ¿
```vue
<template>
  <div class="video-content">
    <!-- å¤šç¼©ç•¥å›¾æ¨¡å¼ -->
    <div v-if="enableMultiThumbnails" class="multi-thumbnails-container">
      <div 
        v-for="(thumbnail, index) in thumbnailLayout" 
        :key="index"
        class="thumbnail-slot"
        :style="getThumbnailSlotStyle(thumbnail)"
      >
        <img 
          v-if="thumbnail.visible && getThumbnailUrl(index)"
          :src="getThumbnailUrl(index)"
          class="thumbnail-image"
          @load="onThumbnailLoad(index)"
          @error="onThumbnailError(index)"
        />
        <div v-else class="thumbnail-placeholder"></div>
      </div>
    </div>
    
    <!-- åŸæœ‰å•ç¼©ç•¥å›¾æ¨¡å¼ï¼ˆfallbackï¼‰ -->
    <div v-else class="single-thumbnail">
      <!-- ä¿æŒåŸæœ‰é€»è¾‘ -->
    </div>
    
    <!-- ä¿¡æ¯å åŠ å±‚ -->
    <div class="overlay-info" v-if="showOverlay">
      <div class="clip-name">{{ displayName }}</div>
      <div class="clip-duration">{{ formattedDuration }}</div>
    </div>
  </div>
</template>
```

### 3. é…ç½®ç³»ç»Ÿ
```typescript
interface ThumbnailConfig {
  width: number;                       // å›ºå®šå®½åº¦50px
  height: number;                      // å›ºå®šé«˜åº¦30px
  spacing: number;                     // é—´è·ï¼ˆæ— ç¼é“¾æ¥ä¸º0ï¼‰
  preloadRange: number;                // é¢„åŠ è½½èŒƒå›´ï¼ˆåƒç´ ï¼‰
  maxCacheSize: number;                // æœ€å¤§ç¼“å­˜æ•°é‡
  batchSize: number;                   // æ‰¹é‡å¤„ç†å¤§å°
}

const defaultConfig: ThumbnailConfig = {
  width: 50,
  height: 30,
  spacing: 0,
  preloadRange: 200,
  maxCacheSize: 1000,
  batchSize: 10
};
```

### 4. æ— ç¼é“¾æ¥å¸ƒå±€æ ·å¼
```css
.multi-thumbnails-container {
  position: relative;
  width: 100%;
  height: 30px;
  overflow: hidden;
}

.thumbnail-slot {
  position: absolute;
  width: 50px;
  height: 30px;
  top: 0;
  overflow: hidden;
}

.thumbnail-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-placeholder {
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.3);
}
```

## ğŸš€ å®æ–½è·¯çº¿å›¾

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„ï¼ˆ2-3å¤©ï¼‰
- [ ] å®ç°æ ¸å¿ƒç®—æ³•å·¥å…·å‡½æ•°
- [ ] åˆ›å»ºThumbnailCacheManageråŸºç¡€åŠŸèƒ½
- [ ] å®šä¹‰ç±»å‹å’Œé…ç½®æ¥å£

### é˜¶æ®µäºŒï¼šæ¸²æŸ“ç»„ä»¶ï¼ˆ3-4å¤©ï¼‰
- [ ] æ‰©å±•VideoContentç»„ä»¶æ”¯æŒå¤šç¼©ç•¥å›¾
- [ ] å®ç°å¯è§æ€§è®¡ç®—å’Œå ä½ç¬¦é€»è¾‘
- [ ] é›†æˆåˆ°ContentRendererFactory

### é˜¶æ®µä¸‰ï¼šåå°ç”Ÿæˆï¼ˆ2-3å¤©ï¼‰
- [ ] å®ç°Web Workeråå°ç”Ÿæˆ
- [ ] æ·»åŠ ä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶
- [ ] å®ç°æ‰¹é‡å¤„ç†ä¼˜åŒ–

### é˜¶æ®µå››ï¼šä¼˜åŒ–å®Œå–„ï¼ˆ1-2å¤©ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] å†…å­˜ç®¡ç†æ”¹è¿›
- [ ] é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ

## ğŸ“Š æ€§èƒ½

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- **å†…å­˜ç®¡ç†**: LRUç¼“å­˜ã€å°ºå¯¸é™åˆ¶ã€åŠæ—¶é‡Šæ”¾Blob URL
- **ç”Ÿæˆä¼˜åŒ–**: æ‰¹é‡å¤„ç†ã€ä¼˜å…ˆçº§è°ƒåº¦ã€æ‡’åŠ è½½
- **æ¸²æŸ“ä¼˜åŒ–**: è™šæ‹ŸåŒ–ã€å›ºå®šå°ºå¯¸å¸ƒå±€ã€é˜²æŠ–å¤„ç†

## ğŸ¯ ç¬¬ä¸€æ­¥å®éªŒè®¡åˆ’

### ç›®æ ‡
éªŒè¯æ ¸å¿ƒç®—æ³•çš„å¯è¡Œæ€§å¹¶å®ç°æœ€åŸºç¡€çš„å¤šç¼©ç•¥å›¾æ˜¾ç¤ºåŸå‹

### å…·ä½“ä»»åŠ¡

#### 1. æ ¸å¿ƒç®—æ³•å®ç°ï¼ˆ0.5å¤©ï¼‰
åˆ›å»º `frontend/src/unified/utils/thumbnailAlgorithms.ts` å’Œç›¸å…³ç±»å‹å®šä¹‰

**éªŒè¯ç‚¹ï¼š**
- [ ] ä¸åŒæ—¶é•¿çš„clipèƒ½å¤Ÿç”Ÿæˆåˆç†æ•°é‡çš„ç¼©ç•¥å›¾
- [ ] ç¼©æ”¾æ—¶ç¼©ç•¥å›¾æ•°é‡åŠ¨æ€è°ƒæ•´
- [ ] æœ€å°å®½åº¦clipä¹Ÿèƒ½æ­£ç¡®å¤„ç†

#### 2. ç»„ä»¶åŸå‹æ”¹é€ ï¼ˆ1å¤©ï¼‰
æ‰©å±•VideoContentç»„ä»¶ï¼Œæ·»åŠ å¤šç¼©ç•¥å›¾æ¨¡å¼å¼€å…³

**æ”¹é€ è¦ç‚¹ï¼š**
- [ ] å®ç°ç¼©ç•¥å›¾å¸ƒå±€è®¡ç®—é€»è¾‘
- [ ] æ˜¾ç¤ºå¸§ç´¢å¼•æ–‡æœ¬è€Œéå®é™…å›¾ç‰‡ï¼ˆç¬¬ä¸€æ­¥éªŒè¯ï¼‰
- [ ] ä¿æŒåŸæœ‰propså’Œäº‹ä»¶æ¥å£ä¸å˜

#### 3. éªŒè¯æµ‹è¯•ï¼ˆ0.5å¤©ï¼‰
- [ ] ç®—æ³•å•å…ƒæµ‹è¯•
- [ ] ç»„ä»¶é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½åˆæ­¥è¯„ä¼°

#### 4. æ–‡æ¡£æ›´æ–°ï¼ˆ0.5å¤©ï¼‰
æ›´æ–°æŠ€æœ¯æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜

### æˆåŠŸæ ‡å‡†
- [ ] ä¸¤ä¸ªæ ¸å¿ƒç®—æ³•åœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½äº§ç”Ÿåˆç†ç»“æœ
- [ ] åœ¨æ—¶é—´è½´ä¸­èƒ½çœ‹åˆ°å¸§ç´¢å¼•æ–‡æœ¬æŒ‰é¢„æœŸåˆ†å¸ƒ
- [ ] ç¼©æ”¾å’Œæ»šåŠ¨æ—¶æ˜¾ç¤ºå†…å®¹æ­£ç¡®æ›´æ–°

### é£é™©åº”å¯¹
- **ç®—æ³•å¤æ‚åº¦è¿‡é«˜**: æ·»åŠ è®¡ç®—ç»“æœç¼“å­˜
- **DOMå…ƒç´ è¿‡å¤š**: é™åˆ¶æœ€å¤§ç¼©ç•¥å›¾æ•°é‡ï¼Œè¶…å‡ºæ—¶é™çº§
- **ç»„ä»¶æ”¹åŠ¨è¿‡å¤§**: å½»åº•é‡æ„éœ€è¦å…¨é¢æµ‹è¯•

---

## ğŸ“ˆ é¢„æœŸæˆæœ

å®Œæˆæ­¤æ–¹æ¡ˆåï¼Œç³»ç»Ÿå°†å…·å¤‡ï¼š

- âœ… ä¼ ç»Ÿè§†é¢‘ç¼–è¾‘å™¨é£æ ¼çš„å¤šç¼©ç•¥å›¾æ— ç¼é“¾æ¥æ˜¾ç¤ºï¼ˆå›ºå®š50x30ï¼‰
- âœ… æ™ºèƒ½çš„æ‡’åŠ è½½å’Œç¼“å­˜æœºåˆ¶
- âœ… å¹³æ»‘çš„æ»šåŠ¨å’Œç¼©æ”¾ä½“éªŒ
- âœ… å¯é…ç½®çš„æ˜¾ç¤ºå¯†åº¦å’Œå›ºå®šå°ºå¯¸å¸ƒå±€
- âœ… è‰¯å¥½çš„æ€§èƒ½å’Œå†…å­˜ç®¡ç†

æ­¤æ–¹æ¡ˆåŸºäºç°æœ‰æ¶æ„è®¾è®¡ï¼Œå……åˆ†åˆ©ç”¨äº†å½“å‰çš„ç¼©ç•¥å›¾ç”ŸæˆåŸºç¡€è®¾æ–½ï¼Œé€šè¿‡åˆç†çš„ç®—æ³•è®¾è®¡å’Œæ¶æ„æ‰©å±•ï¼Œèƒ½å¤Ÿé«˜æ•ˆå®ç°å¤šç¼©ç•¥å›¾åŠŸèƒ½ã€‚