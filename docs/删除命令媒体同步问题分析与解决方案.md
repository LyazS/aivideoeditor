# åˆ é™¤å‘½ä»¤åª’ä½“åŒæ­¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

åœ¨å½“å‰çš„å®ç°ä¸­ï¼Œå½“åˆ é™¤ä¸€ä¸ªå¤„äºloadingçŠ¶æ€çš„æ—¶é—´è½´é¡¹ç›®æ—¶ï¼Œå¦‚æœè¯¥é¡¹ç›®çš„åª’ä½“é¡¹ç›®åç»­çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚ä»loadingå˜ä¸ºreadyï¼‰ï¼Œç”±äºæ—¶é—´è½´é¡¹ç›®å·²è¢«åˆ é™¤ï¼Œæ— æ³•æ¥æ”¶åˆ°çŠ¶æ€æ›´æ–°ï¼Œå¯¼è‡´å‘½ä»¤ä¸­ä¿å­˜çš„åŸå§‹æ•°æ®æ— æ³•åŒæ­¥æ›´æ–°ã€‚è¿™åœ¨æ’¤é”€åˆ é™¤æ“ä½œæ—¶ä¼šå¯¼è‡´é‡å»ºçš„é¡¹ç›®æ•°æ®ä¸ä¸€è‡´ã€‚

## å…³é”®æ´å¯Ÿ

é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š**loadingæ—¶é—´è½´é¡¹ç›®æ˜¯ä¸€ä¸ªå¾ˆå¹²å‡€çš„çŠ¶æ€**ã€‚è¿™æ„å‘³ç€ï¼š

1. **loadingæ—¶é—´è½´é¡¹ç›®æ²¡æœ‰å¤æ‚çš„ç‰¹æœ‰å±æ€§** - å®ƒä»¬åªæ˜¯åª’ä½“é¡¹ç›®åœ¨æ—¶é—´è½´ä¸Šçš„ä¸€ä¸ªå ä½ç¬¦
2. **loadingæ—¶é—´è½´é¡¹ç›®çš„ä¸»è¦ä¸ç¡®å®šä¿¡æ¯** - åªæœ‰åª’ä½“çš„åŸºæœ¬å±æ€§ï¼ˆå®½é«˜ã€æ—¶é•¿ï¼‰éœ€è¦ç­‰å¾…åª’ä½“åŠ è½½å®Œæˆ
3. **å…¶ä»–å±æ€§éƒ½æ˜¯åˆå§‹åŒ–å€¼** - ä½ç½®ã€æ—¶é—´ç­‰åŸºæœ¬ä¿¡æ¯åœ¨åˆ›å»ºæ—¶å°±å·²ç»ç¡®å®š

åŸºäºè¿™ä¸ªå…³é”®æ´å¯Ÿï¼Œæˆ‘ä»¬å¯ä»¥å¤§å¹…ç®€åŒ–åŒæ­¥å…³ç³»ï¼š**å‘½ä»¤çš„åŸå§‹æ•°æ®æ›´æ–°åªéœ€è¦ä»åª’ä½“é¡¹ç›®è·å–ï¼Œè€Œä¸éœ€è¦ä»æ—¶é—´è½´é¡¹ç›®è·å–ï¼ŒåŒæ­¥ä¹Ÿåªæ˜¯åŒæ­¥å‘½ä»¤ä¸åª’ä½“é¡¹ç›®å³å¯**ã€‚

## ç®€åŒ–æ–¹æ¡ˆï¼šç›´æ¥å‘½ä»¤-åª’ä½“åŒæ­¥

### 1. åˆ›å»ºç®€åŒ–çš„åª’ä½“åŒæ­¥ç®¡ç†å™¨

```typescript
// frontend/src/unified/timelineitem/SimplifiedMediaSyncManager.ts
import type { SimpleCommand } from '../modules/commands/types'

/**
 * ç®€åŒ–çš„åª’ä½“åŒæ­¥ç®¡ç†å™¨
 * åªç»´æŠ¤å‘½ä»¤ä¸åª’ä½“é¡¹ç›®ä¹‹é—´çš„åŒæ­¥å…³ç³»ï¼Œä¸æ¶‰åŠæ—¶é—´è½´é¡¹ç›®
 */
export class SimplifiedMediaSyncManager {
  private static instance: SimplifiedMediaSyncManager
  private commandMediaSyncMap = new Map<string, {
    commandId: string
    mediaItemId: string
    unwatch: () => void
  }>()

  static getInstance(): SimplifiedMediaSyncManager {
    if (!SimplifiedMediaSyncManager.instance) {
      SimplifiedMediaSyncManager.instance = new SimplifiedMediaSyncManager()
    }
    return SimplifiedMediaSyncManager.instance
  }

  /**
   * æ³¨å†Œå‘½ä»¤åª’ä½“åŒæ­¥ç›‘å¬å™¨
   * @param commandId å‘½ä»¤ID
   * @param mediaItemId åª’ä½“é¡¹ç›®ID
   * @param unwatch æ¸…ç†å‡½æ•°
   */
  /**
   * æ³¨å†Œå‘½ä»¤åª’ä½“åŒæ­¥ç›‘å¬å™¨
   * @param commandId å‘½ä»¤ID
   * @param mediaItemId åª’ä½“é¡¹ç›®ID
   * @param unwatch æ¸…ç†å‡½æ•°
   */
  registerCommandMediaSync(
    commandId: string,
    mediaItemId: string,
    unwatch: () => void
  ): void {
    const key = `${commandId}:${mediaItemId}`
    this.commandMediaSyncMap.set(key, {
      commandId,
      mediaItemId,
      unwatch
    })
    
    console.log(`ğŸ”— [SimplifiedMediaSyncManager] å·²æ³¨å†Œå‘½ä»¤åª’ä½“åŒæ­¥: ${commandId} <-> ${mediaItemId}`)
  }

  /**
   * æ¸…ç†æŒ‡å®šå‘½ä»¤çš„æ‰€æœ‰åª’ä½“åŒæ­¥ç›‘å¬
   * @param commandId å‘½ä»¤ID
   */
  cleanupCommandMediaSync(commandId: string): void {
    for (const [key, sync] of this.commandMediaSyncMap) {
      if (sync.commandId === commandId) {
        try {
          sync.unwatch()
          this.commandMediaSyncMap.delete(key)
          console.log(`ğŸ—‘ï¸ [SimplifiedMediaSyncManager] å·²æ¸…ç†å‘½ä»¤åª’ä½“åŒæ­¥: ${commandId}`)
        } catch (error) {
          console.error(`âŒ [SimplifiedMediaSyncManager] æ¸…ç†å‘½ä»¤åª’ä½“åŒæ­¥å¤±è´¥: ${commandId}`, error)
        }
      }
    }
  }

  /**
   * æ¸…ç†æŒ‡å®šåª’ä½“é¡¹ç›®çš„æ‰€æœ‰åŒæ­¥ç›‘å¬
   * @param mediaItemId åª’ä½“é¡¹ç›®ID
   */
  cleanupMediaItemSync(mediaItemId: string): void {
    for (const [key, sync] of this.commandMediaSyncMap) {
      if (sync.mediaItemId === mediaItemId) {
        try {
          sync.unwatch()
          this.commandMediaSyncMap.delete(key)
          console.log(`ğŸ—‘ï¸ [SimplifiedMediaSyncManager] å·²æ¸…ç†åª’ä½“é¡¹ç›®åŒæ­¥: ${mediaItemId}`)
        } catch (error) {
          console.error(`âŒ [SimplifiedMediaSyncManager] æ¸…ç†åª’ä½“é¡¹ç›®åŒæ­¥å¤±è´¥: ${mediaItemId}`, error)
        }
      }
    }
  }

  /**
   * æ¸…ç†æ‰€æœ‰åŒæ­¥ç›‘å¬
   */
  cleanup(): void {
    for (const [key, sync] of this.commandMediaSyncMap) {
      try {
        sync.unwatch()
      } catch (error) {
        console.error(`âŒ [SimplifiedMediaSyncManager] æ¸…ç†å‘½ä»¤åª’ä½“åŒæ­¥å¤±è´¥: ${key}`, error)
      }
    }
    this.commandMediaSyncMap.clear()
  }
}
```

### 3. ä¿®æ”¹ useTimelineMediaSync

```typescript
// frontend/src/unified/composables/useTimelineMediaSync.ts
import { SimplifiedMediaSyncManager } from '../timelineitem/SimplifiedMediaSyncManager'
import type { SimpleCommand } from '../modules/commands/types'

/**
 * è®¾ç½®å‘½ä»¤ä¸åª’ä½“é¡¹ç›®çš„ç›´æ¥åŒæ­¥
 * @param commandId å‘½ä»¤ID
 * @param mediaItem åª’ä½“é¡¹ç›®
 */
function setupCommandMediaSync(
  commandId: string,
  mediaItem: UnifiedMediaItemData
): boolean {
  try {
    // æ£€æŸ¥åª’ä½“é¡¹ç›®çŠ¶æ€ï¼Œåªæœ‰éreadyçŠ¶æ€æ‰éœ€è¦è®¾ç½®åŒæ­¥
    const isReady = UnifiedMediaItemQueries.isReady(mediaItem)
    const hasError = UnifiedMediaItemQueries.hasError(mediaItem)

    if (isReady) {
      console.log(`â­ï¸ [TimelineMediaSync] è·³è¿‡å‘½ä»¤åŒæ­¥è®¾ç½®ï¼Œåª’ä½“é¡¹ç›®å·²ç»ready: ${mediaItem.name}`, {
        commandId,
        mediaItemId: mediaItem.id,
      })
      return false
    }

    if (hasError) {
      console.log(`â­ï¸ [TimelineMediaSync] è·³è¿‡å‘½ä»¤åŒæ­¥è®¾ç½®ï¼Œåª’ä½“é¡¹ç›®æœ‰é”™è¯¯: ${mediaItem.name}`, {
        commandId,
        mediaItemId: mediaItem.id,
        mediaStatus: mediaItem.mediaStatus,
      })
      return false
    }

    // è®¾ç½®åª’ä½“çŠ¶æ€åŒæ­¥
    const unwatch = setupDirectMediaSync(commandId, mediaItem.id)

    if (unwatch) {
      console.log(`ğŸ”— [TimelineMediaSync] å·²ä¸ºå‘½ä»¤è®¾ç½®ç›´æ¥çŠ¶æ€åŒæ­¥: ${commandId} <-> ${mediaItem.id}`, {
        mediaName: mediaItem.name,
        mediaStatus: mediaItem.mediaStatus,
      })

      // æ³¨å†Œåˆ°SimplifiedMediaSyncManagerä¸­
      const syncManager = SimplifiedMediaSyncManager.getInstance()
      syncManager.registerCommandMediaSync(commandId, mediaItem.id, unwatch)
      
      console.log(`ğŸ’¾ [TimelineMediaSync] å·²æ³¨å†Œç›‘å¬å™¨åˆ°ç®€åŒ–åª’ä½“åŒæ­¥ç®¡ç†å™¨: ${commandId}`)
      
      return true
    } else {
      console.warn(`âš ï¸ [TimelineMediaSync] æ— æ³•ä¸ºå‘½ä»¤è®¾ç½®ç›´æ¥çŠ¶æ€åŒæ­¥: ${commandId} <-> ${mediaItem.id}`, {
        mediaName: mediaItem.name,
        mediaStatus: mediaItem.mediaStatus,
      })
      return false
    }
  } catch (error) {
    console.error(`âŒ [TimelineMediaSync] ä¸ºå‘½ä»¤è®¾ç½®ç›´æ¥çŠ¶æ€åŒæ­¥å¤±è´¥:`, {
      commandId,
      mediaItemId: mediaItem.id,
      error: error instanceof Error ? error.message : String(error),
    })
    return false
  }
}

/**
 * è®¾ç½®ç›´æ¥çš„åª’ä½“çŠ¶æ€åŒæ­¥
 * ä¸ä¾èµ–æ—¶é—´è½´é¡¹ç›®ï¼Œç›´æ¥åœ¨å‘½ä»¤å’Œåª’ä½“é¡¹ç›®ä¹‹é—´å»ºç«‹åŒæ­¥
 */
function setupDirectMediaSync(
  commandId: string,
  mediaItemId: string
): (() => void) | null {
  // å®ç°ç›´æ¥çš„åª’ä½“çŠ¶æ€åŒæ­¥é€»è¾‘
  // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„åª’ä½“çŠ¶æ€ç›‘å¬æœºåˆ¶æ¥å®ç°
  
  // ä¼ªä»£ç ç¤ºä¾‹ï¼š
  const mediaModule = useMediaModule()
  const commandModule = useCommandModule()
  
  const unwatch = mediaModule.watchMediaItem(mediaItemId, (updatedMedia) => {
    // ç›´æ¥æ›´æ–°å‘½ä»¤ä¸­ä¿å­˜çš„åª’ä½“æ•°æ®
    const command = commandModule.getCommand(commandId)
    if (command && !command.isDisposed) {
      command.updateMediaData(updatedMedia)
      console.log(`ğŸ”„ [TimelineMediaSync] å·²æ›´æ–°å‘½ä»¤åª’ä½“æ•°æ®: ${commandId} <- ${mediaItemId}`, {
        mediaName: updatedMedia.name,
        mediaStatus: updatedMedia.mediaStatus,
      })
    }
  })
  
  return unwatch
}

/**
 * æ¸…ç†å‘½ä»¤çš„æ‰€æœ‰åª’ä½“åŒæ­¥
 * @param commandId å‘½ä»¤ID
 */
function cleanupCommandMediaSync(commandId: string): void {
  try {
    const syncManager = SimplifiedMediaSyncManager.getInstance()
    syncManager.cleanupCommandMediaSync(commandId)
    
    console.log(`ğŸ—‘ï¸ [TimelineMediaSync] å·²æ¸…ç†å‘½ä»¤æ‰€æœ‰åª’ä½“åŒæ­¥: ${commandId}`)
  } catch (error) {
    console.error(`âŒ [TimelineMediaSync] æ¸…ç†å‘½ä»¤åª’ä½“åŒæ­¥å¤±è´¥:`, {
      commandId,
      error: error instanceof Error ? error.message : String(error),
    })
  }
}
```

### 4. ä¿®æ”¹ RemoveTimelineItemCommand

```typescript
// frontend/src/unified/modules/commands/RemoveTimelineItemCommand.ts
import { setupCommandMediaSync, cleanupCommandMediaSync } from '../../composables/useTimelineMediaSync'
import { SimplifiedMediaSyncManager } from '../../timelineitem/SimplifiedMediaSyncManager'

export class RemoveTimelineItemCommand implements SimpleCommand {
  // ... åŸæœ‰ä»£ç  ...
  
  private _isDisposed = false
  
  /**
   * æ‰§è¡Œå‘½ä»¤ï¼šåˆ é™¤æ—¶é—´è½´é¡¹ç›®
   */
  async execute(): Promise<void> {
    try {
      // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
      const existingItem = this.timelineModule.getTimelineItem(this.timelineItemId)
      if (!existingItem) {
        console.warn(`âš ï¸ æ—¶é—´è½´é¡¹ç›®ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ é™¤: ${this.timelineItemId}`)
        return
      }
      
      // è®¾ç½®åª’ä½“åŒæ­¥ï¼ˆåªé’ˆå¯¹loadingçŠ¶æ€çš„é¡¹ç›®ï¼‰
      if (existingItem.timelineStatus === 'loading') {
        const mediaItem = this.mediaModule.getMediaItem(existingItem.mediaItemId)
        if (mediaItem) {
          setupCommandMediaSync(this.id, mediaItem)
        }
      }
      
      // åˆ é™¤æ—¶é—´è½´é¡¹ç›®
      this.timelineModule.removeTimelineItem(this.timelineItemId)

      if (this.originalTimelineItemData && isKnownTimelineItem(this.originalTimelineItemData)) {
        const mediaItem = this.mediaModule.getMediaItem(this.originalTimelineItemData.mediaItemId)
        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å·²çŸ¥æ—¶é—´è½´é¡¹ç›®: ${mediaItem?.name || 'æœªçŸ¥ç´ æ'}`)
      }
    } catch (error) {
      const itemName = this.originalTimelineItemData?.mediaItemId || 'æœªçŸ¥é¡¹ç›®'
      console.error(`âŒ åˆ é™¤æ—¶é—´è½´é¡¹ç›®å¤±è´¥: ${itemName}`, error)
      throw error
    }
  }
  
  /**
   * æ’¤é”€å‘½ä»¤ï¼šé‡æ–°åˆ›å»ºæ—¶é—´è½´é¡¹ç›®
   */
  async undo(): Promise<void> {
    try {
      if (this.originalTimelineItemData && isKnownTimelineItem(this.originalTimelineItemData)) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æœ¬é¡¹ç›®
        if (this.originalTimelineItemData.mediaType === 'text') {
          // æ–‡æœ¬é¡¹ç›®ç‰¹æ®Šå¤„ç† - ä¸éœ€è¦åª’ä½“é¡¹ç›®
          console.log(`ğŸ”„ æ’¤é”€åˆ é™¤æ“ä½œï¼šé‡å»ºæ–‡æœ¬æ—¶é—´è½´é¡¹ç›®...`)

          const newTimelineItem = await this.rebuildTextTimelineItem()
          this.timelineModule.addTimelineItem(newTimelineItem)

          if (newTimelineItem.runtime.sprite) {
            await this.webavModule.addSprite(newTimelineItem.runtime.sprite)
          }

          const textConfig = this.originalTimelineItemData.config as TextMediaConfig
          console.log(`â†©ï¸ å·²æ’¤é”€åˆ é™¤æ–‡æœ¬æ—¶é—´è½´é¡¹ç›®: ${textConfig.text.substring(0, 20)}...`)
        } else {
          // å¸¸è§„åª’ä½“é¡¹ç›®æ’¤é”€é€»è¾‘
          console.log(`ğŸ”„ æ’¤é”€åˆ é™¤æ“ä½œï¼šé‡å»ºå·²çŸ¥æ—¶é—´è½´é¡¹ç›®...`)

          // ä»åŸå§‹ç´ æå’Œå‘½ä»¤ä¸­ä¿å­˜çš„æœ€æ–°åª’ä½“æ•°æ®é‡å»ºTimelineItem
          const newTimelineItem = await this.rebuildKnownTimelineItem()
          
          // 1. æ·»åŠ åˆ°æ—¶é—´è½´
          this.timelineModule.addTimelineItem(newTimelineItem)

          // 2. æ·»åŠ spriteåˆ°WebAVç”»å¸ƒ
          if (newTimelineItem.runtime.sprite) {
            await this.webavModule.addSprite(newTimelineItem.runtime.sprite)
          }

          // 3. å¦‚æœé¡¹ç›®ä»ç„¶æ˜¯loadingçŠ¶æ€ï¼Œé‡æ–°è®¾ç½®åª’ä½“åŒæ­¥
          if (newTimelineItem.timelineStatus === 'loading') {
            const mediaItem = this.mediaModule.getMediaItem(this.originalTimelineItemData.mediaItemId)
            if (mediaItem) {
              setupCommandMediaSync(this.id, mediaItem)
            }
          }

          const mediaItem = this.mediaModule.getMediaItem(this.originalTimelineItemData.mediaItemId)
          console.log(`â†©ï¸ å·²æ’¤é”€åˆ é™¤å·²çŸ¥æ—¶é—´è½´é¡¹ç›®: ${mediaItem?.name || 'æœªçŸ¥ç´ æ'}`)
        }
      } else {
        throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„æ—¶é—´è½´é¡¹ç›®æ•°æ®')
      }
    } catch (error) {
      const itemName = this.originalTimelineItemData?.mediaItemId || 'æœªçŸ¥é¡¹ç›®'
      console.error(`âŒ æ’¤é”€åˆ é™¤æ—¶é—´è½´é¡¹ç›®å¤±è´¥: ${itemName}`, error)
      throw error
    }
  }
  
  /**
   * æ›´æ–°åª’ä½“æ•°æ®ï¼ˆç”±åª’ä½“åŒæ­¥è°ƒç”¨ï¼‰
   * @param mediaData æœ€æ–°çš„åª’ä½“æ•°æ®
   */
  updateMediaData(mediaData: UnifiedMediaItemData): void {
    if (this.originalTimelineItemData && isKnownTimelineItem(this.originalTimelineItemData)) {
      // æ›´æ–°å‘½ä»¤ä¸­ä¿å­˜çš„åª’ä½“æ•°æ®
      // è¿™é‡Œåªæ›´æ–°éœ€è¦åŒæ­¥çš„åª’ä½“å±æ€§ï¼ˆå®½é«˜ã€æ—¶é•¿ç­‰ï¼‰
      const config = this.originalTimelineItemData.config as MediaConfig
      
      if (mediaData.width !== undefined && mediaData.height !== undefined) {
        config.width = mediaData.width
        config.height = mediaData.height
      }
      
      if (mediaData.duration !== undefined) {
        config.duration = mediaData.duration
      }
      
      console.log(`ğŸ”„ [RemoveTimelineItemCommand] å·²æ›´æ–°åª’ä½“æ•°æ®: ${this.id}`, {
        width: config.width,
        height: config.height,
        duration: config.duration,
      })
    }
  }
  
  /**
   * æ£€æŸ¥å‘½ä»¤æ˜¯å¦å·²è¢«æ¸…ç†
   */
  get isDisposed(): boolean {
    return this._isDisposed
  }
  
  /**
   * æ¸…ç†å‘½ä»¤æŒæœ‰çš„èµ„æº
   */
  dispose(): void {
    if (this._isDisposed) {
      return
    }
    
    this._isDisposed = true
    // æ¸…ç†åª’ä½“åŒæ­¥
    cleanupCommandMediaSync(this.id)
    console.log(`ğŸ—‘ï¸ [RemoveTimelineItemCommand] å‘½ä»¤èµ„æºå·²æ¸…ç†: ${this.id}`)
  }
}
```

### 5. ä¿®æ”¹å…¶ä»–éœ€è¦åª’ä½“åŒæ­¥çš„å‘½ä»¤

```typescript
// frontend/src/unified/modules/commands/AddTimelineItemCommand.ts
import { setupCommandMediaSync, cleanupCommandMediaSync } from '../../composables/useTimelineMediaSync'

export class AddTimelineItemCommand implements SimpleCommand {
  // ... åŸæœ‰ä»£ç  ...
  
  private _isDisposed = false
  
  /**
   * æ›´æ–°åª’ä½“æ•°æ®ï¼ˆç”±åª’ä½“åŒæ­¥è°ƒç”¨ï¼‰
   * @param mediaData æœ€æ–°çš„åª’ä½“æ•°æ®
   */
  updateMediaData(mediaData: UnifiedMediaItemData): void {
    if (this.originalTimelineItemData && isKnownTimelineItem(this.originalTimelineItemData)) {
      const config = this.originalTimelineItemData.config as MediaConfig
      
      if (mediaData.width !== undefined && mediaData.height !== undefined) {
        config.width = mediaData.width
        config.height = mediaData.height
      }
      
      if (mediaData.duration !== undefined) {
        config.duration = mediaData.duration
      }
      
      console.log(`ğŸ”„ [AddTimelineItemCommand] å·²æ›´æ–°åª’ä½“æ•°æ®: ${this.id}`, {
        width: config.width,
        height: config.height,
        duration: config.duration,
      })
    }
  }
  
  /**
   * æ£€æŸ¥å‘½ä»¤æ˜¯å¦å·²è¢«æ¸…ç†
   */
  get isDisposed(): boolean {
    return this._isDisposed
  }
  
  /**
   * æ¸…ç†å‘½ä»¤æŒæœ‰çš„èµ„æº
   */
  dispose(): void {
    if (this._isDisposed) {
      return
    }
    
    this._isDisposed = true
    // æ¸…ç†åª’ä½“åŒæ­¥
    cleanupCommandMediaSync(this.id)
    console.log(`ğŸ—‘ï¸ [AddTimelineItemCommand] å‘½ä»¤èµ„æºå·²æ¸…ç†: ${this.id}`)
  }
}
```

## æ¶æ„è®¾è®¡å›¾

```mermaid
graph TD
    A[å‘½ä»¤æ‰§è¡Œ] --> B[setupCommandMediaSync]
    B --> C{åª’ä½“é¡¹ç›®éœ€è¦åŒæ­¥?}
    C -->|æ˜¯| D[åˆ›å»ºç›´æ¥åª’ä½“åŒæ­¥ç›‘å¬]
    D --> E[è°ƒç”¨SimplifiedMediaSyncManager.registerCommandMediaSync]
    C -->|å¦| F[è·³è¿‡åª’ä½“åŒæ­¥]
    
    G[åª’ä½“é¡¹ç›®çŠ¶æ€å˜åŒ–] --> H[ç›´æ¥é€šçŸ¥å‘½ä»¤]
    H --> I[å‘½ä»¤æ›´æ–°åª’ä½“æ•°æ®]
    
    J[å‘½ä»¤å®Œæˆ/æ’¤é”€] --> K[è°ƒç”¨å‘½ä»¤.disposeæ–¹æ³•]
    K --> L[SimplifiedMediaSyncManager.cleanupCommandMediaSync]
    L --> M[æ‰§è¡Œunwatchæ¸…ç†]
    M --> N[ä»åŒæ­¥æ˜ å°„ä¸­ç§»é™¤]
    
    O[æ—¶é—´è½´é¡¹ç›®åˆ é™¤] --> P[ç›´æ¥åˆ é™¤é¡¹ç›®]
    P --> Q[å‘½ä»¤åª’ä½“åŒæ­¥ä¿æŒ]
    
    R[æ’¤é”€åˆ é™¤æ“ä½œ] --> S[é‡å»ºæ—¶é—´è½´é¡¹ç›®]
    S --> T[ä½¿ç”¨å‘½ä»¤ä¸­æœ€æ–°åª’ä½“æ•°æ®]
    T --> U[å¦‚éœ€è¦ï¼Œé‡æ–°è®¾ç½®åª’ä½“åŒæ­¥]
```

## æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•åœºæ™¯1ï¼šåˆ é™¤loadingé¡¹ç›®ååª’ä½“å˜ä¸ºready
1. æ·»åŠ ä¸€ä¸ªloadingçŠ¶æ€çš„åª’ä½“é¡¹ç›®åˆ°æ—¶é—´è½´
2. åˆ é™¤è¯¥æ—¶é—´è½´é¡¹ç›®
3. ç­‰å¾…åª’ä½“é¡¹ç›®åŠ è½½å®Œæˆå˜ä¸ºready
4. æ’¤é”€åˆ é™¤æ“ä½œ
5. éªŒè¯é‡å»ºçš„æ—¶é—´è½´é¡¹ç›®ä½¿ç”¨äº†æœ€æ–°çš„åª’ä½“æ•°æ®

### æµ‹è¯•åœºæ™¯2ï¼šåˆ é™¤loadingé¡¹ç›®ååª’ä½“å‡ºé”™
1. æ·»åŠ ä¸€ä¸ªloadingçŠ¶æ€çš„åª’ä½“é¡¹ç›®åˆ°æ—¶é—´è½´
2. åˆ é™¤è¯¥æ—¶é—´è½´é¡¹ç›®
3. æ¨¡æ‹Ÿåª’ä½“é¡¹ç›®åŠ è½½å‡ºé”™
4. æ’¤é”€åˆ é™¤æ“ä½œ
5. éªŒè¯é”™è¯¯å¤„ç†é€»è¾‘

### æµ‹è¯•åœºæ™¯3ï¼šå‘½ä»¤èµ„æºæ¸…ç†
1. æ·»åŠ ä¸€ä¸ªloadingçŠ¶æ€çš„åª’ä½“é¡¹ç›®åˆ°æ—¶é—´è½´
2. åˆ é™¤è¯¥æ—¶é—´è½´é¡¹ç›®
3. æ‰‹åŠ¨æ¸…ç†å‘½ä»¤èµ„æº
4. éªŒè¯åª’ä½“åŒæ­¥ç›‘å¬å™¨è¢«æ­£ç¡®æ¸…ç†

## æ€»ç»“

è¿™ä¸ªç®€åŒ–æ–¹æ¡ˆåŸºäºå…³é”®æ´å¯Ÿï¼š**loadingæ—¶é—´è½´é¡¹ç›®æ˜¯ä¸€ä¸ªå¾ˆå¹²å‡€çš„çŠ¶æ€**ï¼Œé€šè¿‡ç›´æ¥å»ºç«‹å‘½ä»¤ä¸åª’ä½“é¡¹ç›®ä¹‹é—´çš„åŒæ­¥å…³ç³»ï¼Œå¤§å¹…ç®€åŒ–äº†ç³»ç»Ÿæ¶æ„ã€‚

ä¸»è¦ä¼˜åŠ¿ï¼š

1. **æ¶æ„ç®€åŒ–** - åªéœ€è¦ç»´æŠ¤å‘½ä»¤ä¸åª’ä½“é¡¹ç›®ä¹‹é—´çš„å…³ç³»ï¼Œä¸æ¶‰åŠæ—¶é—´è½´é¡¹ç›®
2. **æ•°æ®æµæ¸…æ™°** - å‘½ä»¤ç›´æ¥ä»åª’ä½“é¡¹ç›®è·å–æœ€æ–°æ•°æ®ï¼Œå‡å°‘ä¸­é—´ç¯èŠ‚
3. **èµ„æºæ•ˆç‡** - é¿å…ç»´æŠ¤ä¸å¿…è¦çš„æ—¶é—´è½´é¡¹ç›®å¼•ç”¨ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨
4. **é€»è¾‘æ¸…æ™°** - loadingæ—¶é—´è½´é¡¹ç›®ä½œä¸ºç®€å•çš„å ä½ç¬¦ï¼Œåªå…³æ³¨åª’ä½“åŸºæœ¬å±æ€§çš„åŒæ­¥
5. **æ˜“äºç»´æŠ¤** - å‡å°‘äº†ç»„ä»¶é—´çš„è€¦åˆï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§
6. **æ¥å£é©±åŠ¨** - é€šè¿‡SimpleCommandæ¥å£å®šä¹‰æ ‡å‡†æ–¹æ³•ï¼Œé¿å…ä½¿ç”¨å¤æ‚çš„Mixinæ¨¡å¼

è¿™ä¸ªæ–¹æ¡ˆä¸ä»…è§£å†³äº†åˆ é™¤å‘½ä»¤çš„åª’ä½“åŒæ­¥é—®é¢˜ï¼Œè¿˜ä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›äº†ä¸€ä¸ªæ›´åŠ ç®€æ´å’Œé«˜æ•ˆçš„åª’ä½“åŒæ­¥æœºåˆ¶ã€‚é€šè¿‡ç›´æ¥åœ¨å‘½ä»¤ç±»ä¸­å®ç°SimpleCommandæ¥å£çš„æ–¹æ³•ï¼Œé¿å…äº†å¼•å…¥CommandMixinå¸¦æ¥çš„é¢å¤–å¤æ‚æ€§ã€‚