# 数据源扩展类型设计

## 概述

基于BaseDataSource基础抽象类，实现具体的数据源类型，包括用户选择文件、工程文件和远程文件三种核心类型。

## 具体数据源实现

### 1. 用户选择文件数据源

```typescript
/**
 * 用户选择文件数据源
 */
class UserSelectedFileSource extends BaseDataSource {
  constructor(
    private selectedFile: File,
    onUpdate?: (source: UserSelectedFileSource) => void
  ) {
    super(onUpdate)
  }

  getType(): string {
    return 'user-selected'
  }

  getSelectedFile(): File {
    return this.selectedFile
  }

  protected getManager(): DataSourceManager<BaseDataSource> {
    return UserSelectedFileManager.getInstance()
  }

  protected executeAcquisition(): void {
    this.getManager().startAcquisition(this, this.taskId!)
  }
}
```

### 2. 工程文件数据源

```typescript
/**
 * 工程文件数据源
 */
class ProjectFileSource extends BaseDataSource {
  constructor(
    private fileInfo: {
      filePath: string
      fileName: string
      fileSize?: number
      lastModified?: number
    },
    onUpdate?: (source: ProjectFileSource) => void
  ) {
    super(onUpdate)
  }

  getType(): string {
    return 'project-file'
  }

  getFileInfo() {
    return this.fileInfo
  }

  protected getManager(): DataSourceManager<BaseDataSource> {
    return ProjectFileManager.getInstance()
  }

  protected executeAcquisition(): void {
    this.getManager().startAcquisition(this, this.taskId!)
  }

  // 工程文件特有方法
  setMissing(message: string): void {
    this.status = 'missing'
    this.errorMessage = message
    this.notifyUpdate()
  }

  relocateFile(newFile: File): void {
    this.setAcquired(newFile, URL.createObjectURL(newFile))
  }

  private notifyUpdate(): void {
    this.onUpdate?.(this)
  }
}
```

### 3. 远程文件数据源

```typescript
/**
 * 远程文件数据源
 */
class RemoteFileSource extends BaseDataSource {
  private downloadedBytes: number = 0
  private totalBytes: number = 0
  private downloadSpeed?: string
  private startTime?: number

  constructor(
    private remoteUrl: string,
    private config: RemoteFileConfig = {},
    onUpdate?: (source: RemoteFileSource) => void
  ) {
    super(onUpdate)
  }

  getType(): string {
    return 'remote'
  }

  getRemoteUrl(): string {
    return this.remoteUrl
  }

  getConfig(): RemoteFileConfig {
    return this.config
  }

  getDownloadStats() {
    return {
      downloadedBytes: this.downloadedBytes,
      totalBytes: this.totalBytes,
      downloadSpeed: this.downloadSpeed,
      startTime: this.startTime
    }
  }

  protected getManager(): DataSourceManager<BaseDataSource> {
    return RemoteFileManager.getInstance()
  }

  protected executeAcquisition(): void {
    this.getManager().startAcquisition(this, this.taskId!)
  }

  // 远程文件特有方法
  updateDownloadProgress(progress: number, stats?: {
    downloadedBytes?: number
    totalBytes?: number
    downloadSpeed?: string
  }): void {
    this.updateProgress(progress)

    if (stats) {
      this.downloadedBytes = stats.downloadedBytes || this.downloadedBytes
      this.totalBytes = stats.totalBytes || this.totalBytes
      this.downloadSpeed = stats.downloadSpeed
    }
  }

  setDownloadStarted(): void {
    this.setAcquiring()
    this.startTime = Date.now()
  }

  protected reset(): void {
    super.reset()
    this.downloadedBytes = 0
    this.totalBytes = 0
    this.downloadSpeed = undefined
    this.startTime = undefined
  }
}

/**
 * 远程文件配置接口
 */
interface RemoteFileConfig {
  headers?: Record<string, string>
  timeout?: number
  retryCount?: number
  retryDelay?: number
}
```

## 联合类型定义

```typescript
/**
 * 数据源联合类型 - 统一的数据源接口
 * 这是媒体项目中 source 字段的类型定义
 *
 * 设计说明：
 * - 所有数据源都继承自 BaseDataSource，确保接口一致性
 * - 使用联合类型而非接口，提供更好的类型推断
 * - 通过 getType() 方法进行类型区分和类型守卫
 */
export type DataSource =
  | UserSelectedFileSource
  | ProjectFileSource
  | RemoteFileSource

/**
 * 数据源类型判断工具
 */
export const isUserSelectedSource = (source: DataSource): source is UserSelectedFileSource => {
  return source.getType() === 'user-selected'
}

export const isProjectFileSource = (source: DataSource): source is ProjectFileSource => {
  return source.getType() === 'project-file'
}

export const isRemoteSource = (source: DataSource): source is RemoteFileSource => {
  return source.getType() === 'remote'
}
```

## 扩展性设计

### 1. 云盘数据源（未来扩展）

```typescript
/**
 * 云盘数据源 - 云存储服务文件
 */
class CloudFileSource extends BaseDataSource {
  constructor(
    private provider: 'google-drive' | 'dropbox' | 'onedrive',
    private fileId: string,
    private auth: {
      accessToken: string
      refreshToken?: string
      expiresAt?: number
    },
    onUpdate?: (source: CloudFileSource) => void
  ) {
    super(onUpdate)
  }

  getType(): string { 
    return 'cloud' 
  }

  getProvider() {
    return this.provider
  }

  getFileId() {
    return this.fileId
  }

  getAuth() {
    return this.auth
  }

  protected getManager(): DataSourceManager<BaseDataSource> {
    return CloudFileManager.getInstance()
  }

  protected executeAcquisition(): void {
    this.getManager().startAcquisition(this, this.taskId!)
  }

  // 云盘特有方法
  refreshAuth(newAuth: typeof this.auth): void {
    this.auth = newAuth
  }
}
```

### 2. FTP数据源（未来扩展）

```typescript
/**
 * FTP数据源 - FTP服务器文件
 */
class FTPFileSource extends BaseDataSource {
  constructor(
    private host: string,
    private port: number,
    private path: string,
    private credentials: {
      username: string
      password: string
    },
    onUpdate?: (source: FTPFileSource) => void
  ) {
    super(onUpdate)
  }

  getType(): string { 
    return 'ftp' 
  }

  getConnectionInfo() {
    return {
      host: this.host,
      port: this.port,
      path: this.path
    }
  }

  getCredentials() {
    return this.credentials
  }

  protected getManager(): DataSourceManager<BaseDataSource> {
    return FTPFileManager.getInstance()
  }

  protected executeAcquisition(): void {
    this.getManager().startAcquisition(this, this.taskId!)
  }
}
```

## 设计特点

### 1. 场景区分清晰
- **用户选择文件**：直接验证File对象有效性
- **工程文件路径**：处理文件缺失和重新定位
- **远程文件**：支持下载进度和并发控制

### 2. 特有功能支持
- 每种数据源都有自己的特有方法和属性
- 保持基础接口的一致性
- 支持类型安全的特有功能访问

### 3. 扩展性强
- 新增数据源类型只需继承BaseDataSource
- 实现必要的抽象方法即可
- 支持插件化的数据源注册
