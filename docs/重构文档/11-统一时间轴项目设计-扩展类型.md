# ç»Ÿä¸€æ—¶é—´è½´é¡¹ç›®è®¾è®¡ - æ‰©å±•ç±»å‹å®šä¹‰

## çŠ¶æ€ä¸Šä¸‹æ–‡è®¾è®¡ - åŸºäºæ³›å‹çš„ç±»å‹å®‰å…¨è®¾è®¡

**é‡‡ç”¨åŸºäºæ³›å‹çš„ç±»å‹å®‰å…¨è®¾è®¡**ï¼Œæ—¢ä¿è¯ç±»å‹æé†’åˆå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§ï¼š

```typescript
// ==================== åŸºç¡€æ¥å£ ====================

/**
 * åŸºç¡€ Context æ¥å£
 */
interface BaseTimelineStatusContext {
  stage: string
  message: string
  timestamp?: number
}

/**
 * è¿›åº¦ç›¸å…³çš„æ‰©å±•æ¥å£
 */
interface ProgressExtension {
  progress: {
    percent: number        // 0-100
    detail?: string       // é¢å¤–æè¿°
  }
}

/**
 * é”™è¯¯ç›¸å…³çš„æ‰©å±•æ¥å£
 */
interface ErrorExtension {
  error: {
    code: string
    message: string
    recoverable: boolean
  }
}

// ==================== å…·ä½“çš„ Context ç±»å‹å®šä¹‰ ====================

/**
 * ä¸‹è½½ä¸Šä¸‹æ–‡
 */
interface DownloadContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'downloading'
  downloadSpeed?: string
  downloadedBytes?: number
  totalBytes?: number
}

/**
 * è§£æä¸Šä¸‹æ–‡
 */
interface ParseContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'parsing'
  currentStep?: string     // 'è§£æè§†é¢‘è½¨é“' | 'è§£æéŸ³é¢‘è½¨é“' ç­‰
  totalSteps?: number
}

/**
 * å¤„ç†ä¸Šä¸‹æ–‡
 */
interface ProcessingContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'processing'
  operation?: string       // 'thumbnail' | 'compress' | 'convert' ç­‰
}

/**
 * å°±ç»ªä¸Šä¸‹æ–‡
 */
interface ReadyContext extends BaseTimelineStatusContext {
  stage: 'ready'
  metadata?: {
    duration?: number
    resolution?: string
    format?: string
  }
}

/**
 * é”™è¯¯ä¸Šä¸‹æ–‡
 */
interface ErrorContext extends BaseTimelineStatusContext, ErrorExtension {
  stage: 'error'
}

/**
 * ç»Ÿä¸€çš„çŠ¶æ€ä¸Šä¸‹æ–‡è”åˆç±»å‹ - åŠ¨æ€çŠ¶æ€ä¿¡æ¯
 *
 * èŒè´£ï¼šæè¿°æ—¶é—´è½´é¡¹ç›®å½“å‰çš„è¿è¡ŒçŠ¶æ€å’Œè¿›åº¦ä¿¡æ¯
 * ç‰¹ç‚¹ï¼šé¢‘ç¹å˜åŒ–ï¼Œä¸»è¦ç”¨äºUIå±•ç¤ºå’ŒçŠ¶æ€ç®¡ç†ï¼Œé€šå¸¸ä¸æŒä¹…åŒ–
 *
 * ä¸ BasicTimelineConfig çš„åŒºåˆ«ï¼š
 * - BasicTimelineConfigï¼šé™æ€é…ç½®ï¼Œ"è¿™ä¸ªé¡¹ç›®æ˜¯ä»€ä¹ˆ"
 * - TimelineStatusContextï¼šåŠ¨æ€çŠ¶æ€ï¼Œ"è¿™ä¸ªé¡¹ç›®ç°åœ¨æ€ä¹ˆæ ·"
 */
type TimelineStatusContext =
  | DownloadContext
  | ParseContext
  | ProcessingContext
  | ReadyContext
  | ErrorContext
```

**ç±»å‹å®‰å…¨è®¾è®¡ä¼˜åŠ¿**ï¼š
- ğŸ¯ **å®Œæ•´çš„ç±»å‹å®‰å…¨**ï¼šæ¯ä¸ª stage éƒ½æœ‰å¯¹åº”çš„ç±»å‹å®šä¹‰
- ğŸ¯ **æ™ºèƒ½æç¤º**ï¼šIDE å¯ä»¥æ ¹æ® stage æä¾›å‡†ç¡®çš„å±æ€§æç¤º
- ğŸ¯ **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°ç±»å‹åªéœ€å®šä¹‰æ–°æ¥å£å¹¶æ›´æ–°è”åˆç±»å‹
- ğŸ¯ **å¤ç”¨æ€§å¥½**ï¼šé€šè¿‡ mixin æ¥å£ï¼ˆå¦‚ `ProgressExtension`ï¼‰å¤ç”¨é€šç”¨é€»è¾‘
- ğŸ¯ **å‘åå…¼å®¹**ï¼šå¯ä»¥é€æ­¥æ·»åŠ æ–°çš„ Context ç±»å‹è€Œä¸ç ´åç°æœ‰ä»£ç 
- ğŸ¯ **èŒè´£æ¸…æ™°**ï¼šé™æ€é…ç½®ä¸åŠ¨æ€çŠ¶æ€åˆ†ç¦»ï¼Œå„å¸å…¶èŒ

## ç±»å‹å®‰å…¨å·¥å…·å‡½æ•°

```typescript
/**
 * ç±»å‹å®ˆå«å’Œå·¥å…·å‡½æ•°
 */
export const TimelineContextUtils = {
  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºä¸‹è½½ä¸Šä¸‹æ–‡
   */
  isDownloading: (ctx: TimelineStatusContext): ctx is DownloadContext =>
    ctx.stage === 'downloading',

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºè§£æä¸Šä¸‹æ–‡
   */
  isParsing: (ctx: TimelineStatusContext): ctx is ParseContext =>
    ctx.stage === 'parsing',

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºå¤„ç†ä¸Šä¸‹æ–‡
   */
  isProcessing: (ctx: TimelineStatusContext): ctx is ProcessingContext =>
    ctx.stage === 'processing',

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰è¿›åº¦ä¿¡æ¯
   */
  hasProgress: (ctx: TimelineStatusContext): ctx is TimelineStatusContext & ProgressExtension =>
    'progress' in ctx,

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯çŠ¶æ€
   */
  hasError: (ctx: TimelineStatusContext): ctx is ErrorContext =>
    ctx.stage === 'error',

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºå°±ç»ªçŠ¶æ€
   */
  isReady: (ctx: TimelineStatusContext): ctx is ReadyContext =>
    ctx.stage === 'ready'
}
```

## é¢„å®šä¹‰çš„çŠ¶æ€ä¸Šä¸‹æ–‡æ¨¡æ¿

```typescript
/**
 * é¢„å®šä¹‰çš„çŠ¶æ€ä¸Šä¸‹æ–‡æ¨¡æ¿
 *
 * æä¾›å¸¸ç”¨åœºæ™¯çš„é»˜è®¤ä¸Šä¸‹æ–‡é…ç½®
 */
const TIMELINE_CONTEXT_TEMPLATES = {
  // ä¸‹è½½ç›¸å…³
  downloadStart: (): DownloadContext => ({
    stage: 'downloading',
    message: 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...',
    progress: { percent: 0 },
    timestamp: Date.now()
  }),

  downloadProgress: (percent: number, speed?: string): DownloadContext => ({
    stage: 'downloading',
    message: 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...',
    progress: { percent, detail: speed },
    downloadSpeed: speed,
    timestamp: Date.now()
  }),

  // è§£æç›¸å…³
  parseStart: (): ParseContext => ({
    stage: 'parsing',
    message: 'æ­£åœ¨è§£æåª’ä½“æ–‡ä»¶...',
    progress: { percent: 0 },
    timestamp: Date.now()
  }),

  parseProgress: (percent: number, step?: string): ParseContext => ({
    stage: 'parsing',
    message: 'æ­£åœ¨è§£æåª’ä½“æ–‡ä»¶...',
    progress: { percent, detail: step },
    currentStep: step,
    timestamp: Date.now()
  }),

  // å¤„ç†ç›¸å…³
  processingStart: (operation: string): ProcessingContext => ({
    stage: 'processing',
    message: `æ­£åœ¨${operation}...`,
    progress: { percent: 0 },
    operation,
    timestamp: Date.now()
  }),

  // å°±ç»ªçŠ¶æ€
  ready: (metadata?: ReadyContext['metadata']): ReadyContext => ({
    stage: 'ready',
    message: 'åª’ä½“å·²å°±ç»ª',
    metadata,
    timestamp: Date.now()
  }),

  // é”™è¯¯çŠ¶æ€
  error: (code: string, message: string, recoverable = true): ErrorContext => ({
    stage: 'error',
    message,
    error: { code, message, recoverable },
    timestamp: Date.now()
  }),

  // å¸¸è§é”™è¯¯
  fileNotFound: (originalPath?: string): ErrorContext => ({
    stage: 'error',
    message: 'æ–‡ä»¶ä¸å­˜åœ¨',
    error: {
      code: 'FILE_NOT_FOUND',
      message: originalPath ? `æ‰¾ä¸åˆ°æ–‡ä»¶: ${originalPath}` : 'æ‰¾ä¸åˆ°å…³è”çš„åª’ä½“æ–‡ä»¶',
      recoverable: true
    },
    timestamp: Date.now()
  }),

  parseError: (): ErrorContext => ({
    stage: 'error',
    message: 'æ— æ³•è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼',
    error: {
      code: 'PARSE_ERROR',
      message: 'è¯¥æ–‡ä»¶æ ¼å¼ä¸å—æ”¯æŒæˆ–æ–‡ä»¶å·²æŸå',
      recoverable: false
    },
    timestamp: Date.now()
  }),

  networkError: (): ErrorContext => ({
    stage: 'error',
    message: 'ç½‘ç»œè¿æ¥å¤±è´¥',
    error: {
      code: 'NETWORK_ERROR',
      message: 'ç½‘ç»œè¿æ¥é—®é¢˜å¯¼è‡´ä¸‹è½½å¤±è´¥',
      recoverable: true
    },
    timestamp: Date.now()
  })
}
```

## æ‰©å±•æ€§ç¤ºä¾‹

```typescript
/**
 * æ‰©å±•æ€§ç¤ºä¾‹ - æ·»åŠ æ–°çš„å¼‚æ­¥æ“ä½œç±»å‹
 */
interface AudioAnalysisContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'audio-analysis'
  analysisType?: 'waveform' | 'spectrum' | 'volume'
  sampleRate?: number
}

// æ›´æ–°è”åˆç±»å‹æ—¶åªéœ€æ·»åŠ æ–°ç±»å‹
// type TimelineStatusContext =
//   | DownloadContext
//   | ParseContext
//   | ProcessingContext
//   | AudioAnalysisContext  // æ–°å¢
//   | ReadyContext
//   | ErrorContext
```

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2025-01-18*
*åŸºäºé‡æ„æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*å…³è”æ–‡æ¡£ï¼š10-ç»Ÿä¸€æ—¶é—´è½´é¡¹ç›®è®¾è®¡-ç±»å‹è®¾è®¡-æ ¸å¿ƒæ¥å£.md*
