# 统一时间轴项目设计 - 扩展类型定义

## 状态上下文设计 - 基于泛型的类型安全设计

**采用基于泛型的类型安全设计**，既保证类型提醒又具备良好的扩展性：

```typescript
// ==================== 基础接口 ====================

/**
 * 基础 Context 接口
 */
interface BaseTimelineStatusContext {
  stage: string
  message: string
  timestamp?: number
}

/**
 * 进度相关的扩展接口
 */
interface ProgressExtension {
  progress: {
    percent: number        // 0-100
    detail?: string       // 额外描述
  }
}

/**
 * 错误相关的扩展接口
 */
interface ErrorExtension {
  error: {
    code: string
    message: string
    recoverable: boolean
  }
}

// ==================== 具体的 Context 类型定义 ====================

/**
 * 下载上下文
 */
interface DownloadContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'downloading'
  downloadSpeed?: string
  downloadedBytes?: number
  totalBytes?: number
}

/**
 * 解析上下文
 */
interface ParseContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'parsing'
  currentStep?: string     // '解析视频轨道' | '解析音频轨道' 等
  totalSteps?: number
}

/**
 * 处理上下文
 */
interface ProcessingContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'processing'
  operation?: string       // 'thumbnail' | 'compress' | 'convert' 等
}

/**
 * 就绪上下文
 */
interface ReadyContext extends BaseTimelineStatusContext {
  stage: 'ready'
  metadata?: {
    duration?: number
    resolution?: string
    format?: string
  }
}

/**
 * 错误上下文
 */
interface ErrorContext extends BaseTimelineStatusContext, ErrorExtension {
  stage: 'error'
}

/**
 * 统一的状态上下文联合类型 - 动态状态信息
 *
 * 职责：描述时间轴项目当前的运行状态和进度信息
 * 特点：频繁变化，主要用于UI展示和状态管理，通常不持久化
 *
 * 与 BasicTimelineConfig 的区别：
 * - BasicTimelineConfig：静态配置，"这个项目是什么"
 * - TimelineStatusContext：动态状态，"这个项目现在怎么样"
 */
type TimelineStatusContext =
  | DownloadContext
  | ParseContext
  | ProcessingContext
  | ReadyContext
  | ErrorContext
```

**类型安全设计优势**：
- 🎯 **完整的类型安全**：每个 stage 都有对应的类型定义
- 🎯 **智能提示**：IDE 可以根据 stage 提供准确的属性提示
- 🎯 **易于扩展**：添加新类型只需定义新接口并更新联合类型
- 🎯 **复用性好**：通过 mixin 接口（如 `ProgressExtension`）复用通用逻辑
- 🎯 **向后兼容**：可以逐步添加新的 Context 类型而不破坏现有代码
- 🎯 **职责清晰**：静态配置与动态状态分离，各司其职

## 类型安全工具函数

```typescript
/**
 * 类型守卫和工具函数
 */
export const TimelineContextUtils = {
  /**
   * 检查是否为下载上下文
   */
  isDownloading: (ctx: TimelineStatusContext): ctx is DownloadContext =>
    ctx.stage === 'downloading',

  /**
   * 检查是否为解析上下文
   */
  isParsing: (ctx: TimelineStatusContext): ctx is ParseContext =>
    ctx.stage === 'parsing',

  /**
   * 检查是否为处理上下文
   */
  isProcessing: (ctx: TimelineStatusContext): ctx is ProcessingContext =>
    ctx.stage === 'processing',

  /**
   * 检查是否有进度信息
   */
  hasProgress: (ctx: TimelineStatusContext): ctx is TimelineStatusContext & ProgressExtension =>
    'progress' in ctx,

  /**
   * 检查是否为错误状态
   */
  hasError: (ctx: TimelineStatusContext): ctx is ErrorContext =>
    ctx.stage === 'error',

  /**
   * 检查是否为就绪状态
   */
  isReady: (ctx: TimelineStatusContext): ctx is ReadyContext =>
    ctx.stage === 'ready'
}
```

## 预定义的状态上下文模板

```typescript
/**
 * 预定义的状态上下文模板
 *
 * 提供常用场景的默认上下文配置
 */
const TIMELINE_CONTEXT_TEMPLATES = {
  // 下载相关
  downloadStart: (): DownloadContext => ({
    stage: 'downloading',
    message: '正在下载文件...',
    progress: { percent: 0 },
    timestamp: Date.now()
  }),

  downloadProgress: (percent: number, speed?: string): DownloadContext => ({
    stage: 'downloading',
    message: '正在下载文件...',
    progress: { percent, detail: speed },
    downloadSpeed: speed,
    timestamp: Date.now()
  }),

  // 解析相关
  parseStart: (): ParseContext => ({
    stage: 'parsing',
    message: '正在解析媒体文件...',
    progress: { percent: 0 },
    timestamp: Date.now()
  }),

  parseProgress: (percent: number, step?: string): ParseContext => ({
    stage: 'parsing',
    message: '正在解析媒体文件...',
    progress: { percent, detail: step },
    currentStep: step,
    timestamp: Date.now()
  }),

  // 处理相关
  processingStart: (operation: string): ProcessingContext => ({
    stage: 'processing',
    message: `正在${operation}...`,
    progress: { percent: 0 },
    operation,
    timestamp: Date.now()
  }),

  // 就绪状态
  ready: (metadata?: ReadyContext['metadata']): ReadyContext => ({
    stage: 'ready',
    message: '媒体已就绪',
    metadata,
    timestamp: Date.now()
  }),

  // 错误状态
  error: (code: string, message: string, recoverable = true): ErrorContext => ({
    stage: 'error',
    message,
    error: { code, message, recoverable },
    timestamp: Date.now()
  }),

  // 常见错误
  fileNotFound: (originalPath?: string): ErrorContext => ({
    stage: 'error',
    message: '文件不存在',
    error: {
      code: 'FILE_NOT_FOUND',
      message: originalPath ? `找不到文件: ${originalPath}` : '找不到关联的媒体文件',
      recoverable: true
    },
    timestamp: Date.now()
  }),

  parseError: (): ErrorContext => ({
    stage: 'error',
    message: '无法识别的文件格式',
    error: {
      code: 'PARSE_ERROR',
      message: '该文件格式不受支持或文件已损坏',
      recoverable: false
    },
    timestamp: Date.now()
  }),

  networkError: (): ErrorContext => ({
    stage: 'error',
    message: '网络连接失败',
    error: {
      code: 'NETWORK_ERROR',
      message: '网络连接问题导致下载失败',
      recoverable: true
    },
    timestamp: Date.now()
  })
}
```

## 扩展性示例

```typescript
/**
 * 扩展性示例 - 添加新的异步操作类型
 */
interface AudioAnalysisContext extends BaseTimelineStatusContext, ProgressExtension {
  stage: 'audio-analysis'
  analysisType?: 'waveform' | 'spectrum' | 'volume'
  sampleRate?: number
}

// 更新联合类型时只需添加新类型
// type TimelineStatusContext =
//   | DownloadContext
//   | ParseContext
//   | ProcessingContext
//   | AudioAnalysisContext  // 新增
//   | ReadyContext
//   | ErrorContext
```

---

*文档创建时间：2025-01-18*
*基于重构文档版本：v1.0*
*关联文档：10-统一时间轴项目设计-类型设计-核心接口.md*
