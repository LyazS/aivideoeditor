# 统一时间轴项目设计 - 核心接口类型设计（响应式重构版）

## 概述

基于"核心数据 + 行为分离"的重构方案，统一时间轴项目采用与数据源、媒体项目一致的响应式架构模式。本方案将当前的双重时间轴项目系统（`LocalTimelineItem` 和 `AsyncProcessingTimelineItem`）统一为单一的响应式数据结构，彻底解决Vue3响应式支持问题。

## 重构背景

### 1. 架构一致性问题
当前系统中不同模块采用不同的架构模式：
- **数据源和媒体项目**：已采用"核心数据 + 行为分离"的响应式模式
- **时间轴项目**：仍使用传统类模式，存在响应式支持问题

### 2. Vue3响应式问题
传统类模式存在的问题：
- 类实例属性修改无法被Vue3响应式系统检测
- 依赖回调机制手动触发UI更新，容易遗漏
- 组件中无法直接使用响应式特性

### 3. 双重类型系统复杂性
```typescript
// ❌ 当前设计：两种时间轴项目类型
LocalTimelineItem vs AsyncProcessingTimelineItem

// 问题：
- 两套并行的状态管理和UI渲染逻辑
- 复杂的类型守卫和转换逻辑
- Sprite生命周期管理复杂
```

## 响应式重构方案

### 1. 核心设计理念

**状态驱动的统一架构**：
- 将"本地"和"异步"从**类型区分**改为**状态区分**
- 采用三层状态映射：数据源状态 → 媒体项目状态 → 时间轴项目状态
- 自动化的Sprite生命周期管理

### 2. 时间轴项目状态定义 - 3状态简化方案

**重新审视**后的简化定义：

```typescript
/**
 * 统一时间轴项目状态 - 基于实际业务场景的三元模型
 */
type TimelineItemStatus = 
  | 'ready'    // 完全就绪，可用于时间轴
  | 'loading'  // 正在处理中，包含下载、解析、等待
  | 'error'    // 不可用状态，包含错误、缺失、取消
```

**设计哲学转变**：从"状态驱动一切"到"状态作为基础，上下文承载细节"

### 3. 状态映射关系 - 3状态简化版

**统一映射** - 所有场景共用的简化映射：

```typescript
/**
 * 简化后的媒体状态 → 时间轴状态映射
 */
const MEDIA_TO_TIMELINE_STATUS_MAP: Record<MediaStatus, TimelineItemStatus> = {
  'pending': 'loading',           // 等待开始处理
  'asyncprocessing': 'loading',   // 下载/获取中（显示下载进度）
  'webavdecoding': 'loading',     // 解析中（显示"解析中..."文案）
  'ready': 'ready',               // 完全就绪
  'error': 'error',               // 各种错误状态
  'cancelled': 'error',           // 用户取消
  'missing': 'error'              // 文件缺失
}
```

**响应式映射优势**：
- ✅ 状态变化自动触发Vue组件更新
- ✅ 无需记忆复杂映射规则
- ✅ 所有"未完成"统一为loading
- ✅ 用StatusContext.stage区分loading的具体场景

## 响应式核心数据结构

### 1. 统一时间轴项目数据接口 - 响应式版本

**重构后数据接口**：采用"核心数据 + 行为分离"模式，纯响应式状态对象

```typescript
import { reactive } from 'vue'
import type { MediaType } from '@/types'
import type { UnifiedDataSourceData } from '@/unified/sources'

/**
 * 时间轴项目状态类型 - 3状态简化版
 */
export type TimelineItemStatus =
  | 'ready'    // 完全就绪，可用于时间轴
  | 'loading'  // 正在处理中，包含下载、解析、等待
  | 'error'    // 不可用状态，包含错误、缺失、取消

/**
 * 状态转换规则定义
 */
export const VALID_TIMELINE_TRANSITIONS: Record<TimelineItemStatus, TimelineItemStatus[]> = {
  'loading': ['ready', 'error'],
  'ready': ['loading', 'error'],
  'error': ['loading']
} as const

/**
 * 统一时间轴项目数据接口 - 纯响应式状态对象
 *
 * 设计理念：
 * - 纯数据对象，使用 reactive() 包装
 * - 所有状态变化自动触发Vue组件更新
 * - 与数据源、媒体项目采用一致的架构模式
 */
export interface UnifiedTimelineItemData {
  // ==================== 核心属性 ====================
  readonly id: string
  mediaItemId: string // 关联的统一媒体项目ID
  trackId?: string

  // ==================== 状态管理 ====================
  timelineStatus: TimelineItemStatus // 仅3状态：ready|loading|error

  // ==================== 状态上下文 - 动态状态信息 ====================
  statusContext?: TimelineStatusContext // 承载当前状态的详细信息和UI展示数据

  // ==================== 媒体信息 ====================
  mediaType: MediaType | 'unknown' // 从关联的媒体项目同步

  // ==================== 时间范围 ====================
  timeRange: {
    timelineStartTime: number // 时间轴开始时间（帧数）
    timelineEndTime: number   // 时间轴结束时间（帧数）
  }

  // ==================== 基础配置 ====================
  config: BasicTimelineConfig // 静态配置信息

  // ==================== Sprite引用 ====================
  spriteId?: string // Sprite ID，由SpriteLifecycleManager管理
}
  
  // ==================== 统一配置 ====================
  config: BasicTimelineConfig // 统一基础配置，取消占位符/准备中分离
  
  // ==================== 精灵对象 ====================
  sprite?: Raw<CustomSprite> // ready状态可用
  
  // ==================== 状态机方法 ====================
  /**
   * 状态转换 - 统一3状态驱动
   * @param newStatus ready|loading|error
   * @param context 详细的阶段信息和展示文案
   */
  transitionTo(newStatus: TimelineItemStatus, context?: TimelineStatusContext): void
  
  /**
   * 检查3状态的合法性
   */
  canTransitionTo(newStatus: TimelineItemStatus): boolean
}
```

### 2. 响应式工厂函数

```typescript
import { reactive } from 'vue'
import { generateUUID4 } from '@/utils/idGenerator'

/**
 * 创建响应式时间轴项目数据对象
 */
export function createTimelineItemData(options: {
  mediaItemId: string
  trackId?: string
  timeRange: { timelineStartTime: number; timelineEndTime: number }
  config: BasicTimelineConfig
  mediaType?: MediaType
  initialStatus?: TimelineItemStatus
}): UnifiedTimelineItemData {
  return reactive({
    id: generateUUID4(),
    mediaItemId: options.mediaItemId,
    trackId: options.trackId,
    timelineStatus: options.initialStatus || 'loading',
    statusContext: undefined,
    mediaType: options.mediaType || 'unknown',
    timeRange: options.timeRange,
    config: options.config,
    spriteId: undefined
  })
}
```

### 3. 基础配置接口

```typescript
/**
 * 统一的基础配置 - 静态配置信息
 *
 * 职责：定义时间轴项目的基本属性和媒体参数
 * 特点：创建时设置，很少变化，需要持久化保存
 */
export interface BasicTimelineConfig {
  name: string                           // 显示名称
  mediaConfig: GetMediaConfig<MediaType> // 媒体配置（变换、音量、缩略图等参数）
  animation?: AnimationConfig<MediaType> // 可选动画配置
}

/**
 * 重要说明：缩略图的正确位置
 *
 * thumbnailUrl 应该放在 mediaConfig 中，而不是作为 UnifiedTimelineItem 的独立属性：
 *
 * ✅ 正确做法：
 * interface VideoMediaConfig extends VisualMediaProps {
 *   thumbnailUrl?: string  // 视频缩略图
 * }
 *
 * interface ImageMediaConfig extends VisualMediaProps {
 *   thumbnailUrl?: string  // 图片缩略图（可能是压缩版本）
 * }
 *
 * ❌ 错误做法：
 * interface UnifiedTimelineItem {
 *   thumbnailUrl?: string  // 不应该放在这里
 * }
 *
 * 原因：
 * 1. thumbnailUrl 是媒体相关的属性，应该归属于媒体配置
 * 2. 只有视频和图像才有缩略图，音频没有
 * 3. 作为媒体配置的一部分，便于统一管理和持久化
 */
```

### 3. 状态转换规则 - 极简3状态

**3状态合法转换** - 大大简化：

```typescript
/**
 * 极简3状态转换规则 - 基于真实业务场景
 *
 * 原6状态24种转换 -> 简化到9种转换
 * 所有中间状态都通过TimelineStatusContext表达
 */
const VALID_TIMELINE_TRANSITIONS: Record<TimelineItemStatus, TimelineItemStatus[]> = {
  'loading': ['ready', 'error'],  // loading完成后变为就绪或错误
  'ready': ['loading', 'error'],  // 重新处理或出错
  'error': ['loading', 'ready']   // 重试或恢复
}
```

## 设计优势总结

### 1. 架构显著简化
- **极致简化**：从6状态24种转换简化为3状态9种转换
- **逻辑统一**：所有"未完成"统一为loading，所有"不可用"统一为error
- **类型安全**：通过泛型接口确保每个状态都有准确的类型定义

### 2. 开发体验飞跃
- **类型维护成本大幅降低**：
  - 状态枚举：6个→3个
  - 联合类型：复杂嵌套→清晰的泛型接口
  - 类型守卫：自动生成，无需手写

### 3. 用户体验保持完整
- **进度展示**：通过 `ProgressExtension` 保持细致进度信息
- **错误引导**：通过 `ErrorExtension` 提供具体恢复路径
- **视觉一致性**：所有loading/error状态外观统一，内部细节差异化

### 4. 代码质量显著提升
- **类型安全**：编译时捕获状态相关的错误
- **智能提示**：IDE 提供准确的属性和方法提示
- **重构友好**：修改接口时 TypeScript 会提示所有需要更新的地方
- **文档自描述**：类型定义即文档，无需额外维护

---

*文档创建时间：2025-01-18*
*基于重构文档版本：v1.0*
*关联文档：07-媒体类型统一设计-类型设计.md*
