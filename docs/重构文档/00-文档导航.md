# AI视频编辑器重构文档导航

## 📋 文档概述

本目录包含AI视频编辑器项目的重构设计文档，主要解决当前架构中存在的问题，提出统一的数据源和媒体类型设计方案。

## 🎯 重构目标

- **统一架构**：将分散的 `LocalMediaItem` 和 `AsyncProcessingMediaItem` 统一为单一的媒体类型
- **职责分离**：数据源负责文件获取，媒体项目负责文件处理
- **状态管理**：采用状态机模式，清晰的状态转换流程
- **扩展性**：支持多种数据源类型（本地、远程、云盘、FTP等）

## 📚 文档结构

### 🔧 数据源设计（01-06）

#### [01-数据源基础类型设计](./01-数据源基础类型设计.md)
- **内容**：定义数据源的基础抽象类和通用接口
- **核心概念**：
  - `BaseDataSource` 抽象类设计
  - 数据源状态类型定义
  - 状态管理和操作方法
  - 职责分离原则
- **适用场景**：理解数据源架构基础

#### [02-数据源扩展类型设计](./02-数据源扩展类型设计.md)
- **内容**：具体数据源类型的实现
- **核心概念**：
  - `UserSelectedFileSource`：用户选择文件
  - `ProjectFileSource`：工程文件路径
  - `RemoteFileSource`：远程文件下载
  - 联合类型定义和类型守卫
- **适用场景**：实现具体的数据源类型

#### [03-数据源扩展类型使用示例](./03-数据源扩展类型使用示例.md)
- **内容**：各种数据源类型的实际使用代码
- **核心概念**：
  - 文件选择和拖拽处理
  - 工程文件重新定位
  - 远程文件下载管理
  - 批量处理示例
- **适用场景**：学习如何使用数据源API

#### [04-数据源基础管理器类型设计](./04-数据源基础管理器类型设计.md)
- **内容**：数据源管理器的基础架构
- **核心概念**：
  - `DataSourceManager` 抽象类
  - 任务调度和并发控制
  - 错误处理和重试机制
  - 管理器注册系统
- **适用场景**：理解管理器架构设计

#### [05-数据源扩展管理器类型设计](./05-数据源扩展管理器类型设计.md)
- **内容**：具体管理器类型的实现
- **核心概念**：
  - `UserSelectedFileManager`：文件验证管理
  - `ProjectFileManager`：文件定位管理
  - `RemoteFileManager`：下载管理
  - 单例模式和特化处理
- **适用场景**：实现具体的管理器逻辑

#### [06-数据源管理器使用示例](./06-数据源管理器使用示例.md)
- **内容**：管理器的实际使用和最佳实践
- **核心概念**：
  - 批量文件处理
  - 工程加载和文件重定位
  - 下载进度管理
  - 全局监控和统计
- **适用场景**：学习管理器的实际应用

### 🎬 媒体类型统一设计（07-09）

#### [07-媒体类型统一设计-类型设计](./07-媒体类型统一设计-类型设计.md)
- **内容**：统一媒体类型的核心设计
- **核心概念**：
  - `UnifiedMediaItem` 接口设计
  - 双重状态设计（数据源状态 + 媒体状态）
  - 状态转换规则和约束
  - `TransitionContext` 上下文设计
- **适用场景**：理解统一媒体类型架构

#### [08-媒体类型统一设计-使用示例](./08-媒体类型统一设计-使用示例.md)
- **内容**：统一媒体类型的实际使用代码
- **核心概念**：
  - 媒体项目创建和初始化
  - 状态转换钩子使用
  - 下载管理器完整实现
  - UI组件集成示例
- **适用场景**：学习如何使用统一媒体类型

#### [09-媒体类型统一设计-转换流程示例](./09-媒体类型统一设计-转换流程示例.md)
- **内容**：状态转换的具体流程和时序
- **核心概念**：
  - 管理器驱动的状态转换
  - 本地文件 vs 远程文件流程
  - 错误处理和重试机制
  - 状态转换图和时序图
- **适用场景**：理解状态转换的完整流程

### 🎞️ 时间轴项目统一设计（10-12）

#### [10-统一时间轴项目设计-类型设计](./10-统一时间轴项目设计-类型设计.md)
- **内容**：统一时间轴项目的核心设计
- **核心概念**：
  - `UnifiedTimelineItem` 接口设计
  - 时间轴项目状态机（pending → placeholder → preparing → ready）
  - 媒体项目状态到时间轴项目状态的自动映射
  - Sprite生命周期自动化管理
  - 状态驱动的配置类型系统
- **适用场景**：理解统一时间轴项目架构和状态管理

#### [11-统一时间轴项目设计-扩展类型](./11-统一时间轴项目设计-扩展类型.md)
- **内容**：时间轴项目的扩展类型实现
- **核心概念**：
  - 具体时间轴项目类型实现
  - 不同媒体类型的特化处理
  - 扩展配置和自定义属性
  - 类型守卫和工厂方法
- **适用场景**：实现具体的时间轴项目类型

#### [12-统一时间轴项目设计-使用示例](./12-统一时间轴项目设计-使用示例.md)
- **内容**：时间轴项目的实际使用代码和最佳实践
- **核心概念**：
  - 时间轴项目创建和管理
  - 状态转换处理示例
  - UI组件集成方案
  - 性能优化技巧
- **适用场景**：学习如何使用统一时间轴项目

### 🔄 操作记录系统设计（13-15）

#### [13-重构操作记录系统设计](./13-重构操作记录系统设计.md)
- **内容**：基于重构架构的统一操作记录系统总览
- **核心概念**：
  - 系统架构和设计理念
  - 核心组件和应用场景
  - 与重构架构的集成优势
  - 技术优势和实现路径
- **适用场景**：了解操作记录系统的整体设计

#### [14-重构操作记录系统设计-类型设计](./14-重构操作记录系统设计-类型设计.md)
- **内容**：操作记录系统的核心类型接口和抽象类设计
- **核心概念**：
  - UnifiedCommand接口和相关类型定义
  - 状态快照和转换上下文设计
  - 时间轴项目命令基类
  - 批量操作和命令合并接口
- **适用场景**：理解系统架构和接口设计

#### [15-重构操作记录系统设计-使用示例](./15-重构操作记录系统设计-使用示例.md)
- **内容**：操作记录系统的具体实现示例和实际使用方法
- **核心概念**：
  - 各种时间轴操作命令的具体实现
  - 批量操作和历史管理器实现
  - 实际应用场景的完整代码示例
  - 命令合并和性能优化技巧
- **适用场景**：学习如何实现和使用操作记录系统

### 📋 总结文档

#### [数据源管理器媒体类型流转过程总结](./数据源管理器媒体类型流转过程总结.md)
- **内容**：整个重构方案的流程总结和关键要点
- **核心概念**：
  - 完整的数据流转过程
  - 各组件间的协作关系
  - 关键设计决策说明
  - 实施要点和注意事项
- **适用场景**：快速理解整体架构和实施要点

## 🚀 快速开始

### 1. 新手入门路径
```
01-数据源基础类型设计 → 07-媒体类型统一设计-类型设计 → 10-统一时间轴项目设计-类型设计
```

### 2. 实现开发路径
```
04-数据源基础管理器类型设计 → 05-数据源扩展管理器类型设计 → 08-媒体类型统一设计-使用示例 → 12-统一时间轴项目设计-使用示例
```

### 3. 架构理解路径
```
07-媒体类型统一设计-类型设计 → 10-统一时间轴项目设计-类型设计 → 09-媒体类型统一设计-转换流程示例 → 13-重构操作记录系统设计 → 数据源管理器媒体类型流转过程总结
```

### 4. 完整集成路径
```
数据源设计(01-06) → 媒体类型设计(07-09) → 时间轴项目设计(10-12) → 操作记录系统设计(13-14) → 总结文档 → 实际应用
```

## 🔍 核心概念速查

### 数据源类型
- **UserSelectedFileSource**：用户通过文件选择器选择的文件
- **ProjectFileSource**：从工程配置中加载的文件路径
- **RemoteFileSource**：需要从网络下载的远程文件

### 媒体状态
- **pending**：等待开始处理
- **asyncprocessing**：异步获取中（下载、同步等）
- **webavdecoding**：WebAV解析中
- **ready**：就绪可用
- **error**：错误状态
- **cancelled**：已取消
- **missing**：文件缺失

### 管理器类型
- **UserSelectedFileManager**：处理用户选择文件的验证
- **ProjectFileManager**：处理工程文件的定位和重定位
- **RemoteFileManager**：处理远程文件的下载

### 时间轴项目状态
- **pending**：等待媒体项目就绪
- **placeholder**：占位符状态（媒体项目异步处理中）
- **preparing**：准备sprite和WebAV对象
- **ready**：完全就绪，可以播放和编辑
- **error**：错误状态
- **missing**：媒体项目缺失

### 统一设计核心
- **UnifiedMediaItem**：统一的媒体项目接口
- **UnifiedTimelineItem**：统一的时间轴项目接口
- **状态同步机制**：媒体项目状态自动映射到时间轴项目状态
- **Sprite生命周期管理**：根据状态自动创建和销毁sprite对象

### 操作记录系统
- **UnifiedCommand**：统一的命令接口，支持状态驱动的操作记录
- **StateSnapshot**：状态快照机制，支持精确的撤销/重做
- **CommandMerger**：智能命令合并，优化历史记录
- **BatchCommand**：批量操作支持，统一的批量命令处理
- **TransitionContext**：丰富的操作上下文，支持详细的状态转换信息

## 🛠️ 实现建议

1. **先实现数据源基础类**：从 `BaseDataSource` 开始
2. **再实现具体数据源**：根据需要实现 `UserSelectedFileSource` 等
3. **然后实现管理器**：从 `DataSourceManager` 基类开始
4. **接着集成媒体类型**：实现 `UnifiedMediaItem` 和状态转换
5. **再实现时间轴项目**：实现 `UnifiedTimelineItem` 和与媒体项目的集成
6. **然后实现操作记录系统**：
   - 先看总览文档了解整体设计
   - 再看类型设计文档理解接口架构
   - 最后看使用示例文档学习具体实现
7. **最后参考总结文档**：查看完整流程和实施要点

## 📝 注意事项

- 所有示例代码都是 TypeScript，注重类型安全
- 状态转换采用状态机模式，避免无效转换
- 管理器采用单例模式，统一资源管理
- 支持并发控制、错误重试、进度跟踪等高级特性

## 🔗 相关资源

- **当前代码库**：`d:\AzProjects\aivideoeditor`
- **主要技术栈**：TypeScript, WebAV, React
- **设计模式**：状态机、单例、观察者

---

*最后更新：2025-01-19*
*新增：13-重构操作记录系统设计.md、13-重构操作记录系统设计-类型设计.md、14-重构操作记录系统设计-使用示例.md*
*历史更新：11-统一时间轴项目设计-扩展类型.md、12-统一时间轴项目设计-使用示例.md、数据源管理器媒体类型流转过程总结.md*