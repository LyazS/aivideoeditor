# 关键帧动画系统使用指南

## 概述

关键帧动画系统已成功实现并集成到视频编辑器中。该系统支持位置、尺寸、旋转和透明度的关键帧动画，完全基于WebAV的动画引擎。

## 功能特性

### ✅ 已实现的功能

1. **核心类型定义**
   - `Keyframe` - 关键帧数据结构
   - `AnimationConfig` - 动画配置
   - `PropertyAnimationState` - UI状态管理
   - `WebAVAnimationConfig` - WebAV格式转换

2. **关键帧管理**
   - 关键帧的增删改查
   - 属性级别的关键帧管理
   - 自动时长计算
   - 类型守卫和工具函数

3. **动画UI管理**
   - 钻石框状态管理（录制/有关键帧/脏状态）
   - 属性录制状态切换
   - 响应式UI状态同步

4. **WebAV集成**
   - 帧数到百分比的转换
   - WebAV动画配置生成
   - 自动动画应用和清理
   - 属性同步机制

5. **属性面板集成**
   - 位置、尺寸、旋转、透明度的钻石框UI
   - 自动关键帧创建
   - 实时动画预览

## 使用方法

### 1. 启用属性动画

1. 在时间轴上选择一个视频或图片片段
2. 在属性面板中找到要动画的属性（位置、尺寸、旋转、透明度）
3. 点击属性右侧的钻石框（◆）
4. 钻石框变为金色表示该属性进入录制状态
5. 系统会在当前帧位置自动创建初始关键帧

### 2. 创建关键帧动画

1. 确保目标属性的钻石框处于激活状态（金色）
2. 移动时间轴播放头到目标帧位置
3. 在属性面板中修改属性值
4. 系统会自动在当前帧位置创建新的关键帧
5. WebAV会自动计算中间帧的插值动画

### 3. 钻石框状态说明

- **灰色（◆）**: 属性未启用动画
- **金色（◆）**: 属性处于录制状态，修改值会创建关键帧
- **蓝色（◆）**: 属性有关键帧但未处于录制状态
- **橙色（◆）**: 属性值已修改但未保存为关键帧（脏状态）

### 4. 停止录制

1. 再次点击钻石框可以停止录制
2. 已创建的关键帧会保留
3. 动画会继续播放，但不会创建新的关键帧

## 技术架构

### 数据流向

```
用户操作 → 关键帧数据 → WebAV配置 → WebAV执行 → propsChange → TimelineItem更新 → UI显示
```

### 核心组件

1. **useAnimationUI** - 动画UI状态管理
2. **keyframeUtils** - 关键帧操作工具
3. **animationConverter** - WebAV格式转换
4. **webavAnimationManager** - WebAV动画管理
5. **propertySynchronizer** - 属性同步（预留）

### 关键设计原则

- **WebAV驱动**: 所有动画执行由WebAV负责，系统只负责配置
- **帧数精确**: 内部使用帧数计算，避免浮点数误差
- **响应式同步**: TimelineItem属性与WebAV状态双向同步
- **UI状态分离**: 动画数据与UI状态完全分离

## 示例场景

### 创建简单的位移动画

1. 选择一个视频片段
2. 点击位置属性的钻石框启用录制
3. 在第0帧，位置设为 (100, 100)
4. 移动到第60帧，位置设为 (300, 200)
5. 播放预览，视频会在2秒内从左上角移动到右下角

### 创建缩放动画

1. 选择一个图片片段
2. 点击尺寸属性的钻石框启用录制
3. 在第0帧，缩放设为 1.0
4. 移动到第30帧，缩放设为 2.0
5. 移动到第60帧，缩放设为 0.5
6. 播放预览，图片会先放大再缩小

### 组合动画

1. 同时启用位置和旋转的录制
2. 在不同帧位置设置不同的位置和旋转值
3. WebAV会自动处理多属性的同步动画

## 注意事项

### 性能考虑

- 关键帧数量建议控制在合理范围内
- 复杂动画可能影响实时预览性能
- 系统会自动优化WebAV动画配置

### 使用限制

- 音量属性不支持关键帧动画（WebAV限制）
- 关键帧位置必须在clip的时间范围内
- 动画时长受clip时长限制

### 错误处理

- 无效的关键帧配置会被自动过滤
- WebAV动画应用失败时会有控制台警告
- 系统会自动回退到静态属性值

## 调试信息

系统提供详细的控制台日志：

- `🎬 [Animation UI]` - UI状态变化
- `🎬 [WebAV Animation]` - WebAV动画操作
- `🔄 [PropertySync]` - 属性同步（预留）

## 未来扩展

### 计划中的功能

1. **时间轴关键帧标记** - 在时间轴上显示关键帧位置
2. **关键帧导航** - 快速跳转到关键帧位置
3. **缓动函数支持** - 自定义动画曲线
4. **批量操作** - 多选片段的动画操作

### 扩展接口

系统设计了灵活的扩展接口，支持：

- 新的动画属性类型
- 自定义缓动函数
- 动画事件回调
- 外部动画数据导入/导出

## 总结

关键帧动画系统已完全集成到视频编辑器中，提供了直观的用户界面和强大的动画功能。系统基于WebAV的动画引擎，确保了高性能和准确性。用户可以通过简单的钻石框操作创建复杂的动画效果。
