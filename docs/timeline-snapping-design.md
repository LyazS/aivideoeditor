# 时间轴吸附功能设计文档

## 1. 功能概述

时间轴吸附功能旨在提供精确的片段定位和对齐能力，通过自动吸附到关键位置点，提升用户的编辑效率和精度。

## 2. 现状分析

### 2.1 已实现功能
- ✅ **播放头吸附**：播放头可以吸附到片段边界和关键帧位置
- ✅ **基础架构**：已有吸附阈值设置、吸附点计算等基础功能
- ✅ **吸附逻辑**：在 `Playhead.vue` 中实现了 `applySnapToClips` 方法

### 2.2 缺失功能
- ❌ **片段拖拽吸附**：片段拖拽时无法吸附到其他片段或关键位置
- ❌ **片段调整大小吸附**：调整片段边界时无法吸附
- ❌ **可视化反馈**：缺少吸附指示线和视觉反馈
- ❌ **统一配置管理**：吸附设置分散，缺少统一管理

## 3. 功能需求清单

### 3.1 核心吸附功能

#### 3.1.1 片段拖拽吸附
- **单片段拖拽吸附**
  - 吸附到其他片段的开始位置
  - 吸附到其他片段的结束位置
  - 吸附到播放头位置
  - 吸附到时间轴起始位置（0帧）
  - 吸附到关键帧位置

- **多片段拖拽吸附**
  - 保持多个片段的相对位置关系
  - 以主片段（第一个选中的片段）为基准进行吸附
  - 确保所有片段都不会拖拽到负时间位置

#### 3.1.2 片段调整大小吸附
- **左边界调整吸附**
  - 吸附到其他片段的边界位置
  - 吸附到关键帧位置
  - 吸附到播放头位置
  - 保持最小片段长度限制

- **右边界调整吸附**
  - 吸附到其他片段的边界位置
  - 吸附到关键帧位置
  - 吸附到播放头位置
  - 支持无限延长（对于图片和文本片段）

#### 3.1.3 播放头吸附增强
- 保持现有的播放头吸附功能
- 统一吸附配置和逻辑
- 优化吸附性能和响应速度

### 3.2 吸附点类型

#### 3.2.1 片段边界点
```typescript
interface ClipBoundarySnapPoint {
  type: 'clip-start' | 'clip-end'
  frame: number
  clipId: string
  clipName: string
  priority: 1 // 高优先级
}
```

#### 3.2.2 关键帧点
```typescript
interface KeyframeSnapPoint {
  type: 'keyframe'
  frame: number
  clipId: string
  keyframeId: string
  priority: 2 // 中优先级
}
```

#### 3.2.3 播放头位置
```typescript
interface PlayheadSnapPoint {
  type: 'playhead'
  frame: number
  priority: 1 // 高优先级
}
```

#### 3.2.4 时间轴起始点
```typescript
interface TimelineStartSnapPoint {
  type: 'timeline-start'
  frame: 0
  priority: 3 // 低优先级
}
```

### 3.3 可视化反馈

#### 3.3.1 吸附指示线
- **垂直指示线**：在吸附位置显示半透明的垂直线
- **颜色编码**：
  - 蓝色：片段边界吸附
  - 绿色：关键帧吸附
  - 红色：播放头吸附
  - 灰色：时间轴起始位置吸附

#### 3.3.2 吸附信息提示
- **距离显示**：显示吸附的精确帧数位置
- **类型标识**：显示吸附点的类型和来源
- **时间码显示**：显示对应的时间码信息

#### 3.3.3 预览反馈
- **拖拽预览**：在拖拽过程中实时显示吸附效果
- **调整预览**：在调整大小时显示边界吸附效果
- **动画过渡**：平滑的吸附动画效果

### 3.4 配置管理

#### 3.4.1 吸附开关
```typescript
interface SnapConfig {
  // 全局吸附开关
  enabled: boolean
  
  // 分类型开关
  clipBoundaries: boolean    // 片段边界吸附
  keyframes: boolean         // 关键帧吸附
  playhead: boolean          // 播放头吸附
  timelineStart: boolean     // 时间轴起始位置吸附
  
  // 吸附参数
  threshold: number          // 吸附阈值（像素）
  visualFeedback: boolean    // 可视化反馈开关
}
```

#### 3.4.2 用户控制
- **设置面板**：提供详细的吸附配置界面
- **快捷键控制**：按住 Alt 键临时禁用吸附
- **状态指示**：在界面上显示当前吸附状态
- **配置持久化**：保存用户的吸附偏好设置

## 4. 技术实现要点

### 4.1 核心组件

#### 4.1.1 吸附管理器 (SnapManager)
- 统一管理所有吸附逻辑
- 计算和缓存吸附点
- 提供吸附计算接口
- 管理吸附配置

#### 4.1.2 吸附计算器 (SnapCalculator)
- 收集所有可用的吸附点
- 计算目标位置与吸附点的距离
- 根据优先级和距离选择最佳吸附点
- 返回吸附后的位置

#### 4.1.3 可视化组件 (SnapIndicator)
- 渲染吸附指示线
- 显示吸附信息提示
- 管理动画效果
- 响应吸附状态变化

### 4.2 集成点

#### 4.2.1 拖拽系统集成
- 在 `useDragUtils.ts` 中集成吸附计算
- 在 `Timeline.vue` 的拖拽处理中应用吸附
- 在拖拽预览中显示吸附反馈

#### 4.2.2 调整大小系统集成
- 在 `BaseClip.vue` 的调整大小逻辑中集成吸附
- 在调整过程中实时计算和应用吸附
- 提供调整大小时的可视化反馈

#### 4.2.3 播放头系统集成
- 重构现有的播放头吸附逻辑
- 使用统一的吸附管理器
- 保持现有功能的兼容性

### 4.3 性能优化

#### 4.3.1 计算优化
- **吸附点缓存**：缓存计算结果，只在必要时重新计算
- **范围限制**：只计算可视区域内的吸附点
- **距离预筛选**：快速排除距离过远的吸附点

#### 4.3.2 渲染优化
- **按需渲染**：只在吸附发生时渲染指示器
- **防抖处理**：对频繁的拖拽事件进行防抖
- **GPU加速**：使用CSS transform进行动画

## 5. 实施计划

### 5.1 第一阶段：基础架构
- [x] 创建吸附管理器和计算器
- [x] 实现统一的吸附配置管理
- [x] 重构现有播放头吸附逻辑

### 5.2 第二阶段：片段拖拽吸附
- [ ] 集成片段拖拽吸附功能
- [ ] 支持单片段和多片段拖拽
- [ ] 添加基础的可视化反馈

### 5.3 第三阶段：片段调整大小吸附
- [ ] 实现左右边界调整吸附
- [ ] 优化调整大小的用户体验
- [ ] 完善可视化反馈系统

### 5.4 第四阶段：用户体验优化
- [ ] 添加详细的设置面板
- [ ] 实现快捷键控制
- [ ] 优化性能和动画效果
- [ ] 完善文档和测试

## 6. 验收标准

### 6.1 功能验收
- ✅ 片段拖拽时能够准确吸附到目标位置
- ✅ 片段调整大小时能够吸附到边界位置
- ✅ 播放头吸附功能保持正常工作
- ✅ 多片段操作时吸附逻辑正确
- ✅ 吸附配置能够正确保存和应用

### 6.2 性能验收
- ✅ 吸附计算不影响拖拽操作的流畅性
- ✅ 可视化反馈渲染性能良好
- ✅ 大量片段时吸附功能仍然响应迅速

### 6.3 用户体验验收
- ✅ 吸附行为符合用户直觉
- ✅ 可视化反馈清晰易懂
- ✅ 配置界面简洁易用
- ✅ 快捷键操作响应准确

---

## 7. 实现进度记录

### 7.1 第一阶段完成情况 ✅

**完成时间**: 2025-01-05

#### 7.1.1 已实现的文件结构
```
frontend/src/
├── types/snap.ts                    # 吸附类型定义
├── composables/useSnapConfig.ts     # 吸附配置管理
├── composables/useSnapManager.ts    # 吸附管理器
├── utils/snapCalculator.ts         # 吸附计算器
└── components/Playhead.vue          # 重构后的播放头组件
```

#### 7.1.2 核心功能实现

**1. 吸附类型系统** (`types/snap.ts`)
- ✅ 定义了完整的吸附点类型接口
- ✅ 包含 ClipBoundarySnapPoint、KeyframeSnapPoint、PlayheadSnapPoint、TimelineStartSnapPoint
- ✅ 提供了吸附配置接口和计算结果接口
- ✅ 设置了默认配置常量

**2. 配置管理系统** (`composables/useSnapConfig.ts`)
- ✅ 统一的吸附配置管理
- ✅ 支持配置持久化到 localStorage
- ✅ 提供细粒度的开关控制（全局、分类型）
- ✅ 支持临时禁用功能（快捷键控制）
- ✅ 响应式配置状态管理

**3. 吸附计算器** (`utils/snapCalculator.ts`)
- ✅ 收集各种类型的吸附点
- ✅ 智能去重和优先级排序
- ✅ 距离计算和最佳吸附点选择
- ✅ 像素阈值到帧数阈值的转换
- ✅ 支持排除指定片段ID

**4. 吸附管理器** (`composables/useSnapManager.ts`)
- ✅ 统一管理所有吸附逻辑
- ✅ 提供高级吸附计算接口
- ✅ 实现吸附点缓存优化
- ✅ 针对不同场景的专门方法（播放头、拖拽、调整大小）
- ✅ 批量计算和范围查询支持

**5. 播放头吸附重构** (`components/Playhead.vue`)
- ✅ 迁移到新的吸附管理器
- ✅ 保持功能兼容性
- ✅ 简化代码结构
- ✅ 移除重复的吸附逻辑

#### 7.1.3 技术修复记录

**TypeScript 类型安全修复**:
- 修正了 `SnapCalculationOptions` 接口，移除必需的 `targetFrame` 属性
- 修复了 `TimelineItem` 属性访问，通过 `mediaItemId` 获取 `MediaItem.name`
- 修正了关键帧结构访问，使用 `framePosition` 而不是 `time`
- 生成合适的 `keyframeId` 标识符

**架构优势**:
- 统一管理：所有吸附逻辑集中在管理器中
- 高性能：使用缓存机制优化计算
- 可配置：支持细粒度的开关和参数
- 可扩展：为后续功能奠定基础
- 类型安全：完整的 TypeScript 支持

#### 7.1.4 验收测试
- ✅ TypeScript 类型检查通过 (`npm run type-check`)
- ✅ 播放头吸附功能保持正常工作
- ✅ 配置管理系统正常运行
- ✅ 吸附计算器正确收集和计算吸附点

### 7.2 下一阶段计划

**第二阶段：片段拖拽吸附** (待实现)
- 集成片段拖拽吸附功能
- 支持单片段和多片段拖拽
- 添加基础的可视化反馈

---

*本文档将随着开发进度持续更新和完善*
