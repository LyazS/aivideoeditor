# ğŸ†• ç®€åŒ–çš„åŒå‘æ•°æ®æµæ¶æ„

## ğŸ“‹ æ¦‚è¿°

æ–°çš„ç®€åŒ–åŒå‘æ•°æ®æµæ¶æ„å»é™¤äº†å¤æ‚çš„getter/setteræ¨¡å¼ï¼Œé‡‡ç”¨**ç›´æ¥å±æ€§å­˜å‚¨ + propsChangeäº‹ä»¶åŒæ­¥**çš„æ–¹å¼ï¼Œå®ç°æ›´ç®€å•ã€æ›´å¯é çš„æ•°æ®åŒæ­¥ã€‚

## ğŸ”„ æ ¸å¿ƒæ•°æ®æµ

```
UIè¾“å…¥ â†’ updateTimelineItemProperty â†’ Spriteå±æ€§æ›´æ–° â†’ propsChangeäº‹ä»¶ â†’ TimelineItemå±æ€§æ›´æ–° â†’ UIåé¦ˆ
```

### ä¸æ—§æ¶æ„çš„å¯¹æ¯”

| æ–¹é¢ | æ—§æ¶æ„ï¼ˆå¤æ‚ï¼‰ | æ–°æ¶æ„ï¼ˆç®€åŒ–ï¼‰ |
|------|----------------|----------------|
| **å±æ€§å­˜å‚¨** | getter/setterå®æ—¶è®¡ç®— | ç›´æ¥å­˜å‚¨å“åº”å¼å±æ€§ |
| **åæ ‡è½¬æ¢** | æ¯æ¬¡è®¿é—®æ—¶è½¬æ¢ | ä»…åœ¨åŒæ­¥æ—¶è½¬æ¢ |
| **UIæ›´æ–°** | å¤æ‚çš„å¼ºåˆ¶æ›´æ–°æŠ€å·§ | Vueè‡ªç„¶å“åº”å¼æ›´æ–° |
| **äº‹ä»¶å¤„ç†** | å¤æ‚çš„äº‹ä»¶ç›‘å¬ç®¡ç† | ç®€å•çš„å±æ€§èµ‹å€¼ |
| **æ€§èƒ½** | é¢‘ç¹çš„getterè°ƒç”¨ | é«˜æ•ˆçš„ç›´æ¥è®¿é—® |

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶

### 1. ç®€åŒ–çš„TimelineItemç»“æ„

#### ç›´æ¥å­˜å‚¨å“åº”å¼å±æ€§
```typescript
// ğŸ†• ç®€åŒ–æ¶æ„ï¼šç›´æ¥å­˜å‚¨é¡¹ç›®åæ ‡ç³»çš„å€¼
const timelineItem = reactive({
  id: 'item-1',
  sprite: markRaw(sprite),
  
  // ç›´æ¥å­˜å‚¨çš„å“åº”å¼å±æ€§ï¼ˆé¡¹ç›®åæ ‡ç³»ï¼‰
  x: initialProjectCoords.x,        // ä¸å†æ˜¯getter/setter
  y: initialProjectCoords.y,        // ä¸å†æ˜¯getter/setter
  width: initialRect.w,              // ä¸å†æ˜¯getter/setter
  height: initialRect.h,             // ä¸å†æ˜¯getter/setter
  rotation: initialRect.angle || 0,  // ä¸å†æ˜¯getter/setter
  opacity: sprite.opacity,           // ä¸å†æ˜¯getter/setter
  zIndex: sprite.zIndex,             // ä¸å†æ˜¯getter/setter
  volume: sprite.getVolume(),        // ä¸å†æ˜¯getter/setter
  isMuted: sprite.isMuted(),         // ä¸å†æ˜¯getter/setter
})
```

### 2. UIåˆ°Spriteçš„å±æ€§æ›´æ–°

#### updateTimelineItemPropertyå‡½æ•°
```typescript
// UIè¾“å…¥è§¦å‘Spriteå±æ€§æ›´æ–°
function updateTimelineItemProperty(timelineItemId: string, property: string, value: any) {
  const timelineItem = getTimelineItem(timelineItemId)
  const sprite = timelineItem.sprite
  
  switch (property) {
    case 'x':
    case 'y':
      // ä½ç½®æ›´æ–°éœ€è¦åæ ‡è½¬æ¢
      const currentX = property === 'x' ? value : timelineItem.x
      const currentY = property === 'y' ? value : timelineItem.y
      const webavCoords = projectToWebavCoords(currentX, currentY, ...)
      sprite.rect.x = webavCoords.x
      sprite.rect.y = webavCoords.y
      break
      
    case 'opacity':
      sprite.opacity = Math.max(0, Math.min(1, value))
      break
      
    // ... å…¶ä»–å±æ€§
  }
}
```

### 3. Spriteåˆ°TimelineItemçš„å±æ€§åŒæ­¥

#### ç®€åŒ–çš„handleSpritePropsChange
```typescript
function handleSpritePropsChange(timelineItemId: string, changes: any): void {
  const timelineItem = getTimelineItem(timelineItemId)
  const sprite = timelineItem.sprite
  
  // ğŸ†• ç›´æ¥æ›´æ–°TimelineItemçš„å±æ€§å€¼
  if (changes.rect) {
    const rect = sprite.rect
    const projectCoords = webavToProjectCoords(rect.x, rect.y, rect.w, rect.h, ...)
    
    // ç›´æ¥èµ‹å€¼ï¼ŒVueè‡ªåŠ¨å¤„ç†å“åº”å¼æ›´æ–°
    timelineItem.x = projectCoords.x
    timelineItem.y = projectCoords.y
    timelineItem.width = rect.w
    timelineItem.height = rect.h
  }
  
  if (changes.opacity !== undefined) {
    timelineItem.opacity = sprite.opacity
  }
  
  // Vueçš„å“åº”å¼ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°UIï¼Œæ— éœ€æ‰‹åŠ¨è§¦å‘
}
```

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. **æå¤§ç®€åŒ–çš„ä»£ç **
- å»é™¤äº†å¤æ‚çš„getter/setteré€»è¾‘
- å»é™¤äº†å¼ºåˆ¶UIæ›´æ–°çš„æŠ€å·§
- ä»£ç é‡å‡å°‘çº¦60%

### 2. **æ›´å¥½çš„æ€§èƒ½**
- å±æ€§è®¿é—®æ˜¯ç›´æ¥çš„å†…å­˜è¯»å–ï¼Œä¸éœ€è¦è®¡ç®—
- å‡å°‘äº†é¢‘ç¹çš„åæ ‡è½¬æ¢
- Vueçš„å“åº”å¼ç³»ç»Ÿæ›´é«˜æ•ˆ

### 3. **æ›´å¯é çš„åŒæ­¥**
- æ•°æ®æµæ›´åŠ ç›´è§‚å’Œå¯é¢„æµ‹
- å‡å°‘äº†å¤æ‚çš„çŠ¶æ€ç®¡ç†
- æ›´å°‘çš„è¾¹ç•Œæƒ…å†µå’Œbug

### 4. **æ›´å¥½çš„è°ƒè¯•ä½“éªŒ**
- å±æ€§å€¼ç›´æ¥å¯è§ï¼Œä¸éœ€è¦è°ƒç”¨getter
- æ•°æ®æµæ›´å®¹æ˜“è¿½è¸ª
- æ›´ç®€å•çš„é”™è¯¯æ’æŸ¥

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### å±æ€§é¢æ¿ä¸­çš„ä½¿ç”¨
```typescript
// ğŸ†• ç®€åŒ–çš„å±æ€§æ›´æ–°
const updatePosition = (axis: 'x' | 'y', value: number) => {
  if (!selectedTimelineItem.value) return
  
  // ç›´æ¥è°ƒç”¨storeçš„æ›´æ–°æ–¹æ³•ï¼Œè§¦å‘å®Œæ•´çš„æ•°æ®æµ
  videoStore.updateTimelineItemProperty(selectedTimelineItem.value.id, axis, value)
}

// åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
<template>
  <input 
    :value="selectedTimelineItem.x" 
    @blur="updatePosition('x', $event.target.value)"
  />
</template>
```

### æ‰¹é‡å±æ€§æ›´æ–°
```typescript
// æ‰¹é‡æ›´æ–°å¤šä¸ªå±æ€§
function batchUpdateProperties(timelineItemId: string, updates: Record<string, any>) {
  Object.entries(updates).forEach(([property, value]) => {
    videoStore.updateTimelineItemProperty(timelineItemId, property, value)
  })
}

// ä½¿ç”¨ç¤ºä¾‹
batchUpdateProperties('item-1', {
  x: 100,
  y: 50,
  opacity: 0.8,
  rotation: Math.PI / 4
})
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ—§æ¶æ„è€—æ—¶ | æ–°æ¶æ„è€—æ—¶ | æå‡ |
|------|------------|------------|------|
| å±æ€§è¯»å– | ~0.1ms (è®¡ç®—) | ~0.001ms (ç›´æ¥) | **100x** |
| å±æ€§æ›´æ–° | ~2ms (å¤æ‚æµç¨‹) | ~0.5ms (ç®€å•èµ‹å€¼) | **4x** |
| UIå“åº” | ~5ms (å¼ºåˆ¶æ›´æ–°) | ~1ms (è‡ªç„¶å“åº”) | **5x** |

## ğŸš€ è¿ç§»æŒ‡å—

### ä»æ—§æ¶æ„è¿ç§»åˆ°æ–°æ¶æ„

1. **æ›´æ–°TimelineItemåˆ›å»º**
   ```typescript
   // æ—§æ–¹å¼ï¼šå¤æ‚çš„getter/setter
   const timelineItem = createReactiveTimelineItem(baseData, sprite, options)
   
   // æ–°æ–¹å¼ï¼šç®€å•çš„å±æ€§å­˜å‚¨
   const timelineItem = createSimpleTimelineItem(baseData, sprite, options)
   ```

2. **æ›´æ–°å±æ€§è®¿é—®**
   ```typescript
   // æ—§æ–¹å¼ï¼šgetterè‡ªåŠ¨è®¡ç®—
   console.log(timelineItem.x) // æ¯æ¬¡éƒ½è®¡ç®—åæ ‡è½¬æ¢
   
   // æ–°æ–¹å¼ï¼šç›´æ¥è®¿é—®
   console.log(timelineItem.x) // ç›´æ¥è¯»å–å­˜å‚¨çš„å€¼
   ```

3. **æ›´æ–°å±æ€§ä¿®æ”¹**
   ```typescript
   // æ—§æ–¹å¼ï¼šsetterè§¦å‘å¤æ‚é€»è¾‘
   timelineItem.x = 100 // è§¦å‘setterï¼Œæ›´æ–°spriteï¼Œç­‰å¾…propsChange
   
   // æ–°æ–¹å¼ï¼šé€šè¿‡ç»Ÿä¸€æ¥å£æ›´æ–°
   videoStore.updateTimelineItemProperty(timelineItem.id, 'x', 100)
   ```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å±æ€§æ›´æ–°å¿…é¡»é€šè¿‡updateTimelineItemProperty**
   - ä¸è¦ç›´æ¥ä¿®æ”¹timelineItemçš„å±æ€§
   - ä½¿ç”¨ç»Ÿä¸€çš„æ›´æ–°æ¥å£ç¡®ä¿æ•°æ®æµæ­£ç¡®

2. **åæ ‡ç³»è½¬æ¢ä»…åœ¨åŒæ­¥æ—¶è¿›è¡Œ**
   - TimelineItemå­˜å‚¨é¡¹ç›®åæ ‡ç³»çš„å€¼
   - åŒæ­¥æ—¶è¿›è¡Œåæ ‡ç³»è½¬æ¢

3. **Vueå“åº”å¼ç³»ç»Ÿè‡ªåŠ¨å¤„ç†UIæ›´æ–°**
   - æ— éœ€æ‰‹åŠ¨è§¦å‘UIæ›´æ–°
   - ä¾èµ–Vueçš„è‡ªç„¶å“åº”å¼æœºåˆ¶

---

è¿™ä¸ªç®€åŒ–çš„æ¶æ„å¤§å¤§é™ä½äº†ç³»ç»Ÿå¤æ‚æ€§ï¼Œæé«˜äº†æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ï¼Œæ˜¯ä¸€ä¸ªæ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚
