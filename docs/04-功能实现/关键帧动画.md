# 关键帧动画

## 📋 概述

关键帧动画系统是视频编辑器的高级功能，基于WebAV的setAnimation API实现专业级的属性动画编辑。系统支持位置、大小、旋转、透明度等属性的关键帧动画，提供直观的时间轴编辑界面。

## 🎯 设计目标

### 核心功能
- **关键帧编辑**：在时间轴上设置和编辑关键帧
- **属性动画**：支持所有视频变换属性的动画
- **缓动函数**：提供多种动画缓动效果
- **实时预览**：动画效果的实时预览和调试

### 用户体验
- **直观操作**：类似专业视频编辑软件的操作体验
- **可视化编辑**：图形化的关键帧时间轴
- **精确控制**：精确到帧的时间控制
- **批量操作**：支持多个关键帧的批量编辑

## 🏗️ 技术架构

### 基于WebAV的实现

#### WebAV动画API
```typescript
// WebAV的setAnimation API参考
sprite.setAnimation(
  property: string,
  keyframes: Array<{
    time: number      // 时间（微秒）
    value: any        // 属性值
    easing?: string   // 缓动函数
  }>
)
```

#### 关键帧数据结构
```typescript
interface Keyframe {
  id: string
  time: number        // 时间（秒）
  value: any         // 属性值
  easing: EasingType // 缓动函数
  property: string   // 属性名称
  spriteId: string   // 所属精灵ID
}

interface AnimationTrack {
  id: string
  property: string   // 动画属性（x, y, scaleX, scaleY, rotation, opacity）
  keyframes: Keyframe[]
  isVisible: boolean
  isLocked: boolean
}

interface AnimationClip {
  id: string
  spriteId: string
  tracks: AnimationTrack[]
  duration: number
  isEnabled: boolean
}
```

### 关键帧管理系统

#### KeyframeManager
```typescript
class KeyframeManager {
  private animationClips = new Map<string, AnimationClip>()
  
  // 添加关键帧
  addKeyframe(
    spriteId: string,
    property: string,
    time: number,
    value: any,
    easing: EasingType = 'linear'
  ): Keyframe
  
  // 删除关键帧
  removeKeyframe(keyframeId: string): boolean
  
  // 更新关键帧
  updateKeyframe(keyframeId: string, updates: Partial<Keyframe>): boolean
  
  // 获取属性的所有关键帧
  getPropertyKeyframes(spriteId: string, property: string): Keyframe[]
  
  // 应用动画到WebAV
  applyAnimationToSprite(spriteId: string): void
  
  // 清除精灵的所有动画
  clearSpriteAnimation(spriteId: string): void
}
```

#### 动画插值计算
```typescript
class AnimationInterpolator {
  // 计算指定时间的属性值
  static interpolateValue(
    keyframes: Keyframe[],
    time: number,
    property: string
  ): any {
    // 找到时间范围内的关键帧
    const beforeFrame = this.findKeyframeBefore(keyframes, time)
    const afterFrame = this.findKeyframeAfter(keyframes, time)
    
    if (!beforeFrame) return afterFrame?.value
    if (!afterFrame) return beforeFrame.value
    
    // 计算插值
    const progress = (time - beforeFrame.time) / (afterFrame.time - beforeFrame.time)
    const easedProgress = this.applyEasing(progress, beforeFrame.easing)
    
    return this.interpolatePropertyValue(
      beforeFrame.value,
      afterFrame.value,
      easedProgress,
      property
    )
  }
  
  // 应用缓动函数
  static applyEasing(progress: number, easing: EasingType): number {
    switch (easing) {
      case 'linear': return progress
      case 'ease-in': return progress * progress
      case 'ease-out': return 1 - (1 - progress) * (1 - progress)
      case 'ease-in-out': return progress < 0.5 
        ? 2 * progress * progress 
        : 1 - 2 * (1 - progress) * (1 - progress)
      default: return progress
    }
  }
}
```

## 🎨 用户界面设计

### 关键帧时间轴

#### 界面布局
```
┌─────────────────────────────────────────────────────────┐
│ 属性面板                                                │
├─────────────────────────────────────────────────────────┤
│ 位置 X  ●────────●────────────●─────────────────────── │
│ 位置 Y  ●──────────────●──────────●─────────────────── │
│ 缩放    ●────────────────────────────●─────────────── │
│ 旋转    ●──────────────────────────────────●───────── │
│ 透明度  ●────────●────────●────────●─────────────── │
├─────────────────────────────────────────────────────────┤
│ 时间轴  0s    1s    2s    3s    4s    5s    6s    7s   │
└─────────────────────────────────────────────────────────┘
```

#### 关键帧表示
- **关键帧点**：圆形标记表示关键帧位置
- **动画曲线**：连接关键帧的贝塞尔曲线
- **选中状态**：高亮显示选中的关键帧
- **缓动指示**：不同颜色表示不同的缓动类型

### 属性编辑器

#### 关键帧属性面板
```vue
<template>
  <div class="keyframe-editor">
    <div class="property-tracks">
      <div 
        v-for="track in animationTracks" 
        :key="track.id"
        class="property-track"
      >
        <div class="track-header">
          <span class="property-name">{{ track.property }}</span>
          <button @click="addKeyframe(track.property)">+</button>
        </div>
        
        <div class="track-timeline">
          <div 
            v-for="keyframe in track.keyframes"
            :key="keyframe.id"
            class="keyframe-point"
            :style="{ left: `${timeToPixel(keyframe.time)}px` }"
            @click="selectKeyframe(keyframe)"
          />
        </div>
      </div>
    </div>
    
    <div class="keyframe-properties" v-if="selectedKeyframe">
      <label>时间: 
        <input 
          v-model.number="selectedKeyframe.time" 
          type="number" 
          step="0.1"
          @change="updateKeyframe"
        />
      </label>
      
      <label>值: 
        <input 
          v-model="selectedKeyframe.value" 
          type="number"
          @change="updateKeyframe"
        />
      </label>
      
      <label>缓动: 
        <select v-model="selectedKeyframe.easing" @change="updateKeyframe">
          <option value="linear">线性</option>
          <option value="ease-in">缓入</option>
          <option value="ease-out">缓出</option>
          <option value="ease-in-out">缓入缓出</option>
        </select>
      </label>
    </div>
  </div>
</template>
```

## 🎮 操作流程

### 创建关键帧动画

#### 基础流程
1. **选择对象**：在时间轴选择要添加动画的视频片段
2. **选择属性**：在关键帧面板选择要动画的属性
3. **设置起始帧**：在时间轴开始位置设置初始关键帧
4. **移动时间**：拖拽时间轴播放头到目标时间
5. **设置结束帧**：修改属性值并自动创建关键帧
6. **预览动画**：播放时间轴查看动画效果

#### 高级操作
```typescript
// 批量创建关键帧
function createFadeInAnimation(spriteId: string, duration: number) {
  const keyframeManager = useKeyframeManager()
  
  // 起始关键帧（透明）
  keyframeManager.addKeyframe(spriteId, 'opacity', 0, 0, 'ease-out')
  
  // 结束关键帧（不透明）
  keyframeManager.addKeyframe(spriteId, 'opacity', duration, 1, 'ease-out')
  
  // 应用到WebAV
  keyframeManager.applyAnimationToSprite(spriteId)
}

// 复制动画到其他对象
function copyAnimationToSprite(fromSpriteId: string, toSpriteId: string) {
  const sourceClip = keyframeManager.getAnimationClip(fromSpriteId)
  if (sourceClip) {
    const newClip = cloneAnimationClip(sourceClip, toSpriteId)
    keyframeManager.setAnimationClip(toSpriteId, newClip)
    keyframeManager.applyAnimationToSprite(toSpriteId)
  }
}
```

## 🔧 WebAV集成

### 动画数据转换

#### 转换为WebAV格式
```typescript
function convertToWebAVAnimation(track: AnimationTrack): WebAVKeyframe[] {
  return track.keyframes.map(keyframe => ({
    time: keyframe.time * 1000000, // 转换为微秒
    value: keyframe.value,
    easing: keyframe.easing
  }))
}

// 应用动画到WebAV精灵
function applyAnimationToWebAV(sprite: VideoVisibleSprite, clip: AnimationClip) {
  clip.tracks.forEach(track => {
    if (track.keyframes.length > 1) {
      const webavKeyframes = convertToWebAVAnimation(track)
      sprite.setAnimation(track.property, webavKeyframes)
    }
  })
}
```

### 实时同步

#### 属性变化监听
```typescript
// 监听精灵属性变化，自动创建关键帧
sprite.on('propsChange', (props: SpriteProperties) => {
  const currentTime = videoStore.currentTime
  
  // 检查是否需要创建新关键帧
  Object.keys(props).forEach(property => {
    const newValue = props[property]
    const existingKeyframe = keyframeManager.getKeyframeAtTime(
      sprite.id, 
      property, 
      currentTime
    )
    
    if (!existingKeyframe) {
      // 创建新关键帧
      keyframeManager.addKeyframe(
        sprite.id,
        property,
        currentTime,
        newValue
      )
    } else {
      // 更新现有关键帧
      keyframeManager.updateKeyframe(existingKeyframe.id, { value: newValue })
    }
  })
})
```

## 🎯 预设动画

### 常用动画模板

#### 内置动画预设
```typescript
const ANIMATION_PRESETS = {
  fadeIn: {
    name: '淡入',
    duration: 1,
    keyframes: [
      { property: 'opacity', time: 0, value: 0, easing: 'ease-out' },
      { property: 'opacity', time: 1, value: 1, easing: 'ease-out' }
    ]
  },
  
  slideInLeft: {
    name: '从左滑入',
    duration: 1,
    keyframes: [
      { property: 'x', time: 0, value: -200, easing: 'ease-out' },
      { property: 'x', time: 1, value: 0, easing: 'ease-out' }
    ]
  },
  
  scaleUp: {
    name: '放大',
    duration: 0.5,
    keyframes: [
      { property: 'scaleX', time: 0, value: 0, easing: 'ease-out' },
      { property: 'scaleY', time: 0, value: 0, easing: 'ease-out' },
      { property: 'scaleX', time: 0.5, value: 1, easing: 'ease-out' },
      { property: 'scaleY', time: 0.5, value: 1, easing: 'ease-out' }
    ]
  },
  
  rotate360: {
    name: '旋转360度',
    duration: 2,
    keyframes: [
      { property: 'rotation', time: 0, value: 0, easing: 'linear' },
      { property: 'rotation', time: 2, value: Math.PI * 2, easing: 'linear' }
    ]
  }
}

// 应用预设动画
function applyAnimationPreset(spriteId: string, presetName: string, startTime: number = 0) {
  const preset = ANIMATION_PRESETS[presetName]
  if (!preset) return
  
  preset.keyframes.forEach(keyframeData => {
    keyframeManager.addKeyframe(
      spriteId,
      keyframeData.property,
      startTime + keyframeData.time,
      keyframeData.value,
      keyframeData.easing
    )
  })
  
  keyframeManager.applyAnimationToSprite(spriteId)
}
```

## 🔮 未来功能

### 计划实现
- **曲线编辑器**：贝塞尔曲线编辑器，精确控制动画曲线
- **动画图层**：支持多层动画的叠加和混合
- **动画组**：将多个对象的动画组合为一个动画组
- **动画导入导出**：支持动画数据的导入导出

### 高级功能
- **物理动画**：基于物理引擎的真实动画效果
- **路径动画**：沿着自定义路径的运动动画
- **粒子系统**：粒子效果的动画支持
- **3D动画**：三维空间的动画效果

### 性能优化
- **动画缓存**：缓存计算结果提升性能
- **LOD系统**：根据视图距离调整动画精度
- **并行计算**：利用Web Workers进行动画计算
- **GPU加速**：利用WebGL进行动画渲染

## 🧪 开发计划

### 第一阶段：基础框架
- 关键帧数据结构设计
- 基础的关键帧管理器
- 简单的线性插值
- WebAV集成接口

### 第二阶段：用户界面
- 关键帧时间轴界面
- 属性编辑面板
- 关键帧的增删改查
- 实时预览功能

### 第三阶段：高级功能
- 多种缓动函数支持
- 动画预设系统
- 批量操作功能
- 动画导入导出

### 第四阶段：优化完善
- 性能优化
- 用户体验改进
- 错误处理完善
- 文档和教程

## 🔗 相关文档

- [架构设计](../03-开发文档/架构设计.md) - 系统架构设计
- [API文档](../03-开发文档/API文档.md) - WebAV API接口
- [操作历史系统](操作历史系统.md) - 撤销/重做功能
- [未来计划](../06-项目规划/未来计划.md) - 项目发展路线图

---

**提示**：关键帧动画系统是视频编辑器的高级功能，将为用户提供专业级的动画制作能力，是项目向专业视频编辑软件发展的重要里程碑。
