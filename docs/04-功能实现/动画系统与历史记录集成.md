# åŠ¨ç”»ç³»ç»Ÿä¸æ“ä½œå†å²ç³»ç»Ÿé›†æˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å¦‚ä½•å°†å…³é”®å¸§åŠ¨ç”»ç³»ç»Ÿä¸æ“ä½œå†å²ç³»ç»Ÿå®Œç¾é›†æˆï¼Œå®ç°ç»Ÿä¸€çš„æ’¤é”€/é‡åšåŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒåŠ¨ç”»å’ŒéåŠ¨ç”»clipçš„æ“ä½œä¸€è‡´æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

### ä¸»è¦ç›®æ ‡
- **ç»Ÿä¸€æ“ä½œä½“éªŒ**ï¼šåŠ¨ç”»å’ŒéåŠ¨ç”»clipçš„å±æ€§ä¿®æ”¹ä½“éªŒä¸€è‡´
- **å®Œæ•´å†å²è®°å½•**ï¼šæ‰€æœ‰å…³é”®å¸§æ“ä½œéƒ½æ”¯æŒæ’¤é”€/é‡åš
- **æ™ºèƒ½æ“ä½œè·¯ç”±**ï¼šæ ¹æ®clipçŠ¶æ€è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ“ä½œæ–¹å¼
- **çŠ¶æ€ç®¡ç†æ¸…æ™°**ï¼šæ˜ç¡®çš„åŠ¨ç”»/éåŠ¨ç”»çŠ¶æ€åˆ¤æ–­å’Œè½¬æ¢

### è®¾è®¡åŸåˆ™
1. **æ™ºèƒ½è·¯ç”±åŸåˆ™**ï¼šæ ¹æ®`animationConfig`çŠ¶æ€è‡ªåŠ¨é€‰æ‹©æ“ä½œæ–¹å¼
2. **ç»Ÿä¸€æ¥å£åŸåˆ™**ï¼šå±æ€§é¢æ¿ä½¿ç”¨ç»Ÿä¸€çš„æ›´æ–°æ–¹æ³•
3. **å®Œæ•´è®°å½•åŸåˆ™**ï¼šæ‰€æœ‰æ“ä½œéƒ½é€šè¿‡Commandæ¨¡å¼è®°å½•
4. **çŠ¶æ€ä¸€è‡´åŸåˆ™**ï¼šç¡®ä¿UIæ˜¾ç¤ºä¸å®é™…çŠ¶æ€åŒæ­¥

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒåˆ¤æ–­é€»è¾‘
```typescript
// åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰åŠ¨ç”»çš„clip
const hasAnimation = computed(() => {
  return selectedTimelineItem.value?.animationConfig !== null && 
         selectedTimelineItem.value?.animationConfig !== undefined
})
```

### æ“ä½œåˆ†ç±»ä½“ç³»

#### æ— åŠ¨ç”»clipæ“ä½œ
```typescript
UpdateTransformCommand // å·²å­˜åœ¨ï¼Œç›´æ¥ä¿®æ”¹TimelineItemå±æ€§
```

#### æœ‰åŠ¨ç”»clipæ“ä½œï¼ˆæ–°å¢ï¼‰
```typescript
CreateKeyFrameCommand    // åˆ›å»ºå…³é”®å¸§
RemoveKeyFrameCommand    // åˆ é™¤å…³é”®å¸§  
UpdateKeyFrameCommand    // æ›´æ–°å…³é”®å¸§å€¼
ClearAnimationCommand    // æ¸…é™¤æ‰€æœ‰åŠ¨ç”»
ToggleAnimationCommand   // å¯ç”¨/ç¦ç”¨åŠ¨ç”»
```

### æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ

#### æ ¸å¿ƒè·¯ç”±æ–¹æ³•
```typescript
const updatePropertySmart = async (property: AnimatableProperty, newValue: number) => {
  if (!selectedTimelineItem.value) return
  
  const oldValue = getCurrentPropertyValue(selectedTimelineItem.value, property)
  if (oldValue === newValue) return

  if (hasAnimation.value) {
    // æœ‰åŠ¨ç”»ï¼šé€šè¿‡å…³é”®å¸§å‘½ä»¤æ›´æ–°
    await videoStore.createKeyFrameWithHistory(
      selectedTimelineItem.value.id,
      property,
      newValue
    )
  } else {
    // æ— åŠ¨ç”»ï¼šé€šè¿‡å˜æ¢å‘½ä»¤æ›´æ–°
    await updatePropertyWithHistory(property, newValue)
  }
}
```

#### å±æ€§å€¼æ˜¾ç¤ºé€»è¾‘
```typescript
const transformX = computed({
  get: () => {
    if (!selectedTimelineItem.value) return 0
    
    if (hasAnimation.value) {
      // æœ‰åŠ¨ç”»ï¼šæ˜¾ç¤ºå½“å‰æ—¶é—´ç‚¹çš„æ’å€¼
      return getPropertyValueAtTime(
        selectedTimelineItem.value,
        'x',
        videoStore.currentTime
      )
    } else {
      // æ— åŠ¨ç”»ï¼šæ˜¾ç¤ºTimelineItemå±æ€§
      return selectedTimelineItem.value.x
    }
  },
  set: (value: number) => {
    updatePropertySmart('x', value)
  }
})
```

## ğŸ”§ å®ç°ç»†èŠ‚

### VideoStoreæ‰©å±•æ–¹æ³•

#### å…³é”®å¸§æ“ä½œæ–¹æ³•
```typescript
/**
 * å¸¦å†å²è®°å½•çš„åˆ›å»ºå…³é”®å¸§æ–¹æ³•
 */
async function createKeyFrameWithHistory(
  timelineItemId: string,
  property: AnimatableProperty,
  value?: number,
  time?: number
): Promise<void> {
  const timelineItem = timelineModule.getTimelineItem(timelineItemId)
  if (!timelineItem) return

  const targetTime = time ?? currentTime.value
  const targetValue = value ?? getCurrentPropertyValue(timelineItem, property)

  const command = new CreateKeyFrameCommand(
    timelineItemId,
    property,
    targetTime,
    targetValue,
    { getTimelineItem: timelineModule.getTimelineItem },
    videoResolution.value
  )
  
  await historyModule.executeCommand(command)
}

/**
 * å¸¦å†å²è®°å½•çš„åˆ é™¤å…³é”®å¸§æ–¹æ³•
 */
async function removeKeyFrameWithHistory(
  timelineItemId: string,
  property: AnimatableProperty,
  time?: number
): Promise<void> {
  const targetTime = time ?? currentTime.value

  const command = new RemoveKeyFrameCommand(
    timelineItemId,
    property,
    targetTime,
    { getTimelineItem: timelineModule.getTimelineItem },
    videoResolution.value
  )
  
  await historyModule.executeCommand(command)
}
```

### å±æ€§é¢æ¿é‡æ„

#### ç»Ÿä¸€çš„å±æ€§è¾“å…¥ç»‘å®š
```typescript
// æ›¿æ¢æ‰€æœ‰ç°æœ‰çš„å±æ€§ç»‘å®š
// ä»ï¼š@change="(value) => updatePropertyWithHistory('x', value)"
// åˆ°ï¼š@change="(value) => updatePropertySmart('x', value)"

<NumberInput
  :model-value="transformX"
  @change="(value) => updatePropertySmart('x', value)"
  :min="-videoStore.videoResolution.width"
  :max="videoStore.videoResolution.width"
  :step="1"
  :precision="0"
  placeholder="ä¸­å¿ƒä¸º0"
  :input-style="positionInputStyle"
/>
```

#### å…³é”®å¸§æŒ‰é’®è¡Œä¸º
```typescript
const handleToggleKeyFrame = async (property: AnimatableProperty) => {
  if (!selectedTimelineItem.value) return

  if (hasKeyFrameAtTime(property)) {
    // åˆ é™¤å…³é”®å¸§
    await videoStore.removeKeyFrameWithHistory(
      selectedTimelineItem.value.id,
      property
    )
  } else {
    // åˆ›å»ºå…³é”®å¸§
    await videoStore.createKeyFrameWithHistory(
      selectedTimelineItem.value.id,
      property
    )
  }
}
```

## ğŸ”„ çŠ¶æ€è½¬æ¢å¤„ç†

### é¦–æ¬¡åˆ›å»ºåŠ¨ç”»
```typescript
const initializeAnimation = async (property: AnimatableProperty) => {
  if (!selectedTimelineItem.value || hasAnimation.value) return
  
  const currentValue = getCurrentPropertyValue(selectedTimelineItem.value, property)
  
  // æ‰¹é‡æ“ä½œï¼šåˆ›å»ºåˆå§‹å…³é”®å¸§ + å½“å‰å…³é”®å¸§
  const batch = videoStore.startBatch('åˆå§‹åŒ–åŠ¨ç”»')
  
  // åœ¨æ—¶é—´0åˆ›å»ºåˆå§‹å…³é”®å¸§
  batch.addCommand(new CreateKeyFrameCommand(
    selectedTimelineItem.value.id,
    property,
    0,
    currentValue,
    timelineModule,
    videoStore.videoResolution
  ))
  
  // åœ¨å½“å‰æ—¶é—´åˆ›å»ºå…³é”®å¸§
  batch.addCommand(new CreateKeyFrameCommand(
    selectedTimelineItem.value.id,
    property,
    videoStore.currentTime,
    currentValue,
    timelineModule,
    videoStore.videoResolution
  ))
  
  await videoStore.executeBatchCommand(batch.build())
}
```

### æ¸…é™¤åŠ¨ç”»è½¬ä¸ºé™æ€
```typescript
const finalizeToStaticValue = async () => {
  if (!selectedTimelineItem.value || !hasAnimation.value) return
  
  // è·å–å½“å‰æ—¶é—´ç‚¹çš„æ’å€¼ä½œä¸ºæœ€ç»ˆé™æ€å€¼
  const finalValues: Record<string, number> = {}
  const animatableProperties: AnimatableProperty[] = ['x', 'y', 'width', 'height', 'rotation', 'opacity']
  
  animatableProperties.forEach(property => {
    finalValues[property] = getPropertyValueAtTime(
      selectedTimelineItem.value!,
      property,
      videoStore.currentTime
    )
  })
  
  // æ‰¹é‡æ“ä½œï¼šæ¸…é™¤åŠ¨ç”» + è®¾ç½®æœ€ç»ˆå€¼
  const batch = videoStore.startBatch('è½¬æ¢ä¸ºé™æ€å±æ€§')
  
  batch.addCommand(new ClearAnimationCommand(
    selectedTimelineItem.value.id,
    timelineModule
  ))
  
  batch.addCommand(new UpdateTransformCommand(
    selectedTimelineItem.value.id,
    'transform',
    {},
    finalValues,
    timelineModule,
    mediaModule,
    clipOperationsModule
  ))
  
  await videoStore.executeBatchCommand(batch.build())
}
```

## ğŸ“Š å®ç°è®¡åˆ’

### é˜¶æ®µ1ï¼šåŸºç¡€æ¶æ„ï¼ˆç¬¬1-2å‘¨ï¼‰
1. åˆ›å»ºå…³é”®å¸§Commandç±»
2. æ‰©å±•VideoStoreæ–¹æ³•
3. åŸºç¡€æµ‹è¯•éªŒè¯

### é˜¶æ®µ2ï¼šå±æ€§é¢æ¿é‡æ„ï¼ˆç¬¬3å‘¨ï¼‰
1. å®ç°æ™ºèƒ½è·¯ç”±é€»è¾‘
2. ä¿®æ”¹å±æ€§è¾“å…¥ç»„ä»¶ç»‘å®š
3. ä¼˜åŒ–å±æ€§å€¼æ˜¾ç¤º

### é˜¶æ®µ3ï¼šè¾¹ç•Œæƒ…å†µå¤„ç†ï¼ˆç¬¬4å‘¨ï¼‰
1. åŠ¨ç”»çŠ¶æ€è½¬æ¢
2. æ‰¹é‡æ“ä½œæ”¯æŒ
3. å¤šé€‰çŠ¶æ€å¤„ç†

### é˜¶æ®µ4ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆç¬¬5å‘¨ï¼‰
1. å…¨é¢åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. ç”¨æˆ·ä½“éªŒå®Œå–„

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒ
- **ä¸€è‡´çš„æ“ä½œæ„Ÿå—**ï¼šæ— è®ºæ˜¯å¦æœ‰åŠ¨ç”»ï¼Œå±æ€§ä¿®æ”¹ä½“éªŒç›¸åŒ
- **å®Œæ•´çš„æ’¤é”€æ”¯æŒ**ï¼šæ‰€æœ‰æ“ä½œéƒ½å¯ä»¥æ’¤é”€/é‡åš
- **æ™ºèƒ½çš„çŠ¶æ€ç®¡ç†**ï¼šç³»ç»Ÿè‡ªåŠ¨å¤„ç†åŠ¨ç”»/éåŠ¨ç”»çŠ¶æ€

### æŠ€æœ¯ä¼˜åŠ¿
- **æ¸…æ™°çš„æ¶æ„åˆ†ç¦»**ï¼šåŠ¨ç”»é€»è¾‘ä¸å†å²è®°å½•é€»è¾‘è§£è€¦
- **å¯æ‰©å±•çš„è®¾è®¡**ï¼šæ˜“äºæ·»åŠ æ–°çš„åŠ¨ç”»åŠŸèƒ½
- **ç¨³å®šçš„çŠ¶æ€ç®¡ç†**ï¼šé¿å…çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜

è¿™ä¸ªé›†æˆæ–¹æ¡ˆç¡®ä¿äº†åŠ¨ç”»ç³»ç»Ÿä¸æ“ä½œå†å²ç³»ç»Ÿçš„å®Œç¾ç»“åˆï¼Œä¸ºç”¨æˆ·æä¾›äº†ç»Ÿä¸€ã€å¯é çš„ç¼–è¾‘ä½“éªŒã€‚
