# 双向数据流架构

## 📋 概述

本文档描述了视频编辑器中新实现的双向数据流架构，该架构特别适合关键帧动画系统，能够实现UI与Sprite属性的实时同步。

## 🔄 数据流向

### 新架构数据流
```
UI变化 → Sprite属性更新 → propsChange事件 → Store同步 → UI反馈
```

### 与旧架构的对比
```
旧架构: UI → TimelineItem → Sprite (单向)
新架构: UI ↔ Sprite ↔ Store (双向同步)
```

## 🏗️ 架构组件

### 1. Sprite事件系统

#### 使用原生VisibleSprite事件系统
- 利用WebAV原生的 `sprite.on('propsChange', callback)` 事件
- 无需自定义事件系统，直接使用已有的属性变化检测
- 返回移除函数用于清理事件监听器

```typescript
// 事件监听（使用原生API）
const removeListener = sprite.on('propsChange', (changes) => {
  console.log('Sprite属性变化:', changes)
})

// 清理事件监听器
removeListener()
```

#### 原生属性变化检测
- WebAV内置的属性变化检测机制
- 自动监听位置、尺寸、旋转、透明度、层级等属性
- 高性能的原生实现

### 2. TimelineItem响应式代理

#### 新的getter/setter模式
```typescript
// TimelineItem作为Sprite的响应式代理
get x(): number {
  // 直接从sprite读取最新值
  return webavToProjectCoords(sprite.rect.x, ...)
},
set x(value: number) {
  // 直接设置sprite属性，原生事件系统会处理变化检测
  sprite.rect.x = webavCoords.x
  sprite.rect.y = webavCoords.y
}
```

### 3. 事件同步管理器

#### SpriteEventSyncManager
- 统一管理sprite事件监听器
- 自动设置和清理事件监听
- 支持属性变化数据转换

```typescript
// 设置事件监听（使用原生API）
SpriteEventSyncManager.setupSpriteEventListeners(
  timelineItem,
  onPropsChange
)

// 清理事件监听（自动调用原生移除函数）
SpriteEventSyncManager.removeSpriteEventListenersWithSprite(timelineItem)
```

### 4. Store同步机制

#### handleSpritePropsChange
- 处理sprite属性变化事件
- 触发UI响应式更新
- 保持数据一致性

```typescript
function handleSpritePropsChange(timelineItemId: string, changes: any): void {
  // TimelineItem的getter会自动读取sprite最新值
  // 只需触发UI重新渲染
  if (isSelectedItem(timelineItemId)) {
    forceUIUpdate()
  }
}
```

## 🎯 关键特性

### 1. 实时同步
- **动画播放时**: sprite属性实时变化 → UI实时更新
- **用户操作时**: UI修改 → sprite立即响应
- **双向一致性**: 无论哪一方变化，另一方都能同步

### 2. 原生性能优化
- 利用WebAV内置的高性能属性检测
- 原生C++级别的变化监听
- 无需额外的性能开销

### 3. 简化的架构
- 无需自定义防循环机制
- 直接使用原生事件系统
- 更稳定可靠的实现

### 4. 类型安全
- 完整的TypeScript类型定义
- 事件数据结构化
- 编译时错误检查

## 🔧 使用场景

### 1. 关键帧动画
```typescript
// 动画播放时，UI自动显示当前帧的属性值
// 用户修改属性时，立即创建关键帧
if (hasAnimation) {
  await videoStore.createKeyFrameWithHistory(itemId, property, newValue)
} else {
  await videoStore.updateTimelineItemTransformWithHistory(itemId, transform)
}
```

### 2. 实时预览
- 拖拽操作时实时更新属性面板
- 属性面板修改时实时更新预览
- 动画播放时属性面板实时显示当前值

### 3. 多选操作
- 多个sprite同时变化时批量同步
- 保持所有选中项的属性一致性

## 📊 性能优化

### 1. 事件防抖
- 属性变化检测使用阈值过滤微小变化
- 避免频繁触发不必要的事件

### 2. 批量更新
- 支持批量属性变化的统一处理
- 减少UI重渲染次数

### 3. 内存管理
- 自动清理事件监听器
- 避免内存泄漏

## 🚀 未来扩展

### 1. 更多属性支持
- 滤镜效果属性
- 动画曲线属性
- 自定义属性

### 2. 性能优化
- 虚拟化大量sprite的属性检测
- 智能检测频率调整

### 3. 调试工具
- 属性变化可视化
- 事件流追踪
- 性能监控

## 📝 注意事项

1. **原生API**: 使用WebAV原生的 `sprite.on('propsChange', callback)` API
2. **事件清理**: 组件销毁时必须调用返回的移除函数清理事件监听器
3. **类型检查**: 确保事件数据的类型安全
4. **性能优势**: 利用原生实现的高性能属性检测

---

这个双向数据流架构为视频编辑器提供了强大的实时同步能力，特别适合复杂的动画编辑场景。
