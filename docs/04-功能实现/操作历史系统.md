# 操作历史系统

## 📋 概述

操作历史系统为视频编辑器提供完整的撤销/重做功能，支持所有核心编辑操作的历史记录管理。系统采用命令模式设计，支持单个操作和批量操作的统一管理。

## 🎯 核心特性

### ✅ 已实现功能

#### 基础操作支持
- **时间轴项目管理**：添加、删除、移动、复制时间轴项目
- **属性变更**：位置、大小、旋转、透明度、音量、静音状态
- **轨道管理**：添加、删除、重命名轨道，切换可见性和静音
- **时间范围调整**：拖拽边缘调整项目时长

#### 批量操作支持
- **批量删除**：同时删除多个时间轴项目
- **自动排列**：单轨道内项目的自动排列
- **批量属性修改**：同时修改多个项目的属性

#### 高级功能
- **命令合并**：连续相同操作自动合并
- **依赖验证**：检查操作依赖的素材是否存在
- **内存管理**：限制历史记录数量，优化内存使用

## 🏗️ 技术架构

### 核心组件

#### Command接口体系
```typescript
interface Command {
  id: string
  type: string
  description: string
  timestamp: number
  execute(): Promise<void> | void
  undo(): Promise<void> | void
  canMerge?(other: Command): boolean
  merge?(other: Command): Command
  validateDependencies?(): boolean
}
```

#### HistoryManager
- 管理命令历史栈
- 执行撤销/重做逻辑
- 处理命令合并
- 内存管理和性能优化
- 支持批量操作管理

#### 批量操作架构
```typescript
abstract class BaseBatchCommand implements Command {
  protected subCommands: Command[] = []
  
  async execute(): Promise<void> {
    for (const command of this.subCommands) {
      await command.execute()
    }
  }
  
  async undo(): Promise<void> {
    for (let i = this.subCommands.length - 1; i >= 0; i--) {
      await this.subCommands[i].undo()
    }
  }
}
```

### 设计原则

#### "从源头重建"原则
- 每次撤销/重做都从原始素材重新创建对象
- 避免WebAV资源的复用和"Reader is closed"错误
- 保存完整的重建元数据

#### 模块化集成
- 与现有videoStore无缝集成
- 不影响现有功能的正常使用
- 支持异步操作和错误处理

## 🎮 使用方式

### 基础操作
```typescript
// 添加时间轴项目（自动记录历史）
await videoStore.addTimelineItemWithHistory(timelineItem)

// 删除时间轴项目
await videoStore.removeTimelineItemWithHistory(itemId)

// 更新属性
await videoStore.updateTimelineItemTransformWithHistory(itemId, 'position', newPosition)
```

### 动画系统操作
```typescript
// 创建关键帧（自动记录历史）
await videoStore.createKeyFrameWithHistory(itemId, 'x', 100, 2.5)

// 删除关键帧
await videoStore.removeKeyFrameWithHistory(itemId, 'opacity')

// 清除所有动画
await videoStore.clearAnimationWithHistory(itemId)

// 智能属性更新（根据动画状态自动选择操作方式）
await updatePropertySmart('rotation', 45)
```

### 批量操作
```typescript
// 方式1：直接使用专用批量命令
const success = await videoStore.batchDeleteTimelineItems(['item1', 'item2'])

// 方式2：使用构建器模式
const batch = videoStore.startBatch('自定义批量操作')
batch.addCommand(new AddTimelineItemCommand(...))
batch.addCommand(new UpdateTransformCommand(...))
const batchCommand = batch.build()
await videoStore.executeBatchCommand(batchCommand)
```

### 撤销/重做
```typescript
// 撤销
const success = await videoStore.undo()

// 重做
const success = await videoStore.redo()

// 检查状态
const canUndo = videoStore.canUndo
const canRedo = videoStore.canRedo
```

## 📊 支持的操作类型

### 🔥 高优先级操作（已完成）
- ✅ AddTimelineItemCommand - 添加时间轴项目
- ✅ RemoveTimelineItemCommand - 删除时间轴项目
- ✅ MoveTimelineItemCommand - 移动时间轴项目
- ✅ UpdateTransformCommand - 更新变换属性
- ✅ DuplicateTimelineItemCommand - 复制时间轴项目
- ✅ AddTrackCommand - 添加轨道
- ✅ RemoveTrackCommand - 删除轨道
- ✅ AutoArrangeTrackCommand - 单轨道自动排列

### 🟡 中优先级操作（已完成）
- ✅ RenameTrackCommand - 重命名轨道
- ✅ ToggleTrackVisibilityCommand - 切换轨道可见性
- ✅ ToggleTrackMuteCommand - 切换轨道静音
- ✅ ResizeTimelineItemCommand - 时间范围调整
- ✅ SelectTimelineItemsCommand - 选择操作（单选/多选）

### 🎬 动画系统操作（新增）
- ✅ CreateKeyFrameCommand - 创建关键帧
- ✅ RemoveKeyFrameCommand - 删除关键帧
- ✅ UpdateKeyFrameCommand - 更新关键帧值
- ✅ ClearAnimationCommand - 清除动画配置
- ✅ ToggleAnimationCommand - 启用/禁用动画

### 🟢 低优先级操作（待实现）
- ⏳ SetVideoResolutionCommand - 修改视频分辨率
- ⏳ SetFrameRateCommand - 修改帧率
- ⏳ RenameMediaItemCommand - 重命名素材

### 🚫 明确不支持的操作
- **删除素材** - 用警告对话框替代
- **修改时间轴总时长** - 基于内容自动计算
- **调整轨道高度** - 纯UI布局操作

## 🔧 配置和优化

### 性能配置
```typescript
// 历史记录数量限制
const maxHistorySize = 50

// 命令合并时间窗口
const mergeTimeWindow = 1000 // 1秒

// 内存优化
const enableMemoryOptimization = true
```

### 错误处理
- **依赖验证**：检查素材是否存在
- **异常捕获**：完善的错误提示机制
- **状态恢复**：操作失败时的状态回滚

## 📈 性能特点

### 优化策略
- **Vue响应式优化**：依赖Vue的内置性能优化
- **WebAV优化**：利用WebAV的内部优化机制
- **简洁设计**：避免过度工程化的复杂性

### 内存管理
- 限制历史记录数量（默认50条）
- 自动清理过期命令
- 智能资源回收

## 🎯 实际应用场景

### 基础编辑场景
1. **添加视频片段**：从素材库拖拽视频到时间轴
2. **调整位置**：拖拽片段到新的时间位置
3. **修改属性**：调整大小、旋转、透明度等
4. **撤销操作**：一键撤销任何不满意的修改

### 批量编辑场景
1. **多选删除**：选择多个片段并批量删除
2. **自动排列**：整理轨道内所有片段的排列
3. **批量属性修改**：同时调整多个片段的属性
4. **批量撤销**：一次撤销整个批量操作

### 复杂编辑场景
1. **轨道管理**：添加、删除、重命名轨道
2. **时长调整**：拖拽片段边缘调整时长
3. **复制粘贴**：复制片段到其他位置
4. **错误恢复**：操作失败时自动回滚状态

### 动画编辑场景
1. **关键帧创建**：在时间轴上设置关键帧点
2. **动画调整**：修改关键帧属性值
3. **动画清除**：移除所有动画效果
4. **状态转换**：在静态属性和动画属性间切换
5. **批量动画**：初始化动画时的批量关键帧创建

## 🎉 实现成果

### 功能完整性
- ✅ 支持所有核心编辑操作
- ✅ 批量操作统一管理
- ✅ 完善的错误处理机制

### 用户体验
- ✅ 操作直观，一键撤销复杂操作
- ✅ 反馈清晰，详细的操作描述
- ✅ 性能流畅，无明显延迟

### 代码质量
- ✅ 类型安全的TypeScript实现
- ✅ 模块化架构，易于维护
- ✅ 完整的测试覆盖

## 🔮 未来扩展

### 计划功能
- **操作历史面板**：可视化的历史记录管理
- **选择性撤销**：撤销历史中的特定操作
- **操作分组**：相关操作的逻辑分组
- **历史导出**：导出操作历史用于分析

### 性能优化
- **增量更新**：只更新变化的部分
- **后台处理**：大型操作的后台执行
- **内存池**：命令对象的内存池管理
- **压缩存储**：历史记录的压缩存储

## 🔗 相关文档

- [批量操作](批量操作.md) - 批量操作的详细实现
- [选择系统](选择系统.md) - 选择管理和同步机制
- [拖拽系统](拖拽系统.md) - 统一的拖拽操作系统
- [架构设计](../03-开发文档/架构设计.md) - 系统架构设计

---

**提示**：操作历史系统是视频编辑器的核心功能之一，为用户提供了强大的撤销/重做能力，大大提升了编辑的容错性和用户体验。
