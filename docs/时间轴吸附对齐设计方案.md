# 时间轴吸附对齐设计方案

## 概述

本文档详细描述了视频编辑器时间轴吸附对齐功能的完整设计方案，包括核心算法、视觉反馈、性能优化和集成实施方案。

## 1. 核心架构设计

### 1.1 吸附类型与优先级体系

基于现有代码结构 [`SnapPoint`](frontend/src/types/snap.ts) 类型，建立分层优先级机制：

```
优先级 1 (高): 片段边界
优先级 2 (中): 关键帧  
优先级 3 (低): 时间轴起始位置
```

### 1.2 吸附计算引擎

```typescript
interface SnapCalculationEngine {
  calculateSnap(
    sourceFrame: number,
    options: SnapCalculationOptions
  ): SnapResult
  
  collectSnapPoints(options: SnapPointCollectionOptions): SnapPoint[]
}
```

## 2. 算法实现方案

### 2.1 核心计算逻辑

吸附决策流程：
```
拖拽位置 → 收集候选吸附点 → 距离计算 → 优先级排序 → 阈值检查 → 结果返回
```

### 2.2 候选点收集

- **片段边界**: 收集所有片段的起始和结束位置
- **关键帧**: 收集片段内的关键帧时间点
- **时间轴起始**: frame = 0 的固定位置

### 2.3 距离计算

```typescript
function calculateSnapDistance(
  sourceFrame: number,
  candidateFrame: number
): number {
  const pixelDistance = Math.abs(
    unifiedStore.frameToPixel(sourceFrame) - 
    unifiedStore.frameToPixel(candidateFrame)
  )
  return pixelDistance
}
```

## 3. 视觉反馈系统

### 3.1 吸附指示器

```typescript
interface SnapIndicator {
  showConnectedLine(time: number, point: SnapPoint): void
  hideAll(): void
}
```

### 3.2 视觉元素

#### 颜色编码
- 片段边界: `#4CAF50` (绿色)
- 关键帧: `#2196F3` (蓝色) 
- 时间轴起始: `#9C27B0` (紫色)

#### 视觉状态
- **吸附线**: 垂直线在吸附点位置
- **透明度**: 吸附时显示，完成后渐隐

## 4. 性能优化策略

### 4.1 范围限制

```typescript
interface PerformanceOptimizer {
  limitToViewport: boolean      // 视口范围内计算
  useCache: boolean            // 启用缓存
}
```

### 4.2 缓存机制

1. **布局缓存**: 片段位置变更时更新缓存
2. **候选点缓存**: 拖拽过程中复用计算结果

## 5. 交互体验设计

### 5.1 拖拽流程

完整拖拽流程：
```
1. 拖拽开始 → 收集候选吸附点
2. 拖拽移动 → 实时计算最近吸附点
3. 接近阈值 → 显示吸附线
4. 释放确认 → 应用吸附结果
5. 拖拽结束 → 清理视觉反馈
```

### 5.2 吸附控制开关

在时间轴控制区域右侧添加吸附开关按钮：
- **开关位置**: 轨道控制区域右上角
- **开关样式**: 磁力图标，可切换状态
- **开关功能**: 点击切换吸附功能启用/禁用状态
- **视觉反馈**: 开关激活时高亮显示，禁用状态下显示为灰色

按钮状态管理：
```typescript
const snapEnabled = ref(true) // 吸附功能开关状态

function toggleSnap() {
  snapEnabled.value = !snapEnabled.value
  unifiedStore.updateSnapConfig({ enabled: snapEnabled.value })
}
```

## 6. 集成实施方案

### 6.1 现有代码集成

基于当前项目结构：

#### 恢复拖拽处理吸附逻辑
在 [`useTimelineDragHandling.ts`](frontend/src/unified/composables/useTimelineDragHandling.ts) 中：
- 移除第98行和第176行的"吸附指示器已禁用"注释
- 重新启用吸附计算和视觉反馈

#### 扩展现有吸附类型
在 [`snap.ts`](frontend/src/types/snap.ts) 中：
- 基于现有类型扩展
- 保持 [`DEFAULT_SNAP_CONFIG`](frontend/src/types/snap.ts:138) 配置

#### 添加视觉指示器组件
- 创建 `SnapIndicator.vue` 组件
- 集成到 [`UnifiedTimeline.vue`](frontend/src/unified/components/UnifiedTimeline.vue)

#### 添加吸附控制开关
在 [`UnifiedTimeline.vue`](frontend/src/unified/components/UnifiedTimeline.vue) 的轨道控制区域：
- 在轨道管理头部右侧添加磁力图标按钮
- 绑定吸附开关状态管理方法
- 集成到现有的轨道控制按钮组中

### 6.2 代码结构

```typescript
// 新增文件
src/
├── components/
│   └── SnapIndicator.vue          // 吸附指示器组件
├── composables/
│   └── useSnapCalculation.ts      // 吸附计算组合式函数
├── utils/
│   └── snapCalculation.ts         // 吸附算法工具
```

### 6.3 配置保持

使用现有 [`DEFAULT_SNAP_CONFIG`](frontend/src/types/snap.ts:138)：
```typescript
export const DEFAULT_SNAP_CONFIG = {
  enabled: true,
  clipBoundaries: true,
  keyframes: true,
  timelineStart: true,
  threshold: 10,
  visualFeedback: true
}
```

## 7. 质量保障

### 7.1 边界情况处理

1. **空时间轴**: 只提供起始点吸附
2. **高密度片段**: 使用优先级避免歧义
3. **快速拖拽**: 确保平滑体验

### 7.2 性能基准

- 吸附计算响应时间 < 16ms
- 候选点收集时间 < 100ms
- 视觉反馈渲染时间 < 8ms

## 8. 总结

本方案提供了一个简洁高效的时间轴吸附系统，基于现有代码结构 [`snap.ts`](frontend/src/types/snap.ts) 进行设计，确保能够无缝集成到当前的 [`VideoEditor`](frontend/src/views/VideoEditor.vue) 项目中。通过精简的功能设计和优化的性能策略，能够显著提升用户的编辑精度和操作效率。