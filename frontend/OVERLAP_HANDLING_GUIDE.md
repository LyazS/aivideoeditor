# 🔄 视频片段重叠处理功能

## 🎯 功能概述

现在视频预览引擎具备完整的重叠检测和处理机制：
- ✅ **自动重叠检测** - 实时检测片段重叠
- ✅ **智能位置调整** - 自动寻找最近的可用空隙
- ✅ **视觉反馈** - 重叠片段显示红色警告
- ✅ **一键整理** - 自动排列所有片段

## 🔍 重叠检测机制

### 检测逻辑
```typescript
function isOverlapping(clip1: VideoClip, clip2: VideoClip): boolean {
  const clip1Start = clip1.timelinePosition
  const clip1End = clip1.timelinePosition + clip1.duration
  const clip2Start = clip2.timelinePosition
  const clip2End = clip2.timelinePosition + clip2.duration
  
  return !(clip1End <= clip2Start || clip2End <= clip1Start)
}
```

### 触发时机
1. **拖拽片段时** - 实时检测新位置是否重叠
2. **添加新片段时** - 检测拖拽位置是否与现有片段重叠
3. **实时监控** - 持续监控所有片段的重叠状态

## 🛠️ 重叠处理策略

### 1. 智能位置调整
当检测到重叠时，系统会：
1. **寻找最近空隙** - 在时间轴上寻找能容纳片段的空隙
2. **最小移动距离** - 选择距离原位置最近的可用位置
3. **边界检查** - 确保不超出时间轴范围

### 2. 自动排列功能
```typescript
function autoArrangeClips() {
  // 按时间位置排序
  const sortedClips = [...clips].sort((a, b) => a.timelinePosition - b.timelinePosition)
  
  // 依次排列，消除所有重叠
  let currentPosition = 0
  for (const clip of sortedClips) {
    clip.timelinePosition = currentPosition
    currentPosition += clip.duration
  }
}
```

## 🎨 视觉反馈系统

### 重叠片段样式
- **颜色变化**: 蓝色 → 红色渐变
- **边框警告**: 红色边框高亮
- **脉冲动画**: 轻微的脉冲效果提醒用户
- **阴影增强**: 更明显的阴影效果

### 工具栏提示
- **重叠计数**: 显示当前重叠片段数量
- **警告图标**: ⚠️ 图标提醒用户注意
- **一键修复**: "自动排列"按钮快速解决

## 🧪 测试场景

### 场景1: 拖拽重叠
1. 拖拽一个视频片段到另一个片段上
2. **预期**: 片段自动移动到最近的空隙
3. **视觉**: 移动过程中显示红色警告

### 场景2: 新增重叠
1. 拖拽新视频文件到已有片段位置
2. **预期**: 新片段自动调整到可用位置
3. **视觉**: 工具栏显示重叠计数

### 场景3: 多重重叠
1. 创建多个重叠片段
2. 点击"自动排列"按钮
3. **预期**: 所有片段按时间顺序依次排列
4. **视觉**: 重叠警告消失

### 场景4: 边界处理
1. 拖拽片段到时间轴末尾
2. **预期**: 不会超出时间轴范围
3. **视觉**: 片段停留在有效范围内

## 🎮 用户交互

### 拖拽行为
- **正常拖拽**: 片段跟随鼠标移动
- **重叠检测**: 实时计算最佳位置
- **自动吸附**: 释放时自动调整到最近空隙

### 工具栏操作
- **重叠提示**: 实时显示重叠数量
- **自动排列**: 一键解决所有重叠问题
- **视觉反馈**: 操作后立即更新显示

## 💡 智能特性

### 最近空隙算法
1. **收集所有可能位置**:
   - 时间轴开始 (0秒)
   - 每个片段之前
   - 每个片段之后

2. **筛选有效位置**:
   - 检查是否有足够空间
   - 确保不超出时间轴范围
   - 验证不与其他片段重叠

3. **选择最优位置**:
   - 计算与原位置的距离
   - 选择距离最小的有效位置

### 性能优化
- **增量检测**: 只检测移动的片段
- **缓存计算**: 避免重复计算
- **异步处理**: 不阻塞用户界面

## 🎯 使用建议

### 最佳实践
1. **预留空隙**: 在片段间留出适当间隔
2. **及时整理**: 发现重叠时及时使用自动排列
3. **合理规划**: 根据内容长度规划时间轴布局

### 避免问题
- 不要强制拖拽到已占用位置
- 注意时间轴总长度限制
- 及时处理重叠警告

## 🔧 技术实现

### 核心算法
- **重叠检测**: 区间重叠判断
- **空隙寻找**: 贪心算法寻找最优位置
- **自动排列**: 顺序排列算法

### 状态管理
- **实时监控**: 响应式计算重叠状态
- **自动更新**: 位置变化时自动重新计算
- **持久化**: 保持片段位置的一致性

**现在视频片段重叠问题得到完美解决！** 🎉
