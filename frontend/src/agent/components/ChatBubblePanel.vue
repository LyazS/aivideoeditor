<template>
  <div class="panel">
    <!-- 顶部标题栏 -->
    <div class="panel-header">
      <div class="header-left">
        <RemixIcon name="sparkling-2-fill" size="md" />
        <h3>{{ t('common.chat.agent') }}</h3>
      </div>
      <HoverButton @click="$emit('close')" :title="t('common.close')">
        <template #icon>
          <RemixIcon name="close-line" size="lg" />
        </template>
      </HoverButton>
    </div>

    <!-- 消息列表 -->
    <ChatMessageList :messages="messages" />

    <!-- 底部输入框 -->
    <ChatInput
      :placeholder="t('common.chat.inputPlaceholder')"
      :send-title="t('common.chat.send')"
      @send="handleSendMessage"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import RemixIcon from '@/components/icons/RemixIcon.vue'
import HoverButton from '@/components/HoverButton.vue'
import ChatMessageList from '@/agent/components/ChatMessageList.vue'
import ChatInput from '@/agent/components/ChatInput.vue'
import { useAppI18n } from '@/unified/composables/useI18n'
import type { ChatMessage } from './types'

const { t } = useAppI18n()

// 定义事件
const emit = defineEmits<{
  close: []
}>()

// 消息列表
const messages = ref<ChatMessage[]>([
  {
    id: '1',
    type: 'ai',
    content: `你好！我是AI助手，可以帮助你分析视频内容、提供编辑建议等。

## 我可以帮你做什么：

- **视频分析**：识别视频中的场景、物体和人物
- **编辑建议**：提供专业的视频编辑建议
- **效果推荐**：推荐适合的过渡效果和滤镜
- **音频处理**：音频优化和背景音乐建议

有什么可以帮助你的吗？`,
    timestamp: '10:00'
  },
  {
    id: '2',
    type: 'user',
    content: '请帮我分析这个视频的主要内容',
    timestamp: '10:01'
  },
  {
    id: '3',
    type: 'ai',
    content: `我看到这是一个关于城市风景的视频，包含了多个场景切换。

### 主要发现：

1. **场景数量**：检测到5个不同的城市场景
2. **拍摄质量**：画面清晰，色彩饱和度良好
3. **节奏控制**：场景切换较为自然

### 建议改进：

> 建议你可以添加一些**过渡效果**来让场景转换更加自然，比如：
> - \`淡入淡出\`效果
> - \`滑动切换\`效果
> - \`溶解过渡\`效果

需要我详细解释这些效果吗？`,
    timestamp: '10:02'
  },
  {
    id: '4',
    type: 'ai',
    content: `## 技术参数分析

| 参数 | 数值 | 评价 |
|------|------|------|
| 分辨率 | 1920×1080 | ✅ 高清 |
| 帧率 | 30fps | ✅ 标准 |
| 时长 | 2:34 | ✅ 适中 |
| 码率 | 8.5Mbps | ✅ 良好 |

### 代码示例
如果你需要添加转场效果，可以使用以下代码：

\`\`\`javascript
const addTransition = (scene1, scene2, type = 'fade') => {
  return {
    from: scene1,
    to: scene2,
    transition: type,
    duration: '1s'
  };
};
\`\`\`

**总体评价**：这是一个制作精良的城市风景视频！`,
    timestamp: '10:03'
  }
])

// 简单的AI回复逻辑
const getAIResponse = (userInput: string): string => {
  const responses = [
    `## 分析结果

这是一个很好的问题！让我为你分析一下视频内容：

- **画面质量**：清晰度良好
- **色彩搭配**：色调协调
- **节奏控制**：过渡自然

### 建议改进：
1. 可以调整亮度对比度
2. 添加一些过渡效果
3. 考虑音频同步优化`,
    
    `## 特效建议

根据视频内容，我建议你可以尝试以下特效：

### 视觉效果：
- **模糊转场**：营造梦幻感
- **色彩调整**：增强视觉冲击力
- **动态文字**：添加说明信息

> 💡 **专业提示**：特效要适度使用，避免过度处理。`,
    
    `## 音频优化建议

我注意到视频的节奏很好，音频处理建议：

| 音频元素 | 建议 |
|----------|------|
| 背景音乐 | 选择节奏匹配的音乐 |
| 音量平衡 | 确保对话清晰度 |
| 音效添加 | 适当增强关键节点 |

\`\`\`javascript
// 音频处理示例
const optimizeAudio = (audioTrack) => {
  return audioTrack
    .normalize()
    .compress()
    .enhance();
};
\`\`\``,
    
    `## 色彩分析

这个视频的画面质量很不错！

**色彩统计**：
- 主色调：暖色系 🔴
- 饱和度：适中 📊
- 对比度：良好 ⚡

建议你可以：
1. 使用 \`色彩平衡\` 工具微调
2. 添加 \`LUT滤镜\` 增强氛围
3. 调整 \`色温\` 让画面更生动`,
    
    `## 编辑建议

看起来你在视频编辑方面很有经验！

### 下一步建议：
- [ ] 添加转场效果
- [ ] 优化音频同步
- [ ] 调整色彩参数
- [ ] 导出最终版本

有什么具体的编辑需求吗？我很乐意为你提供详细指导！`
  ]
  
  // 根据输入内容返回相关回复
  if (userInput.includes('分析') || userInput.includes('内容')) {
    return `## 深度分析报告

我已经全面分析了你的视频内容：

### 📊 内容分析
- **主题识别**：${userInput.includes('城市') ? '城市风景' : '视频内容'}
- **场景检测**：发现多个场景切换
- **质量评估**：制作精良，技术参数良好

### 🎯 关键发现
1. **视觉元素丰富**，构图合理
2. **节奏控制得当**，过渡自然
3. **技术质量达标**，观感良好

### 💡 个性化建议
建议你可以添加一些**文字说明**和**标注**来帮助观众更好地理解内容。

需要我详细解释某个方面吗？`
  } else if (userInput.includes('效果') || userInput.includes('特效')) {
    return `## 特效推荐方案

根据你的需求，我建议以下**过渡效果**：

### 🎬 视觉过渡
- **\`淡入淡出\`**：最自然的选择
- **\`滑动切换\`**：动感十足
- **\`溶解过渡\`**：梦幻效果

### ⚙️ 技术实现
\`\`\`css
/* CSS过渡效果示例 */
.transition-fade {
  transition: opacity 0.5s ease-in-out;
}
\`\`\`

### 📈 效果对比
| 效果类型 | 适用场景 | 强度 |
|----------|----------|------|
| 淡入淡出 | 自然过渡 | ⭐⭐⭐ |
| 滑动切换 | 动感场景 | ⭐⭐⭐⭐ |
| 溶解过渡 | 梦幻效果 | ⭐⭐⭐⭐⭐ |

需要我详细解释这些效果吗？`
  } else if (userInput.includes('音乐') || userInput.includes('音频')) {
    return `## 音频处理专业指南

音频是视频的重要组成部分！

### 🎵 音乐选择原则
- **节奏匹配**：BPM与视频节奏同步
- **情感契合**：音乐情绪与内容匹配
- **版权安全**：使用授权音乐

### 🔧 技术处理
\`\`\`javascript
// 音频处理流程
const processAudio = (audioTrack, videoBPM) => {
  return audioTrack
    .matchBPM(videoBPM)     // 节奏匹配
    .normalize(-14)         // 音量标准化
    .compress(3:1)          // 动态压缩
    .EQ('gentle')           // 均衡器调整
    .limit(-1);             // 限幅处理
};
\`\`\`

### ⚖️ 音量平衡技巧
> **黄金法则**：背景音乐不超过-18dB，主要音频保持-12dB到-6dB

需要更详细的音频处理指导吗？`
  } else {
    return responses[Math.floor(Math.random() * responses.length)]
  }
}

// 处理发送消息
const handleSendMessage = (message: string) => {
  // 添加用户消息
  const userMessage: ChatMessage = {
    id: Date.now().toString(),
    type: 'user',
    content: message,
    timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  }
  
  messages.value.push(userMessage)
  
  // 模拟AI回复
  setTimeout(() => {
    const aiMessage: ChatMessage = {
      id: (Date.now() + 1).toString(),
      type: 'ai',
      content: getAIResponse(message),
      timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    }
    messages.value.push(aiMessage)
  }, 1000)
}
</script>

<style scoped>
/* 确保聊天面板占满整个高度 */
.panel {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}
</style>