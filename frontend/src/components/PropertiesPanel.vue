<template>
  <div class="properties-panel">
    <div class="panel-header">
      <h3>Â±ûÊÄß</h3>
    </div>

    <div class="panel-content">
      <div v-if="!selectedTimelineItem" class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,16.5L18,9.5L16.5,8L11,13.5L7.5,10L6,11.5L11,16.5Z"
          />
        </svg>
        <p>ÈÄâÊã©ÁâáÊÆµÊü•ÁúãÂ±ûÊÄß</p>
        <p class="hint">Âú®Êó∂Èó¥ËΩ¥‰∏äÁÇπÂáªËßÜÈ¢ëÁâáÊÆµ</p>
      </div>

      <div v-else class="properties-content">
        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <div class="property-section">
          <h4>Âü∫Êú¨‰ø°ÊÅØ</h4>
          <div class="property-item">
            <label>ÂêçÁß∞</label>
            <input
              v-model="clipName"
              @blur="updateClipName"
              @keyup.enter="updateClipName"
              class="property-input"
            />
          </div>
          <div class="property-item">
            <label>Êó∂Èïø</label>
            <span class="property-value">{{ formatDuration(timelineDuration) }}</span>
          </div>
          <div class="property-item">
            <label>‰ΩçÁΩÆ</label>
            <span class="property-value">{{ formatDuration(selectedTimelineItem?.timelinePosition || 0) }}</span>
          </div>

          <!-- Ë∞ÉËØïÊåâÈíÆ -->
          <div class="property-item">
            <button @click="debugTimelineItems" class="debug-button">
              üêõ Ë∞ÉËØïÔºöÊâìÂç∞TimelineItemsÊï∞ÊçÆ
            </button>
          </div>
        </div>

        <!-- Êí≠ÊîæËÆæÁΩÆ -->
        <div class="property-section">
          <h4>Êí≠ÊîæËÆæÁΩÆ</h4>

          <!-- Á≤æÁ°ÆÊó∂ÈïøÊéßÂà∂ -->
          <div class="property-item">
            <label>ÁõÆÊ†áÊó∂Èïø</label>
            <div class="duration-controls">
              <input
                v-model.number="targetDuration"
                @blur="updateTargetDuration"
                @keyup.enter="updateTargetDuration"
                type="number"
                step="0.1"
                min="0.1"
                class="property-input number-input"
                placeholder="Áßí"
              />
              <span class="duration-unit">Áßí</span>
            </div>
          </div>

          <!-- ÂÄçÈÄüÊéßÂà∂ -->
          <div class="property-item">
            <label>ÂÄçÈÄü</label>
            <div class="speed-controls">
              <!-- ÂàÜÊÆµÂÄçÈÄüÊªëÂùó -->
              <div class="segmented-speed-container">
                <input
                  :value="normalizedSpeed"
                  @input="(e) => updateNormalizedSpeed((e.target as HTMLInputElement).valueAsNumber)"
                  type="range"
                  min="0"
                  max="100"
                  step="1"
                  class="segmented-speed-slider"
                />
                <!-- ÂàÜÊÆµÁ´ñÁ∫ø -->
                <div class="speed-dividers">
                  <div class="speed-divider" style="left: 20%"></div>
                  <div class="speed-divider" style="left: 40%"></div>
                  <div class="speed-divider" style="left: 60%"></div>
                  <div class="speed-divider" style="left: 80%"></div>
                </div>
              </div>
              <input
                :value="speedInputValue"
                @input="(e) => updateSpeedFromInput((e.target as HTMLInputElement).valueAsNumber)"
                @blur="(e) => updateSpeedFromInput((e.target as HTMLInputElement).valueAsNumber)"
                @keyup.enter="(e) => updateSpeedFromInput((e.target as HTMLInputElement).valueAsNumber)"
                type="number"
                step="0.1"
                min="0.1"
                max="100"
                class="speed-input"
              />
            </div>
          </div>
        </div>

        <!-- ‰ΩçÁΩÆÂ§ßÂ∞è -->
        <div class="property-section">
          <h4>‰ΩçÁΩÆÂ§ßÂ∞è</h4>
          <!-- ‰ΩçÁΩÆÔºöXYÂú®Âêå‰∏ÄË°å -->
          <div class="property-item">
            <label>‰ΩçÁΩÆ</label>
            <div class="position-controls">
              <div class="position-input-group">
                <span class="position-label">X</span>
                <div class="number-input-wrapper">
                  <input
                    :value="tempTransformXInput"
                    @blur="confirmTransformXFromInput"
                    @keyup.enter="confirmTransformXFromInput"
                    type="number"
                    step="1"
                    :min="-videoStore.videoResolution.width"
                    :max="videoStore.videoResolution.width"
                    class="property-input position-input-field"
                    placeholder="‰∏≠ÂøÉ‰∏∫0"
                  />
                  <div class="number-controls">
                    <button @click="adjustTransformX(1)" class="number-btn number-btn-up">‚ñ≤</button>
                    <button @click="adjustTransformX(-1)" class="number-btn number-btn-down">
                      ‚ñº
                    </button>
                  </div>
                </div>
              </div>
              <div class="position-input-group">
                <span class="position-label">Y</span>
                <div class="number-input-wrapper">
                  <input
                    :value="tempTransformYInput"
                    @blur="confirmTransformYFromInput"
                    @keyup.enter="confirmTransformYFromInput"
                    type="number"
                    step="1"
                    :min="-videoStore.videoResolution.height"
                    :max="videoStore.videoResolution.height"
                    class="property-input position-input-field"
                    placeholder="‰∏≠ÂøÉ‰∏∫0"
                  />
                  <div class="number-controls">
                    <button @click="adjustTransformY(1)" class="number-btn number-btn-up">‚ñ≤</button>
                    <button @click="adjustTransformY(-1)" class="number-btn number-btn-down">
                      ‚ñº
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Á≠âÊØîÁº©ÊîæÈÄâÈ°π -->
          <div class="property-item">
            <label>Á≠âÊØîÁº©Êîæ</label>
            <input
              v-model="proportionalScale"
              @change="toggleProportionalScale"
              type="checkbox"
              class="checkbox-input"
            />
          </div>

          <!-- Á≠âÊØîÁº©ÊîæÊó∂ÁöÑÁªü‰∏ÄÁº©ÊîæÊéßÂà∂ -->
          <div v-if="proportionalScale" class="property-item">
            <label>Áº©Êîæ</label>
            <div class="scale-controls">
              <input
                :value="uniformScale"
                @input="(e) => updateUniformScale((e.target as HTMLInputElement).valueAsNumber)"
                type="range"
                min="0.1"
                max="10"
                step="0.01"
                class="scale-slider"
              />
              <div class="number-input-wrapper">
                <input
                  :value="tempUniformScaleInput"
                  @blur="confirmUniformScaleFromInput"
                  @keyup.enter="confirmUniformScaleFromInput"
                  type="number"
                  min="0.1"
                  max="10"
                  step="0.01"
                  class="scale-input-box"
                />
                <div class="number-controls">
                  <button @click="updateUniformScale(uniformScale + 0.1)" class="number-btn number-btn-up">
                    ‚ñ≤
                  </button>
                  <button @click="updateUniformScale(uniformScale - 0.1)" class="number-btn number-btn-down">
                    ‚ñº
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ÈùûÁ≠âÊØîÁº©ÊîæÊó∂ÁöÑÁã¨Á´ãXYÁº©ÊîæÊéßÂà∂ -->
          <template v-else>
            <div class="property-item">
              <label>XÁº©Êîæ</label>
              <div class="scale-controls">
                <input
                  :value="scaleX"
                  @input="(e) => setScaleX((e.target as HTMLInputElement).valueAsNumber)"
                  type="range"
                  min="0.1"
                  max="10"
                  step="0.01"
                  class="scale-slider"
                />
                <div class="number-input-wrapper">
                  <input
                    :value="tempScaleXInput"
                    @blur="confirmScaleXFromInput"
                    @keyup.enter="confirmScaleXFromInput"
                    type="number"
                    min="0.1"
                    max="10"
                    step="0.01"
                    class="scale-input-box"
                  />
                  <div class="number-controls">
                    <button @click="setScaleX(scaleX + 0.1)" class="number-btn number-btn-up">‚ñ≤</button>
                    <button @click="setScaleX(scaleX - 0.1)" class="number-btn number-btn-down">
                      ‚ñº
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="property-item">
              <label>YÁº©Êîæ</label>
              <div class="scale-controls">
                <input
                  :value="scaleY"
                  @input="(e) => setScaleY((e.target as HTMLInputElement).valueAsNumber)"
                  type="range"
                  min="0.1"
                  max="10"
                  step="0.01"
                  class="scale-slider"
                />
                <div class="number-input-wrapper">
                  <input
                    :value="tempScaleYInput"
                    @blur="confirmScaleYFromInput"
                    @keyup.enter="confirmScaleYFromInput"
                    type="number"
                    min="0.1"
                    max="10"
                    step="0.01"
                    class="scale-input-box"
                  />
                  <div class="number-controls">
                    <button @click="setScaleY(scaleY + 0.1)" class="number-btn number-btn-up">‚ñ≤</button>
                    <button @click="setScaleY(scaleY - 0.1)" class="number-btn number-btn-down">
                      ‚ñº
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <!-- ÂàÜËæ®ÁéáÊéßÂà∂ -->
          <div class="property-item">
            <label>ÂàÜËæ®Áéá</label>
            <div class="resolution-controls">
              <div class="resolution-inputs">
                <div class="resolution-input-group">
                  <label class="resolution-label">ÂÆΩ</label>
                  <input
                    v-model="tempResolutionWidth"
                    @blur="confirmResolutionFromInput"
                    @keyup.enter="confirmResolutionFromInput"
                    type="number"
                    min="1"
                    max="7680"
                    class="resolution-input"
                  />
                </div>
                <span class="resolution-separator">√ó</span>
                <div class="resolution-input-group">
                  <label class="resolution-label">È´ò</label>
                  <input
                    v-model="tempResolutionHeight"
                    @blur="confirmResolutionFromInput"
                    @keyup.enter="confirmResolutionFromInput"
                    type="number"
                    min="1"
                    max="4320"
                    class="resolution-input"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Â∏ÉÂ±ÄÊéßÂà∂ -->
        <div class="property-section">
          <h4>Â∏ÉÂ±ÄÊéßÂà∂</h4>

          <!-- Ê∞¥Âπ≥ÂØπÈΩê -->
          <div class="property-item">
            <label>Ê∞¥Âπ≥ÂØπÈΩê</label>
            <div class="alignment-controls">
              <button
                @click="alignHorizontal('left')"
                class="align-btn"
                title="Â∑¶ÂØπÈΩê"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="2" y="4" width="8" height="2"/>
                  <rect x="2" y="7" width="6" height="2"/>
                  <rect x="2" y="10" width="10" height="2"/>
                  <line x1="1" y1="2" x2="1" y2="14" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
              <button
                @click="alignHorizontal('center')"
                class="align-btn"
                title="Ê∞¥Âπ≥Â±Ö‰∏≠"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="4" y="4" width="8" height="2"/>
                  <rect x="5" y="7" width="6" height="2"/>
                  <rect x="3" y="10" width="10" height="2"/>
                  <line x1="8" y1="2" x2="8" y2="14" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
              <button
                @click="alignHorizontal('right')"
                class="align-btn"
                title="Âè≥ÂØπÈΩê"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="6" y="4" width="8" height="2"/>
                  <rect x="8" y="7" width="6" height="2"/>
                  <rect x="4" y="10" width="10" height="2"/>
                  <line x1="15" y1="2" x2="15" y2="14" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- ÂûÇÁõ¥ÂØπÈΩê -->
          <div class="property-item">
            <label>ÂûÇÁõ¥ÂØπÈΩê</label>
            <div class="alignment-controls">
              <button
                @click="alignVertical('top')"
                class="align-btn"
                title="È°∂ÂØπÈΩê"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="4" y="2" width="2" height="8"/>
                  <rect x="7" y="2" width="2" height="6"/>
                  <rect x="10" y="2" width="2" height="10"/>
                  <line x1="2" y1="1" x2="14" y2="1" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
              <button
                @click="alignVertical('middle')"
                class="align-btn"
                title="ÂûÇÁõ¥Â±Ö‰∏≠"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="4" y="4" width="2" height="8"/>
                  <rect x="7" y="5" width="2" height="6"/>
                  <rect x="10" y="3" width="2" height="10"/>
                  <line x1="2" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
              <button
                @click="alignVertical('bottom')"
                class="align-btn"
                title="Â∫ïÂØπÈΩê"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <rect x="4" y="6" width="2" height="8"/>
                  <rect x="7" y="8" width="2" height="6"/>
                  <rect x="10" y="4" width="2" height="10"/>
                  <line x1="2" y1="15" x2="14" y2="15" stroke="currentColor" stroke-width="1"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- ÂèòÊç¢Â±ûÊÄß -->
        <div class="property-section">
          <h4>ÂèòÊç¢</h4>

          <div class="property-item">
            <label>ÊóãËΩ¨</label>
            <div class="rotation-controls">
              <input
                :value="rotation"
                @input="(e) => setRotation((e.target as HTMLInputElement).valueAsNumber)"
                type="range"
                min="-180"
                max="180"
                step="0.1"
                class="rotation-slider"
              />
              <div class="number-input-wrapper">
                <input
                  :value="tempRotationInput"
                  @blur="confirmRotationFromInput"
                  @keyup.enter="confirmRotationFromInput"
                  type="number"
                  step="0.1"
                  class="scale-input-box"
                />
                <div class="number-controls">
                  <button @click="setRotation(rotation + 1)" class="number-btn number-btn-up">‚ñ≤</button>
                  <button @click="setRotation(rotation - 1)" class="number-btn number-btn-down">‚ñº</button>
                </div>
              </div>
            </div>
          </div>
          <div class="property-item">
            <label>ÈÄèÊòéÂ∫¶</label>
            <div class="opacity-controls">
              <input
                :value="opacity"
                @input="(e) => setOpacity((e.target as HTMLInputElement).valueAsNumber)"
                type="range"
                min="0"
                max="1"
                step="0.01"
                class="opacity-slider"
              />
              <div class="number-input-wrapper">
                <input
                  :value="tempOpacityInput"
                  @blur="confirmOpacityFromInput"
                  @keyup.enter="confirmOpacityFromInput"
                  type="number"
                  min="0"
                  max="1"
                  step="0.01"
                  class="scale-input-box"
                />
                <div class="number-controls">
                  <button @click="setOpacity(opacity + 0.01)" class="number-btn number-btn-up">‚ñ≤</button>
                  <button @click="setOpacity(opacity - 0.01)" class="number-btn number-btn-down">
                    ‚ñº
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="property-item">
            <label>Â±ÇÁ∫ß</label>
            <input
              :value="tempZIndexInput"
              @blur="confirmZIndexFromInput"
              @keyup.enter="confirmZIndexFromInput"
              type="number"
              min="0"
              step="1"
              class="property-input number-input"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick } from 'vue'
import { useVideoStore, type TimelineItem } from '../stores/videostore'
import { webavToProjectCoords } from '../utils/coordinateTransform'
import { uiDegreesToWebAVRadians, webAVRadiansToUIDegrees } from '../utils/rotationTransform'

const videoStore = useVideoStore()

// ÈÄâ‰∏≠ÁöÑÊó∂Èó¥ËΩ¥È°πÁõÆ
const selectedTimelineItem = computed(() => {
  if (!videoStore.selectedTimelineItemId) return null
  return videoStore.getTimelineItem(videoStore.selectedTimelineItemId) || null
})

// ÈÄâ‰∏≠È°πÁõÆÂØπÂ∫îÁöÑÁ¥†Êùê
const selectedMediaItem = computed(() => {
  if (!selectedTimelineItem.value) return null
  return videoStore.getMediaItem(selectedTimelineItem.value.mediaItemId) || null
})

// Êó∂Èó¥ËΩ¥Êó∂Èïø
const timelineDuration = computed(() => {
  if (!selectedTimelineItem.value) return 0
  const sprite = selectedTimelineItem.value.sprite
  const timeRange = sprite.getTimeRange()
  return (timeRange.timelineEndTime - timeRange.timelineStartTime) / 1000000 // ËΩ¨Êç¢‰∏∫Áßí
})

// ÂèØÁºñËæëÁöÑÂ±ûÊÄß
const targetDuration = ref(0)

// ÂÄçÈÄüÂàÜÊÆµÈÖçÁΩÆ
const speedSegments = [
  { min: 0.1, max: 1, normalizedStart: 0, normalizedEnd: 20 }, // 0-20%: 0.1-1x
  { min: 1, max: 2, normalizedStart: 20, normalizedEnd: 40 }, // 20-40%: 1-2x
  { min: 2, max: 5, normalizedStart: 40, normalizedEnd: 60 }, // 40-60%: 2-5x
  { min: 5, max: 10, normalizedStart: 60, normalizedEnd: 80 }, // 60-80%: 5-10x
  { min: 10, max: 100, normalizedStart: 80, normalizedEnd: 100 }, // 80-100%: 10-100x
]

// ÂèòÊç¢Â±ûÊÄß - Âü∫‰∫éTimelineItemÁöÑÂìçÂ∫îÂºèËÆ°ÁÆóÂ±ûÊÄß
const transformX = computed(() => selectedTimelineItem.value?.position.x || 0)
const transformY = computed(() => selectedTimelineItem.value?.position.y || 0)
const scaleX = computed(() => {
  if (!selectedTimelineItem.value || !selectedMediaItem.value) return 1
  const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
  return selectedTimelineItem.value.size.width / originalResolution.width
})
const scaleY = computed(() => {
  if (!selectedTimelineItem.value || !selectedMediaItem.value) return 1
  const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
  return selectedTimelineItem.value.size.height / originalResolution.height
})
const rotation = computed(() => {
  const radians = selectedTimelineItem.value?.rotation || 0
  return webAVRadiansToUIDegrees(radians)
})
const opacity = computed(() => selectedTimelineItem.value?.opacity || 1)
const zIndex = computed(() => selectedTimelineItem.value?.zIndex || 0)

// Á≠âÊØîÁº©ÊîæÁõ∏ÂÖ≥
const proportionalScale = computed({
  get: () => videoStore.proportionalScale,
  set: (value) => {
    videoStore.proportionalScale = value
  },
})

// ÂàÜËæ®ÁéáÁõ∏ÂÖ≥
const tempResolutionWidth = ref('1920')
const tempResolutionHeight = ref('1080')





// Á≠âÊØîÁº©ÊîæÁõ∏ÂÖ≥
const uniformScale = computed(() => scaleX.value) // ‰ΩøÁî®XÁº©ÊîæÂÄº‰Ωú‰∏∫Áªü‰∏ÄÁº©ÊîæÂÄº

// ÂÖ∂‰ªñÂìçÂ∫îÂºèÂ±ûÊÄß
const clipName = computed({
  get: () => selectedMediaItem.value?.name || '',
  set: (value) => {
    if (selectedMediaItem.value && value.trim()) {
      videoStore.updateMediaItemName(selectedMediaItem.value.id, value.trim())
    }
  }
})

const playbackRate = computed(() => {
  if (!selectedTimelineItem.value) return 1
  return selectedTimelineItem.value.sprite.getPlaybackSpeed() || 1
})

const normalizedSpeed = computed(() => {
  return speedToNormalized(playbackRate.value)
})

const speedInputValue = computed(() => playbackRate.value)

// TODO: ÈáçÊñ∞ÂÆûÁé∞ÂèòÊç¢Â±ûÊÄßÁõëÂê¨
// ÊöÇÊó∂Á¶ÅÁî®Â§çÊùÇÁöÑÂèòÊç¢ÁõëÂê¨ÈÄªËæë

// Êõ¥Êñ∞ÁâáÊÆµÂêçÁß∞
const updateClipName = () => {
  if (selectedMediaItem.value && clipName.value.trim()) {
    videoStore.updateMediaItemName(selectedMediaItem.value.id, clipName.value.trim())
  }
}

// Êõ¥Êñ∞Êí≠ÊîæÈÄüÂ∫¶
const updatePlaybackRate = (newRate?: number) => {
  if (selectedTimelineItem.value) {
    const rate = newRate || playbackRate.value
    videoStore.updateTimelineItemPlaybackRate(selectedTimelineItem.value.id, rate)
    // ÂêåÊ≠•Êõ¥Êñ∞ÁõÆÊ†áÊó∂Èïø
    const sprite = selectedTimelineItem.value.sprite
    const timeRange = sprite.getTimeRange()
    targetDuration.value = (timeRange.timelineEndTime - timeRange.timelineStartTime) / 1000000
  }
}

// Êõ¥Êñ∞ÁõÆÊ†áÊó∂Èïø
const updateTargetDuration = () => {
  if (selectedTimelineItem.value && selectedMediaItem.value && targetDuration.value > 0) {
    const sprite = selectedTimelineItem.value.sprite
    const timeRange = sprite.getTimeRange()

    // ËÆ°ÁÆóÊñ∞ÁöÑÊí≠ÊîæÈÄüÂ∫¶ÔºöÂéüÂßãÊó∂Èïø / ÁõÆÊ†áÊó∂Èïø
    const newPlaybackRate = selectedMediaItem.value.duration / targetDuration.value
    // Á°Æ‰øùÊí≠ÊîæÈÄüÂ∫¶Âú®ÂêàÁêÜËåÉÂõ¥ÂÜÖÔºà0.1-100xÔºâ
    const clampedRate = Math.max(0.1, Math.min(100, newPlaybackRate))

    // Êõ¥Êñ∞CustomVisibleSpriteÁöÑÊó∂Èó¥ËåÉÂõ¥
    const newTimelineEndTime = timeRange.timelineStartTime + (targetDuration.value * 1000000)
    sprite.setTimeRange({
      clipStartTime: timeRange.clipStartTime,
      clipEndTime: timeRange.clipEndTime,
      timelineStartTime: timeRange.timelineStartTime,
      timelineEndTime: newTimelineEndTime
    })

    // ÈáçÊñ∞ËÆ°ÁÆóÂÆûÈôÖÊó∂ÈïøÔºàÂèØËÉΩÂõ†‰∏∫ËåÉÂõ¥ÈôêÂà∂ËÄåÊúâÊâÄË∞ÉÊï¥Ôºâ
    const actualDuration = selectedMediaItem.value.duration / clampedRate
    targetDuration.value = actualDuration
  }
}

// Êõ¥Êñ∞ÂΩí‰∏ÄÂåñÈÄüÂ∫¶
const updateNormalizedSpeed = (newNormalizedSpeed: number) => {
  const actualSpeed = normalizedToSpeed(newNormalizedSpeed)
  updatePlaybackRate(actualSpeed)
}

// ‰ªéËæìÂÖ•Ê°ÜÊõ¥Êñ∞ÂÄçÈÄü
const updateSpeedFromInput = (newSpeed: number) => {
  if (newSpeed && newSpeed > 0) {
    // Á°Æ‰øùÂÄçÈÄüÂú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
    const clampedSpeed = Math.max(0.1, Math.min(100, newSpeed))
    updatePlaybackRate(clampedSpeed)
  }
}

// Â∞ÜÂΩí‰∏ÄÂåñÂÄº(0-100)ËΩ¨Êç¢‰∏∫ÂÆûÈôÖÊí≠ÊîæÈÄüÂ∫¶
const normalizedToSpeed = (normalized: number) => {
  // ÊâæÂà∞ÂØπÂ∫îÁöÑÊÆµ
  for (const segment of speedSegments) {
    if (normalized >= segment.normalizedStart && normalized <= segment.normalizedEnd) {
      // Âú®ÊÆµÂÜÖËøõË°åÁ∫øÊÄßÊèíÂÄº
      const segmentProgress =
        (normalized - segment.normalizedStart) / (segment.normalizedEnd - segment.normalizedStart)
      return segment.min + segmentProgress * (segment.max - segment.min)
    }
  }
  return 1 // ÈªòËÆ§ÂÄº
}

// Â∞ÜÂÆûÈôÖÊí≠ÊîæÈÄüÂ∫¶ËΩ¨Êç¢‰∏∫ÂΩí‰∏ÄÂåñÂÄº(0-100)
const speedToNormalized = (speed: number) => {
  // ÊâæÂà∞ÂØπÂ∫îÁöÑÊÆµ
  for (const segment of speedSegments) {
    if (speed >= segment.min && speed <= segment.max) {
      // Âú®ÊÆµÂÜÖËøõË°åÁ∫øÊÄßÊèíÂÄº
      const segmentProgress = (speed - segment.min) / (segment.max - segment.min)
      return (
        segment.normalizedStart +
        segmentProgress * (segment.normalizedEnd - segment.normalizedStart)
      )
    }
  }
  return 20 // ÈªòËÆ§ÂÄºÂØπÂ∫î1x
}



// Êõ¥Êñ∞ÂèòÊç¢Â±ûÊÄß - ‰ΩøÁî®Êñ∞ÁöÑÂèåÂêëÂêåÊ≠•Êú∫Âà∂
const updateTransform = (transform?: {
  position?: { x: number; y: number }
  size?: { width: number; height: number }
  rotation?: number
  opacity?: number
  zIndex?: number
}) => {
  if (!selectedTimelineItem.value) return

  try {
    // Â¶ÇÊûúÊ≤°ÊúâÊèê‰æõtransformÂèÇÊï∞Ôºå‰ΩøÁî®ÂΩìÂâçÁöÑÂìçÂ∫îÂºèÂÄº
    const finalTransform = transform || {
      position: { x: transformX.value, y: transformY.value },
      size: {
        width: selectedTimelineItem.value.size.width,
        height: selectedTimelineItem.value.size.height
      },
      rotation: rotation.value,
      opacity: opacity.value,
      zIndex: zIndex.value
    }

    // ‰ΩøÁî®videoStoreÁöÑupdateTimelineItemTransformÊñπÊ≥ï
    // Ëøô‰ºöËß¶ÂèëpropsChange‰∫ã‰ª∂ÔºåËá™Âä®ÂêåÊ≠•Âà∞TimelineItemÔºåÁÑ∂ÂêéÊõ¥Êñ∞Â±ûÊÄßÈù¢ÊùøÊòæÁ§∫
    videoStore.updateTimelineItemTransform(selectedTimelineItem.value.id, finalTransform)
  } catch (error) {
    console.error('Êõ¥Êñ∞ÂèòÊç¢Â±ûÊÄßÂ§±Ë¥•:', error)
  }
}

// ÂàáÊç¢Á≠âÊØîÁº©Êîæ
const toggleProportionalScale = () => {
  if (proportionalScale.value && selectedTimelineItem.value && selectedMediaItem.value) {
    // ÂºÄÂêØÁ≠âÊØîÁº©ÊîæÊó∂Ôºå‰ΩøÁî®ÂΩìÂâçXÁº©ÊîæÂÄº‰Ωú‰∏∫Áªü‰∏ÄÁº©ÊîæÂÄºÔºåÂêåÊó∂Êõ¥Êñ∞YÁº©Êîæ
    const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
    const newSize = {
      width: originalResolution.width * scaleX.value,
      height: originalResolution.height * scaleX.value // ‰ΩøÁî®XÁº©ÊîæÂÄº‰øùÊåÅÁ≠âÊØî
    }
    updateTransform({ size: newSize })
  }
}

// Êõ¥Êñ∞Áªü‰∏ÄÁº©Êîæ
const updateUniformScale = (newScale: number) => {
  if (proportionalScale.value && selectedTimelineItem.value && selectedMediaItem.value) {
    const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
    const newSize = {
      width: originalResolution.width * newScale,
      height: originalResolution.height * newScale
    }
    updateTransform({ size: newSize })
  }
}

// Ë∞ÉÊï¥‰ΩçÁΩÆÊï∞ÂÄºÁöÑÊñπÊ≥ï
const adjustTransformX = (delta: number) => {
  const newPosition = {
    x: transformX.value + delta,
    y: transformY.value
  }
  updateTransform({ position: newPosition })
}

const adjustTransformY = (delta: number) => {
  const newPosition = {
    x: transformX.value,
    y: transformY.value + delta
  }
  updateTransform({ position: newPosition })
}

// ËÆæÁΩÆXÁº©ÊîæÁªùÂØπÂÄºÁöÑÊñπÊ≥ï
const setScaleX = (value: number) => {
  if (!selectedTimelineItem.value || !selectedMediaItem.value) return
  const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
  const newScaleX = Math.max(0.1, Math.min(10, value))
  const newSize = {
    width: originalResolution.width * newScaleX,
    height: selectedTimelineItem.value.size.height // ‰øùÊåÅYÂ∞∫ÂØ∏‰∏çÂèò
  }
  updateTransform({ size: newSize })
}

// ËÆæÁΩÆYÁº©ÊîæÁªùÂØπÂÄºÁöÑÊñπÊ≥ï
const setScaleY = (value: number) => {
  if (!selectedTimelineItem.value || !selectedMediaItem.value) return
  const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
  const newScaleY = Math.max(0.1, Math.min(10, value))
  const newSize = {
    width: selectedTimelineItem.value.size.width, // ‰øùÊåÅXÂ∞∫ÂØ∏‰∏çÂèò
    height: originalResolution.height * newScaleY
  }
  updateTransform({ size: newSize })
}

// ËÆæÁΩÆÊóãËΩ¨ÁªùÂØπÂÄºÁöÑÊñπÊ≥ïÔºàËæìÂÖ•ËßíÂ∫¶ÔºåËΩ¨Êç¢‰∏∫ÂºßÂ∫¶Ôºâ
const setRotation = (value: number) => {
  const newRotationRadians = uiDegreesToWebAVRadians(value)
  updateTransform({ rotation: newRotationRadians })
}

// ËÆæÁΩÆÈÄèÊòéÂ∫¶ÁªùÂØπÂÄºÁöÑÊñπÊ≥ï
const setOpacity = (value: number) => {
  const newOpacity = Math.max(0, Math.min(1, value))
  updateTransform({ opacity: newOpacity })
}

// ‰∏¥Êó∂ËæìÂÖ•ÂÄºÁöÑcomputedÔºàÁî®‰∫éÂçïÂêëÁªëÂÆöÊòæÁ§∫Ôºâ
const tempTransformXInput = computed(() => transformX.value.toString())
const tempTransformYInput = computed(() => transformY.value.toString())
const tempUniformScaleInput = computed(() => uniformScale.value.toFixed(2))
const tempScaleXInput = computed(() => scaleX.value.toFixed(2))
const tempScaleYInput = computed(() => scaleY.value.toFixed(2))
const tempRotationInput = computed(() => rotation.value.toFixed(1))
const tempOpacityInput = computed(() => opacity.value.toFixed(2))
const tempZIndexInput = computed(() => zIndex.value.toString())

// Á°ÆËÆ§Áªü‰∏ÄÁº©ÊîæËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmUniformScaleFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseFloat(input.value)
  if (!isNaN(value)) {
    const clampedValue = Math.max(0.1, Math.min(10, value))
    updateUniformScale(clampedValue)
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§XÁº©ÊîæËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmScaleXFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseFloat(input.value)
  if (!isNaN(value) && selectedTimelineItem.value && selectedMediaItem.value) {
    const clampedValue = Math.max(0.1, Math.min(10, value))
    const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
    const newSize = {
      width: originalResolution.width * clampedValue,
      height: selectedTimelineItem.value.size.height // ‰øùÊåÅYÂ∞∫ÂØ∏‰∏çÂèò
    }
    updateTransform({ size: newSize })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§YÁº©ÊîæËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmScaleYFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseFloat(input.value)
  if (!isNaN(value) && selectedTimelineItem.value && selectedMediaItem.value) {
    const clampedValue = Math.max(0.1, Math.min(10, value))
    const originalResolution = videoStore.getVideoOriginalResolution(selectedMediaItem.value.id)
    const newSize = {
      width: selectedTimelineItem.value.size.width, // ‰øùÊåÅXÂ∞∫ÂØ∏‰∏çÂèò
      height: originalResolution.height * clampedValue
    }
    updateTransform({ size: newSize })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§‰ΩçÁΩÆXËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmTransformXFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseInt(input.value)
  if (!isNaN(value)) {
    // È°πÁõÆÂùêÊ†áÁ≥ªÔºö‰∏≠ÂøÉ‰∏∫ÂéüÁÇπÔºåÂÖÅËÆ∏ÁöÑËåÉÂõ¥ÊòØ -canvasWidth Âà∞ +canvasWidth
    const clampedValue = Math.max(
      -videoStore.videoResolution.width,
      Math.min(videoStore.videoResolution.width, value),
    )
    const newPosition = {
      x: clampedValue,
      y: transformY.value
    }
    updateTransform({ position: newPosition })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§‰ΩçÁΩÆYËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmTransformYFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseInt(input.value)
  if (!isNaN(value)) {
    // È°πÁõÆÂùêÊ†áÁ≥ªÔºö‰∏≠ÂøÉ‰∏∫ÂéüÁÇπÔºåÂÖÅËÆ∏ÁöÑËåÉÂõ¥ÊòØ -canvasHeight Âà∞ +canvasHeight
    const clampedValue = Math.max(
      -videoStore.videoResolution.height,
      Math.min(videoStore.videoResolution.height, value),
    )
    const newPosition = {
      x: transformX.value,
      y: clampedValue
    }
    updateTransform({ position: newPosition })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§ÊóãËΩ¨ËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmRotationFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseFloat(input.value)
  if (!isNaN(value)) {
    setRotation(value)
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§ÈÄèÊòéÂ∫¶ËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmOpacityFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseFloat(input.value)
  if (!isNaN(value)) {
    const clampedValue = Math.max(0, Math.min(1, value))
    updateTransform({ opacity: clampedValue })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// Á°ÆËÆ§Â±ÇÁ∫ßËæìÂÖ•ÔºàÂ§±ÁÑ¶ÊàñÂõûËΩ¶Êó∂Ôºâ
const confirmZIndexFromInput = (event: Event) => {
  const input = event.target as HTMLInputElement
  const value = parseInt(input.value)
  if (!isNaN(value) && value >= 0) {
    updateTransform({ zIndex: value })
  }
  // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåcomputed‰ºöËá™Âä®ÊÅ¢Â§çÂà∞ÂΩìÂâçÊ≠£Á°ÆÂÄº
}

// ==================== Ë∞ÉËØïÂáΩÊï∞ ====================

/**
 * Ë∞ÉËØïÂáΩÊï∞ÔºöÊâìÂç∞TimelineItemsÁöÑËØ¶ÁªÜÊï∞ÊçÆ
 */
const debugTimelineItems = () => {
  console.group('üêõ TimelineItems Ë∞ÉËØïÊï∞ÊçÆ')

  console.log('üìä ÊÄª‰Ωì‰ø°ÊÅØ:')
  console.log(`- TimelineItems Êï∞Èáè: ${videoStore.timelineItems.length}`)
  console.log(`- ÂΩìÂâçÈÄâ‰∏≠È°πÁõÆID: ${videoStore.selectedTimelineItemId}`)

  if (videoStore.timelineItems.length === 0) {
    console.log('‚ö†Ô∏è Ê≤°ÊúâTimelineItemsÊï∞ÊçÆ')
    console.groupEnd()
    return
  }

  console.log('\nüìã TimelineItems ËØ¶ÁªÜÊï∞ÊçÆ:')
  videoStore.timelineItems.forEach((item, index) => {
    console.group(`üìπ TimelineItem [${index}] - ID: ${item.id}`)

    // Âü∫Êú¨‰ø°ÊÅØ
    console.log('üîç Âü∫Êú¨‰ø°ÊÅØ:')
    console.log(`  - ID: ${item.id}`)
    console.log(`  - MediaItem ID: ${item.mediaItemId}`)
    console.log(`  - Track ID: ${item.trackId}`)
    console.log(`  - Timeline Position: ${item.timelinePosition}s`)

    // ‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏‰ø°ÊÅØ
    console.log('üìê ‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏:')
    console.log(`  - Position: { x: ${item.position.x}, y: ${item.position.y} }`)
    console.log(`  - Size: { width: ${item.size.width}, height: ${item.size.height} }`)
    console.log(`  - Rotation: ${item.rotation} ÂºßÂ∫¶`)
    console.log(`  - Opacity: ${item.opacity}`)
    console.log(`  - Z-Index: ${item.zIndex}`)

    // Sprite‰ø°ÊÅØ
    console.log('üé¨ Sprite ‰ø°ÊÅØ:')
    const sprite = item.sprite
    if (sprite) {
      const rect = sprite.rect
      const timeRange = sprite.getTimeRange()

      console.log(`  - WebAV Rect: { x: ${rect.x}, y: ${rect.y}, w: ${rect.w}, h: ${rect.h} }`)
      console.log(`  - WebAV Opacity: ${sprite.opacity}`)
      console.log(`  - WebAV Z-Index: ${sprite.zIndex}`)
      console.log(`  - Time Range:`)
      console.log(`    - Clip: ${timeRange.clipStartTime / 1000000}s - ${timeRange.clipEndTime / 1000000}s`)
      console.log(`    - Timeline: ${timeRange.timelineStartTime / 1000000}s - ${timeRange.timelineEndTime / 1000000}s`)
      console.log(`  - Playback Speed: ${sprite.getPlaybackSpeed()}x`)

      // ÂùêÊ†áÁ≥ªËΩ¨Êç¢È™åËØÅ
      console.log('üîÑ ÂùêÊ†áÁ≥ªËΩ¨Êç¢È™åËØÅ:')
      const convertedCoords = webavToProjectCoords(
        rect.x,
        rect.y,
        rect.w,
        rect.h,
        videoStore.videoResolution.width,
        videoStore.videoResolution.height
      )

      console.log(`  - WebAVÂùêÊ†á: { x: ${rect.x}, y: ${rect.y} }`)
      console.log(`  - ËΩ¨Êç¢‰∏∫È°πÁõÆÂùêÊ†á: { x: ${Math.round(convertedCoords.x)}, y: ${Math.round(convertedCoords.y)} }`)
      console.log(`  - TimelineItemÂùêÊ†á: { x: ${item.position.x}, y: ${item.position.y} }`)

      const xDiff = Math.abs(item.position.x - Math.round(convertedCoords.x))
      const yDiff = Math.abs(item.position.y - Math.round(convertedCoords.y))
      const isConsistent = xDiff < 2 && yDiff < 2

      console.log(`  - ÂùêÊ†áÂ∑ÆÂºÇ: X=${xDiff}px, Y=${yDiff}px`)
      console.log(`  - Êï∞ÊçÆÂêåÊ≠•Áä∂ÊÄÅ: ${isConsistent ? '‚úÖ ÂêåÊ≠•' : '‚ùå ‰∏çÂêåÊ≠•'}`)
    } else {
      console.warn('  ‚ö†Ô∏è Sprite ‰∏∫Á©∫!')
    }

    // ÂØπÂ∫îÁöÑMediaItem‰ø°ÊÅØ
    const mediaItem = videoStore.getMediaItem(item.mediaItemId)
    if (mediaItem) {
      console.log('üìÅ ÂØπÂ∫îÁöÑMediaItem:')
      console.log(`  - Name: ${mediaItem.name}`)
      console.log(`  - Duration: ${mediaItem.duration}s`)
      console.log(`  - Type: ${mediaItem.type}`)
    } else {
      console.warn('  ‚ö†Ô∏è Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑMediaItem!')
    }

    console.groupEnd()
  })

  // ÂΩìÂâçÈÄâ‰∏≠È°πÁõÆÁöÑÁâπÂà´‰ø°ÊÅØ
  if (selectedTimelineItem.value) {
    console.group('üéØ ÂΩìÂâçÈÄâ‰∏≠È°πÁõÆËØ¶ÊÉÖ')
    const item = selectedTimelineItem.value
    console.log('üìä ÂìçÂ∫îÂºèËÆ°ÁÆóÂ±ûÊÄßÂÄº:')
    console.log(`  - transformX: ${transformX.value}`)
    console.log(`  - transformY: ${transformY.value}`)
    console.log(`  - scaleX: ${scaleX.value}`)
    console.log(`  - scaleY: ${scaleY.value}`)
    console.log(`  - rotation: ${rotation.value}`)
    console.log(`  - opacity: ${opacity.value}`)
    console.log(`  - zIndex: ${zIndex.value}`)

    console.log('üîÑ Êï∞ÊçÆÂêåÊ≠•Áä∂ÊÄÅ:')
    const sprite = item.sprite
    if (sprite) {
      const rect = sprite.rect

      // Â∞ÜWebAVÂùêÊ†áÁ≥ªËΩ¨Êç¢‰∏∫È°πÁõÆÂùêÊ†áÁ≥ªËøõË°åÂØπÊØî
      const convertedCoords = webavToProjectCoords(
        rect.x ?? 0,
        rect.y ?? 0,
        rect.w ?? item.size.width,
        rect.h ?? item.size.height,
        videoStore.videoResolution.width,
        videoStore.videoResolution.height
      )

      console.log(`  - TimelineItem Position: { x: ${item.position.x}, y: ${item.position.y} }`)
      console.log(`  - WebAV Sprite Rect: { x: ${rect.x}, y: ${rect.y} }`)
      console.log(`  - ËΩ¨Êç¢ÂêéÁöÑÈ°πÁõÆÂùêÊ†á: { x: ${Math.round(convertedCoords.x)}, y: ${Math.round(convertedCoords.y)} }`)

      // Ê£ÄÊü•ÂùêÊ†áÁ≥ªËΩ¨Êç¢ÂêéÁöÑ‰∏ÄËá¥ÊÄß
      const xDiff = Math.abs(item.position.x - Math.round(convertedCoords.x))
      const yDiff = Math.abs(item.position.y - Math.round(convertedCoords.y))
      const isConsistent = xDiff < 2 && yDiff < 2 // ÂÖÅËÆ∏1-2ÂÉèÁ¥†ÁöÑËØØÂ∑Æ

      console.log(`  - XÂùêÊ†áÂ∑ÆÂºÇ: ${xDiff}px`)
      console.log(`  - YÂùêÊ†áÂ∑ÆÂºÇ: ${yDiff}px`)
      console.log(`  - ÂùêÊ†áÁ≥ªËΩ¨Êç¢ÊòØÂê¶‰∏ÄËá¥: ${isConsistent ? '‚úÖ' : '‚ùå'}`)

      if (!isConsistent) {
        console.warn(`  ‚ö†Ô∏è Êï∞ÊçÆ‰∏çÂêåÊ≠•ÔºÅTimelineItemÂíåSpriteÁöÑÂùêÊ†áÂ≠òÂú®ËæÉÂ§ßÂ∑ÆÂºÇ`)
      }
    }
    console.groupEnd()
  }

  console.groupEnd()
}



// Ê†ºÂºèÂåñÊó∂Èïø
const formatDuration = (seconds: number): string => {
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  const ms = Math.floor((seconds % 1) * 1000)
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`
}



// ËÆ°ÁÆóÂΩìÂâçÂàÜËæ®Áéá
const getCurrentResolution = () => {
  // TODO: ÈáçÊñ∞ÂÆûÁé∞ÂàÜËæ®ÁéáËÆ°ÁÆó
  return { width: 1920, height: 1080 }
}

// Êõ¥Êñ∞ÂàÜËæ®ÁéáÊòæÁ§∫
const updateResolutionDisplay = () => {
  const resolution = getCurrentResolution()
  tempResolutionWidth.value = resolution.width.toString()
  tempResolutionHeight.value = resolution.height.toString()
}

// Á°ÆËÆ§ÂàÜËæ®ÁéáËæìÂÖ•
const confirmResolutionFromInput = () => {
  // TODO: ÈáçÊñ∞ÂÆûÁé∞ÂàÜËæ®ÁéáËæìÂÖ•Á°ÆËÆ§
  console.log('TODO: Á°ÆËÆ§ÂàÜËæ®ÁéáËæìÂÖ•')
  updateResolutionDisplay()

}

// ÂÆûÁé∞ÂØπÈΩêÂäüËÉΩÔºàÂü∫‰∫éÈ°πÁõÆÂùêÊ†áÁ≥ªÔºö‰∏≠ÂøÉ‰∏∫ÂéüÁÇπÔºâ
const alignHorizontal = (alignment: 'left' | 'center' | 'right') => {
  if (!selectedTimelineItem.value) return

  const sprite = selectedTimelineItem.value.sprite
  const canvasWidth = videoStore.videoResolution.width
  const spriteWidth = sprite.rect.w || canvasWidth

  try {
    let newProjectX = 0
    switch (alignment) {
      case 'left':
        // Â∑¶ÂØπÈΩêÔºöspriteÂ∑¶ËæπÁºòË¥¥ÁîªÂ∏ÉÂ∑¶ËæπÁºò
        newProjectX = -canvasWidth / 2 + spriteWidth / 2
        break
      case 'center':
        // Â±Ö‰∏≠Ôºösprite‰∏≠ÂøÉÂØπÈΩêÁîªÂ∏É‰∏≠ÂøÉ
        newProjectX = 0
        break
      case 'right':
        // Âè≥ÂØπÈΩêÔºöspriteÂè≥ËæπÁºòË¥¥ÁîªÂ∏ÉÂè≥ËæπÁºò
        newProjectX = canvasWidth / 2 - spriteWidth / 2
        break
    }

    const newPosition = {
      x: Math.round(newProjectX),
      y: transformY.value
    }
    updateTransform({ position: newPosition })

    console.log('‚úÖ Ê∞¥Âπ≥ÂØπÈΩêÂÆåÊàê:', alignment, 'È°πÁõÆÂùêÊ†áX:', newPosition.x)
  } catch (error) {
    console.error('Ê∞¥Âπ≥ÂØπÈΩêÂ§±Ë¥•:', error)
  }
}

const alignVertical = (alignment: 'top' | 'middle' | 'bottom') => {
  if (!selectedTimelineItem.value) return

  const sprite = selectedTimelineItem.value.sprite
  const canvasHeight = videoStore.videoResolution.height
  const spriteHeight = sprite.rect.h || canvasHeight

  try {
    let newProjectY = 0
    switch (alignment) {
      case 'top':
        // È°∂ÂØπÈΩêÔºösprite‰∏äËæπÁºòË¥¥ÁîªÂ∏É‰∏äËæπÁºò
        newProjectY = -canvasHeight / 2 + spriteHeight / 2
        break
      case 'middle':
        // Â±Ö‰∏≠Ôºösprite‰∏≠ÂøÉÂØπÈΩêÁîªÂ∏É‰∏≠ÂøÉ
        newProjectY = 0
        break
      case 'bottom':
        // Â∫ïÂØπÈΩêÔºösprite‰∏ãËæπÁºòË¥¥ÁîªÂ∏É‰∏ãËæπÁºò
        newProjectY = canvasHeight / 2 - spriteHeight / 2
        break
    }

    const newPosition = {
      x: transformX.value,
      y: Math.round(newProjectY)
    }
    updateTransform({ position: newPosition })

    console.log('‚úÖ ÂûÇÁõ¥ÂØπÈΩêÂÆåÊàê:', alignment, 'È°πÁõÆÂùêÊ†áY:', newPosition.y)
  } catch (error) {
    console.error('ÂûÇÁõ¥ÂØπÈΩêÂ§±Ë¥•:', error)
  }
}


</script>

<style scoped>
.properties-panel {
  width: 100%;
  height: 100%;
  background-color: #2a2a2a;
  border-radius: 4px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  padding: 8px 12px;
  background-color: #333;
  border-bottom: 1px solid #555;
  flex-shrink: 0;
}

.panel-header h3 {
  margin: 0;
  font-size: 14px;
  color: #fff;
}

.panel-content {
  flex: 1;
  overflow-y: auto;
}

.empty-state {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #888;
  text-align: center;
  padding: 20px;
}

.empty-state svg {
  margin-bottom: 16px;
  opacity: 0.6;
}

.empty-state p {
  margin: 4px 0;
}

.hint {
  font-size: 12px;
  opacity: 0.7;
}

.properties-content {
  padding: 8px 12px;
}

.property-section {
  margin-bottom: 12px;
}

.property-section h4 {
  margin: 0 0 8px 0;
  font-size: 12px;
  color: #ccc;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #444;
  padding-bottom: 3px;
}

.property-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  gap: 6px;
}

.property-item label {
  font-size: 12px;
  color: #aaa;
  flex-shrink: 0;
  min-width: 60px;
}

.property-value {
  font-size: 12px;
  color: #fff;
  text-align: right;
  word-break: break-all;
  flex: 1;
}

.property-input {
  background: #444;
  border: 1px solid #666;
  border-radius: 3px;
  color: #fff;
  font-size: 12px;
  padding: 4px 6px;
  flex: 1;
  min-width: 0;
}

.property-input:focus {
  outline: none;
  border-color: #4caf50;
}

/* Êó∂ÈïøÊéßÂà∂Ê†∑Âºè */
.duration-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.duration-unit {
  font-size: 12px;
  color: #999;
  min-width: 20px;
}

/* ÂÄçÈÄüÊéßÂà∂Ê†∑Âºè */
.speed-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

/* ÂàÜÊÆµÂÄçÈÄüÊªëÂùóÂÆπÂô® */
.segmented-speed-container {
  position: relative;
  flex: 1;
  height: 40px;
  display: flex;
  align-items: center;
}

.segmented-speed-slider {
  width: 100%;
  height: 4px;
  background: #444;
  border-radius: 2px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  position: relative;
  z-index: 2;
}

.segmented-speed-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: #ffffff;
  border-radius: 50%;
  cursor: pointer;
}

.segmented-speed-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  background: #ffffff;
  border-radius: 50%;
  border: none;
  cursor: pointer;
}

/* ÂàÜÊÆµÁ´ñÁ∫ø */
.speed-dividers {
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 12px;
  transform: translateY(-50%);
  pointer-events: none;
  z-index: 1;
}

.speed-divider {
  position: absolute;
  width: 1px;
  height: 100%;
  background: #666;
  transform: translateX(-50%);
}

/* ÂàÜÊÆµÊ†áÁ≠æ */
.speed-labels {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  height: 16px;
  pointer-events: none;
  z-index: 1;
}

.speed-label {
  position: absolute;
  font-size: 9px;
  color: #999;
  transform: translateX(-50%);
  white-space: nowrap;
  margin-top: 2px;
}

/* ÂÄçÈÄüËæìÂÖ•Ê°Ü */
.speed-input {
  background: #444;
  border: 1px solid #666;
  border-radius: 3px;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 6px;
  min-width: 50px;
  max-width: 60px;
  text-align: center;
}

.speed-input:focus {
  outline: none;
  border-color: #ffffff;
}

.speed-input::-webkit-outer-spin-button,
.speed-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.number-input {
  max-width: 80px;
  text-align: right;
}

/* ‰ΩçÁΩÆÊéßÂà∂Ê†∑Âºè */
.position-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.position-input-group {
  display: flex;
  align-items: center;
  gap: 4px;
  flex: 1;
}

.position-label {
  font-size: 11px;
  color: #999;
  min-width: 12px;
  text-align: center;
}

/* Êï∞Â≠óËæìÂÖ•Ê°ÜÂåÖË£ÖÂô® */
.number-input-wrapper {
  display: flex;
  align-items: stretch;
  position: relative;
  flex: 1;
  min-width: 0;
  border-radius: 3px;
  overflow: hidden;
}

.position-input-field {
  max-width: 60px;
  text-align: center;
  flex: 1;
  border-radius: 0; /* ÁßªÈô§ÂúÜËßíÔºåÁî±ÂåÖË£ÖÂô®ÊéßÂà∂ */
  border-right: none; /* ÁßªÈô§Âè≥ËæπÊ°ÜÔºå‰∏éÊåâÈíÆËøûÊé• */
}

/* ÈöêËóèÈªòËÆ§ÁöÑÊï∞Â≠óËæìÂÖ•Ê°Ü‰∏ä‰∏ãÁÆ≠Â§¥ */
.position-input-field::-webkit-outer-spin-button,
.position-input-field::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.position-input-field[type='number'] {
  -moz-appearance: textfield;
}

/* Ëá™ÂÆö‰πâÊï∞Â≠óÊéßÂà∂ÊåâÈíÆ */
.number-controls {
  display: flex;
  flex-direction: column;
  width: 18px;
  flex-shrink: 0;
}

.number-btn {
  background: #555;
  border: 1px solid #666;
  border-left: none;
  color: #fff;
  cursor: pointer;
  font-size: 8px;
  line-height: 1;
  padding: 0;
  width: 100%;
  height: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s;
  flex: 1;
}

.number-btn:hover {
  background: #666;
}

.number-btn:active {
  background: #777;
}

.number-btn-up {
  border-radius: 0;
  border-bottom: 0.5px solid #444;
}

.number-btn-down {
  border-radius: 0;
  border-top: 0.5px solid #444;
}

/* Â§çÈÄâÊ°ÜÊ†∑Âºè */
.checkbox-input {
  width: 16px;
  height: 16px;
  accent-color: #ffffff;
  cursor: pointer;
}

/* Áº©ÊîæËæìÂÖ•Ê°ÜÊ†∑Âºè */
.scale-input-box {
  background: #444;
  border: 1px solid #666;
  border-radius: 0; /* ÁßªÈô§ÂúÜËßíÔºåÁî±ÂåÖË£ÖÂô®ÊéßÂà∂ */
  border-right: none; /* ÁßªÈô§Âè≥ËæπÊ°ÜÔºå‰∏éÊåâÈíÆËøûÊé• */
  color: #fff;
  font-size: 11px;
  padding: 2px 4px;
  width: 60px; /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
  text-align: center;
  flex: 0 0 auto;
}

.scale-input-box:focus {
  outline: none;
  border-color: #4caf50;
}

/* ÈöêËóèÊâÄÊúâÊï∞Â≠óËæìÂÖ•Ê°ÜÁöÑÈªòËÆ§ÁÆ≠Â§¥ */
.scale-input-box::-webkit-outer-spin-button,
.scale-input-box::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.scale-input-box[type='number'] {
  -moz-appearance: textfield;
}

.scale-controls,
.rotation-controls,
.opacity-controls {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
}

/* ËÆ©Êï∞Â≠óËæìÂÖ•Ê°ÜÂåÖË£ÖÂô®Âú®Ëøô‰∫õÊéß‰ª∂‰∏≠‰øùÊåÅÂõ∫ÂÆöÂÆΩÂ∫¶ÔºåÊªëÊùÜÂç†Êª°Ââ©‰ΩôÁ©∫Èó¥ */
.scale-controls .number-input-wrapper,
.rotation-controls .number-input-wrapper,
.opacity-controls .number-input-wrapper {
  flex: 0 0 auto;
  width: 80px; /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
}

.scale-slider,
.rotation-slider,
.opacity-slider {
  flex: 1;
  height: 4px;
  background: #444;
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
}

.scale-slider::-webkit-slider-thumb,
.rotation-slider::-webkit-slider-thumb,
.opacity-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  background: #2196f3;
  border-radius: 50%;
  cursor: pointer;
}

.scale-slider::-moz-range-thumb,
.rotation-slider::-moz-range-thumb,
.opacity-slider::-moz-range-thumb {
  width: 12px;
  height: 12px;
  background: #2196f3;
  border-radius: 50%;
  cursor: pointer;
  border: none;
}

.scale-value,
.rotation-value,
.opacity-value {
  font-size: 11px;
  color: #fff;
  min-width: 40px;
  text-align: right;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.action-btn {
  background: #555;
  border: none;
  border-radius: 4px;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 12px;
  transition: background-color 0.2s;
}

.action-btn:hover {
  background: #666;
}

.action-btn.danger {
  background: #f44336;
}

.action-btn.danger:hover {
  background: #d32f2f;
}

/* ÂàÜËæ®ÁéáÊéß‰ª∂Ê†∑Âºè */
.resolution-controls {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.resolution-inputs {
  display: flex;
  align-items: center;
  gap: 8px;
}

.resolution-input-group {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 2px;
}

.resolution-input-group .resolution-label {
  font-size: 12px;
  color: #ccc;
  margin: 0;
  min-width: 20px !important;
  text-align: left;
}

.resolution-input {
  background: #444;
  border: 1px solid #666;
  border-radius: 4px;
  color: #fff;
  font-size: 11px;
  padding: 4px 6px;
  width: 60px;
  text-align: center;
}

.resolution-input:focus {
  outline: none;
  border-color: #4caf50;
}

.resolution-input::-webkit-outer-spin-button,
.resolution-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.resolution-input[type='number'] {
  -moz-appearance: textfield;
}

.resolution-separator {
  font-size: 14px;
  color: #ccc;
  font-weight: bold;
  margin: 0 4px;
}

/* Ë∞ÉËØïÊåâÈíÆÊ†∑Âºè */
.debug-button {
  width: 100%;
  padding: 8px 12px;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
}

.debug-button:hover {
  background: linear-gradient(135deg, #ff5252, #e55100);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
}

.debug-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
}

/* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #1a1a1a;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 4px;
  border: 1px solid #333;
}

::-webkit-scrollbar-thumb:hover {
  background: #666;
}

::-webkit-scrollbar-corner {
  background: #1a1a1a;
}

/* ÂØπÈΩêÊéßÂà∂Ê†∑Âºè */
.alignment-controls {
  display: flex;
  gap: 4px;
  flex: 1;
}

.align-btn {
  background: #555;
  border: 1px solid #666;
  border-radius: 4px;
  color: #ccc;
  padding: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex: 1;
  min-width: 28px;
  height: 24px;
}

.align-btn:hover {
  background: #666;
  color: #fff;
  border-color: #777;
}

.align-btn:active {
  background: #777;
  transform: translateY(1px);
}

.align-btn svg {
  width: 14px;
  height: 14px;
}
</style>
