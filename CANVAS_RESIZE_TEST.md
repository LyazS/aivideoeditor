# 画布尺寸变更功能测试指南

## 功能概述

现在已经实现了当用户手动更改视频分辨率时，自动销毁旧画布并重新创建新画布，同时迁移现有内容的功能。

## 实现的功能

### 1. 画布自动重新创建
- 当用户在分辨率设置面板中更改分辨率时，系统会自动：
  1. 检测分辨率变化
  2. 备份当前画布中的所有内容（sprites、播放状态、当前时间）
  3. 销毁旧画布
  4. 创建新的画布（使用新的尺寸）
  5. 恢复所有备份的内容到新画布

### 2. 内容迁移
- **Sprites恢复**: 所有时间轴上的视频片段会被重新创建并添加到新画布
- **时间范围保持**: 每个sprite的时间范围设置会被完整保留
- **变换属性保持**: 位置、尺寸、透明度、层级等属性会被保留
- **播放状态恢复**: 如果之前在播放，会恢复播放状态；否则跳转到之前的时间位置

## 测试步骤

### 准备工作
1. 启动开发服务器：`npm run dev`
2. 在浏览器中打开应用
3. 导入一些视频文件到素材库
4. 将视频拖拽到时间轴上

### 测试场景1：基本分辨率变更
1. 确保时间轴上有几个视频片段
2. 点击预览窗口下方的分辨率按钮（显示当前比例，如"16:9"）
3. 在弹出的分辨率选择器中选择不同的预设分辨率（如从1080p改为720p）
4. 点击"确认"
5. **预期结果**：
   - 画布尺寸应该立即更新为新的分辨率
   - 所有时间轴上的视频片段应该仍然存在
   - 播放功能应该正常工作
   - 控制台应该显示画布重新创建的日志

### 测试场景2：自定义分辨率
1. 点击分辨率按钮
2. 选择"自定义"选项
3. 输入自定义的宽度和高度（如1280x800）
4. 点击"确认"
5. **预期结果**：同场景1

### 测试场景3：播放状态保持
1. 开始播放视频
2. 在播放过程中更改分辨率
3. **预期结果**：
   - 画布重新创建后应该继续播放
   - 播放位置应该保持在变更前的时间点

### 测试场景4：暂停状态保持
1. 暂停播放并跳转到某个特定时间点
2. 更改分辨率
3. **预期结果**：
   - 画布重新创建后应该保持暂停状态
   - 时间位置应该保持在变更前的位置

## 错误处理

### 备用方案
如果画布重新创建失败，系统会尝试使用简单的初始化作为备用方案，确保用户不会完全失去画布功能。

### 日志监控
在浏览器开发者工具的控制台中，可以看到详细的日志信息：
- `开始销毁画布并备份内容...`
- `备份了 X 个sprites`
- `画布销毁完成`
- `开始重新创建画布...`
- `恢复sprite成功: [sprite_id]`
- `画布重新创建完成`

## 技术实现细节

### 关键文件
- `frontend/src/composables/useWebAVControls.ts`: 画布管理逻辑
- `frontend/src/components/WebAVRenderer.vue`: 分辨率变化监听
- `frontend/src/stores/videostore.ts`: 状态管理和sprite更新

### 关键方法
- `destroyCanvas()`: 销毁画布并备份内容
- `recreateCanvas()`: 重新创建画布并恢复内容
- `updateTimelineItemSprite()`: 更新时间轴项目的sprite引用

## 已知限制

1. **性能考虑**: 如果时间轴上有大量视频片段，重新创建过程可能需要一些时间
2. **内存使用**: 在重新创建过程中，会临时占用额外的内存来存储备份数据
3. **复杂变换**: 非常复杂的变换或动画可能在迁移过程中丢失部分细节

## 故障排除

如果遇到问题：
1. 检查浏览器控制台是否有错误信息
2. 确认WebAV库版本兼容性
3. 尝试刷新页面重新开始
4. 检查是否有足够的内存和CPU资源

## 后续改进

可能的改进方向：
1. 添加进度指示器显示重新创建进度
2. 优化大量sprite的迁移性能
3. 添加更详细的错误恢复机制
4. 支持更复杂的变换属性迁移
