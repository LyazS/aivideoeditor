# 媒体类型统一设计方案

## 概述

当前项目中存在 `LocalMediaItem` 和 `AsyncProcessingMediaItem` 两套并行的媒体类型系统，导致架构复杂、代码重复、维护困难。本方案提出统一媒体类型的设计思路，将"本地"和"异步"从**类型区分**改为**状态区分**。

## 当前问题分析

### 1. 概念模型混乱
```typescript
// ❌ 当前设计：两种类型
LocalMediaItem vs AsyncProcessingMediaItem

// 问题：本质上都是"媒体项目"，不应该在类型层面区分
```

### 2. 架构复杂度过高
- 两套并行的类型系统
- 两套状态管理API
- 两套UI渲染逻辑
- 复杂的类型守卫和转换逻辑

### 3. 与WebAV设计冲突
WebAV是同步渲染库，假设所有素材都已准备好，但异步素材违背了这个假设。

## 统一设计方案

### 1. 核心思路

**重新理解"状态"vs"类型"**：
- "本地"和"异步"是**状态**，不是**类型**
- 统一为一种媒体类型，通过状态区分处理方式
- 属性分层：核心属性 + 状态相关属性 + 可选属性

### 2. 统一接口设计

```typescript
/**
 * 统一的媒体项目接口
 */
export interface MediaItem extends BaseMediaItem {
  // ==================== 核心属性（所有状态共有） ====================
  mediaType: MediaType | 'unknown'
  status: MediaStatus // 统一的状态管理
  
  // ==================== 数据源（联合类型） ====================
  source: LocalFileSource | RemoteSource
  
  // ==================== WebAV对象（状态相关） ====================
  clip?: {
    mp4Clip?: Raw<MP4Clip>
    imgClip?: Raw<ImgClip>
    audioClip?: Raw<AudioClip>
  }
  
  // ==================== 元数据（状态相关） ====================
  duration?: number // ready状态才有确切值
  thumbnailUrl?: string
  
  // ==================== 异步处理相关（可选） ====================
  asyncProcessing?: {
    type: AsyncProcessingType
    progress: number // 0-100
    expectedDuration: number
    config: AsyncProcessingConfig
    startedAt?: string
    completedAt?: string
    errorMessage?: string
    isConverting?: boolean
  }
}

// 数据源类型
type LocalFileSource = {
  type: 'local'
  file: File
  url: string
}

type RemoteSource = {
  type: 'remote'
  url: string
  // 其他远程源配置
}

// 统一的状态枚举
type MediaStatus = 
  | 'pending'      // 等待处理
  | 'asyncprocessing'  // 异步处理中
  | 'webavdecoding'   // WebAV解析中
  | 'ready'        // 就绪
  | 'error'        // 错误
  | 'cancelled'    // 取消
```
